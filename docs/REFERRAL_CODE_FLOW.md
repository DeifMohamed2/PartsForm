# Referral Code System - Complete Flow Documentation

## Overview

The PARTSFORM referral system allows partners to earn commissions when buyers they refer place orders. The key concept is that **referral codes are used at BUYER REGISTRATION, not at checkout**. Once a buyer signs up with a referral code, they are **permanently linked** to that partner, and all future orders generate commissions.

---

## ğŸ”„ Complete Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           REFERRAL CODE FLOW                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ADMIN CREATES   â”‚     â”‚  2. PARTNER SHARES  â”‚     â”‚  3. BUYER REGISTERS â”‚
â”‚     PARTNER         â”‚â”€â”€â”€â”€â–¶â”‚     REFERRAL CODE   â”‚â”€â”€â”€â”€â–¶â”‚     WITH CODE       â”‚
â”‚                     â”‚     â”‚                     â”‚     â”‚                     â”‚
â”‚  â€¢ Name/Email       â”‚     â”‚  "DEIMOH-52LEWU"    â”‚     â”‚  â€¢ Validates code   â”‚
â”‚  â€¢ Commission: 5%   â”‚     â”‚                     â”‚     â”‚  â€¢ Links to partner â”‚
â”‚  â€¢ Discount: 3%     â”‚     â”‚  Partner gets:      â”‚     â”‚  â€¢ Saves to account â”‚
â”‚                     â”‚     â”‚  â€¢ Unique code      â”‚     â”‚                     â”‚
â”‚  Auto-generates:    â”‚     â”‚  â€¢ Dashboard link   â”‚     â”‚  Buyer gets:        â”‚
â”‚  ReferralCode doc   â”‚     â”‚  â€¢ Share materials  â”‚     â”‚  â€¢ 3% discount on   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    ALL orders       â”‚
                                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  6. PAYOUT          â”‚     â”‚  5. COMMISSION      â”‚     â”‚  4. BUYER PLACES    â”‚â”‚
â”‚  â”‚     PROCESSING      â”‚â—€â”€â”€â”€â”€â”‚     CREATED         â”‚â—€â”€â”€â”€â”€â”‚     ORDER           â”‚â”‚
â”‚  â”‚                     â”‚     â”‚                     â”‚     â”‚                     â”‚â”‚
â”‚  â”‚  Admin pays         â”‚     â”‚  â€¢ Status: pending  â”‚     â”‚  Order: AED 1,000   â”‚â”‚
â”‚  â”‚  approved           â”‚     â”‚  â€¢ Auto-approved on â”‚     â”‚                     â”‚â”‚
â”‚  â”‚  commissions        â”‚     â”‚    order complete   â”‚     â”‚  Subtotal: 1,000    â”‚â”‚
â”‚  â”‚                     â”‚     â”‚  â€¢ Rate: 5%         â”‚     â”‚  Discount: -30 (3%) â”‚â”‚
â”‚  â”‚  Partner receives:  â”‚     â”‚  â€¢ Amount: AED 50   â”‚     â”‚  Total: AED 970     â”‚â”‚
â”‚  â”‚  AED 50             â”‚     â”‚                     â”‚     â”‚                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Step-by-Step Process

### Step 1: Admin Creates Referral Partner

**Location:** Admin Panel â†’ Referrals â†’ Partners â†’ Create New

When admin creates a partner:

1. **Partner Details Saved:**
   - Name, Email, Phone
   - Commission Rate (default: 5%)
   - Buyer Discount Rate (default: 3%)
   - Payment details (bank/PayPal)

2. **Auto-Generated ReferralCode:**
   ```javascript
   // Example: Partner "Deif Mohamed" gets code "DEIMOH-52LEWU"
   {
     code: "DEIMOH-52LEWU",
     name: "Default",
     commissionRate: 5,        // Partner earns 5% of order subtotal
     buyerDiscountRate: 3,     // Buyers get 3% off
     validFrom: Date.now(),
     validUntil: +1 month,     // Default validity
     status: "active",
     maxUses: null             // Unlimited (null or 0 = unlimited)
   }
   ```

### Step 2: Partner Shares Code

Partner shares their referral code `DEIMOH-52LEWU` with potential buyers through:
- Social media
- Email marketing
- Website
- Direct sharing

### Step 3: Buyer Registers with Referral Code

**Location:** Registration Page (`/register`)

**UI Flow:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REFERRAL CODE (Optional)               â”‚
â”‚  Have a referral code?                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ« DEIMOH-52LEWU       â”‚ âœ“ Verify â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ âœ… Valid! You'll get 3% discount â”‚   â”‚
â”‚  â”‚    on all orders (referred by    â”‚   â”‚
â”‚  â”‚    Deif Mohamed)                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Backend Process:**
1. **Validation API** (`POST /api/referral/validate-registration`):
   ```javascript
   // Request
   { code: "DEIMOH-52LEWU" }
   
   // Response
   {
     success: true,
     valid: true,
     referral: {
       code: "DEIMOH-52LEWU",
       codeId: "69910d4e505a9b7ebe776036",
       partnerId: "69910d4e505a9b7ebe776034",
       partnerName: "Deif Mohamed",
       discountRate: 3,
       commissionRate: 5
     }
   }
   ```

2. **Registration Saves Referral to Buyer Account:**
   ```javascript
   // Buyer document in MongoDB
   {
     firstName: "John",
     lastName: "Smith",
     email: "john@example.com",
     // ... other fields
     
     // PERMANENT referral link
     registrationReferral: {
       code: "DEIMOH-52LEWU",
       codeId: ObjectId("69910d4e505a9b7ebe776036"),
       partnerId: ObjectId("69910d4e505a9b7ebe776034"),
       partnerName: "Deif Mohamed",
       discountRate: 3,        // Locked at registration time
       commissionRate: 5,      // Locked at registration time
       registeredAt: new Date()
     }
   }
   ```

3. **Code Stats Updated:**
   ```javascript
   referralCode.stats.totalUses += 1;
   referralCode.stats.uniqueBuyers += 1;
   ```

### Step 4: Buyer Places Order

**When buyer creates an order, the system automatically:**

1. **Checks for Registration Referral:**
   ```javascript
   if (buyer.registrationReferral && buyer.registrationReferral.code) {
     // Verify partner is still active
     const partner = await ReferralPartner.findById(buyer.registrationReferral.partnerId);
     
     if (partner && partner.status === 'active') {
       // Calculate discount
       const discountRate = buyer.registrationReferral.discountRate; // 3%
       const discountAmount = orderSubtotal * (discountRate / 100);
       // AED 1,000 Ã— 3% = AED 30 discount
     }
   }
   ```

2. **Applies Discount to Order:**
   ```javascript
   // Order pricing calculation
   {
     subtotal: 1000,           // Sum of all items
     discount: 30,             // Referral discount (3%)
     processingFee: 0,
     total: 970                // subtotal - discount + fee
   }
   ```

3. **Saves Referral Info on Order:**
   ```javascript
   // Order document
   {
     orderNumber: "ORD-202602-0001",
     pricing: {
       subtotal: 1000,
       discount: 30,
       total: 970
     },
     referral: {
       referralCode: "DEIMOH-52LEWU",
       referralPartner: ObjectId("69910d4e505a9b7ebe776034"),
       discountRate: 3,
       discountAmount: 30,
       commissionRate: 5,
       commissionAmount: 50,    // 5% of 1000
       commissionStatus: "pending"
     }
   }
   ```

### Step 5: Commission Created

**Immediately after order creation:**

```javascript
// ReferralCommission document
{
  referralPartner: ObjectId("69910d4e505a9b7ebe776034"),
  order: ObjectId("order_id"),
  orderNumber: "ORD-202602-0001",
  buyer: ObjectId("buyer_id"),
  buyerEmail: "john@example.com",
  
  // Financial details
  orderSubtotal: 1000,
  orderTotal: 970,
  commissionRate: 5,
  commissionAmount: 50,        // AED 50 for partner
  buyerDiscountRate: 3,
  buyerDiscountAmount: 30,     // AED 30 saved by buyer
  
  // Status tracking
  status: "pending",           // pending â†’ approved â†’ paid
  orderStatus: "pending",
  
  // Period for reporting
  periodMonth: 2,              // February
  periodYear: 2026
}
```

**Commission Status Flow:**
```
pending â”€â”€â–¶ approved â”€â”€â–¶ paid
    â”‚           
    â””â”€â”€â–¶ rejected (if fraud detected)
    â”‚
    â””â”€â”€â–¶ cancelled (if order cancelled)
```

### Step 6: Commission Approval & Payout

1. **Auto-Approval:** When order status changes to `completed` or `delivered`:
   ```javascript
   commission.status = 'approved';
   ```

2. **Admin Creates Payout Batch:**
   - Groups all approved commissions for a partner
   - Creates payout record
   - Marks commissions as `paid` when payment sent

---

## ğŸ’° Financial Summary Example

**Scenario:** Buyer registers with code `DEIMOH-52LEWU` and places AED 1,000 order

| Item | Amount | Notes |
|------|--------|-------|
| Order Subtotal | AED 1,000 | Sum of all parts |
| Buyer Discount (3%) | -AED 30 | Saved by buyer |
| **Buyer Pays** | **AED 970** | Final amount |
| Partner Commission (5%) | AED 50 | Earned by partner |
| **PARTSFORM Revenue** | **AED 920** | After discount & commission |

---

## ğŸ” Validation Rules

A referral code is **VALID** when:
1. âœ… Code exists in database
2. âœ… Status is `active`
3. âœ… Current date is after `validFrom`
4. âœ… Current date is before `validUntil` (or `validUntil` is null)
5. âœ… Partner status is `active`
6. âœ… `maxUses` not reached (null or 0 = unlimited)

A code is **INVALID** when:
- âŒ Code doesn't exist
- âŒ Status is `inactive` or `expired`
- âŒ Code hasn't started yet (before `validFrom`)
- âŒ Code has expired (after `validUntil`)
- âŒ Partner is suspended/inactive
- âŒ Usage limit reached (only if `maxUses` > 0)

---

## ğŸ—„ï¸ Database Models Summary

### 1. ReferralPartner
Stores partner account information and overall stats.

### 2. ReferralCode
Individual codes with validity periods. Each partner can have multiple codes.

### 3. Buyer.registrationReferral
Embedded document linking buyer to their referral partner permanently.

### 4. Order.referral
Embedded document storing referral details for each order.

### 5. ReferralCommission
Tracks individual commissions for each referred order.

### 6. ReferralPayout
Batches approved commissions for payment processing.

---

## ğŸ§ª Testing the Flow

Run the test script:
```bash
node scripts/testReferralCode.js DEIMOH-52LEWU
```

Expected output:
```
âœ… Code is VALID and ready to use!
- isValid(): true
- hasReachedLimit(): false
- findValidCode(): FOUND
```

---

## â“ Common Issues & Fixes

### Issue: "Invalid or expired referral code"
**Causes:**
1. `maxUses` was set to 0 (now fixed - 0 means unlimited)
2. Code has expired (`validUntil` passed)
3. Partner is inactive

**Fix:** Check code in database:
```javascript
// MongoDB query
db.referralcodes.findOne({ code: "DEIMOH-52LEWU" })
```

### Issue: Discount not applied
**Causes:**
1. Buyer not registered with code (code must be used at signup)
2. Partner became inactive after registration

**Fix:** Check buyer's `registrationReferral` field.

### Issue: Commission not created
**Causes:**
1. Partner inactive when order placed
2. Commission already exists for order

**Fix:** Check `referralcommissions` collection.
