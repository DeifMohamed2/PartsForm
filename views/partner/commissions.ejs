<%- include('partials/header') %>
<% activePage = 'commissions'; %>
<%- include('partials/navbar') %>

<div class="partner-page-wrapper">
  <!-- Main Content -->
  <main class="partner-main">
    <div class="partner-container">
      <!-- Page Header -->
      <div class="partner-page-header">
        <div class="partner-page-title">
          <i data-lucide="coins"></i>
          <h1>My Commissions</h1>
        </div>
        <div class="partner-page-filters">
          <a href="?status=all" class="partner-filter-btn <%= !status || status === 'all' ? 'active' : '' %>">All</a>
          <a href="?status=pending" class="partner-filter-btn <%= status === 'pending' ? 'active' : '' %>">Pending</a>
          <a href="?status=approved" class="partner-filter-btn <%= status === 'approved' ? 'active' : '' %>">Approved</a>
          <a href="?status=paid" class="partner-filter-btn <%= status === 'paid' ? 'active' : '' %>">Paid</a>
        </div>
      </div>

      <!-- Summary Stats -->
      <div class="partner-stats-grid" style="margin-bottom: 2rem;">
        <div class="partner-stat-card">
          <div class="partner-stat-icon partner-stat-icon-primary">
            <i data-lucide="receipt"></i>
          </div>
          <div class="partner-stat-content">
            <div class="partner-stat-value"><%= stats?.totalReferrals || 0 %></div>
            <div class="partner-stat-label">Total Referrals</div>
          </div>
        </div>
        <div class="partner-stat-card">
          <div class="partner-stat-icon partner-stat-icon-warning">
            <i data-lucide="clock"></i>
          </div>
          <div class="partner-stat-content">
            <div class="partner-stat-value"><%= (stats?.pendingAmount || 0).toFixed(2) %> AED</div>
            <div class="partner-stat-label">Pending</div>
          </div>
        </div>
        <div class="partner-stat-card">
          <div class="partner-stat-icon partner-stat-icon-success">
            <i data-lucide="check-circle"></i>
          </div>
          <div class="partner-stat-content">
            <div class="partner-stat-value"><%= (stats?.approvedAmount || 0).toFixed(2) %> AED</div>
            <div class="partner-stat-label">Approved</div>
          </div>
        </div>
        <div class="partner-stat-card">
          <div class="partner-stat-icon partner-stat-icon-info">
            <i data-lucide="wallet"></i>
          </div>
          <div class="partner-stat-content">
            <div class="partner-stat-value"><%= (stats?.paidAmount || 0).toFixed(2) %> AED</div>
            <div class="partner-stat-label">Total Paid</div>
          </div>
        </div>
      </div>

      <!-- Commissions Table -->
      <div class="partner-card">
        <div class="partner-card-header">
          <div class="partner-card-title">
            <i data-lucide="list"></i>
            <span>Commission History</span>
          </div>
        </div>
        <div class="partner-table-wrapper">
          <% if (commissions && commissions.length > 0) { %>
          <table class="partner-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Order</th>
                <th>Buyer</th>
                <th>Order Amount</th>
                <th>Rate</th>
                <th>Commission</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <% commissions.forEach(function(commission) { %>
              <tr>
                <td>
                  <div class="partner-date-cell">
                    <span class="partner-date-day"><%= new Date(commission.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %></span>
                    <span class="partner-date-year"><%= new Date(commission.createdAt).getFullYear() %></span>
                  </div>
                </td>
                <td>
                  <span class="partner-order-number">#<%= commission.order?.orderNumber || 'N/A' %></span>
                </td>
                <td>
                  <div class="partner-user-cell">
                    <span class="partner-user-name"><%= commission.buyer?.firstName || '' %> <%= commission.buyer?.lastName || '' %></span>
                    <span class="partner-user-email"><%= commission.buyer?.email || '' %></span>
                  </div>
                </td>
                <td>
                  <span class="partner-amount"><%= (commission.orderAmount || 0).toFixed(2) %> AED</span>
                </td>
                <td>
                  <span class="partner-rate"><%= commission.commissionRate %>%</span>
                </td>
                <td>
                  <span class="partner-amount partner-text-success"><%= (commission.commissionAmount || 0).toFixed(2) %> AED</span>
                </td>
                <td>
                  <span class="partner-badge partner-badge-<%= commission.status === 'approved' ? 'success' : (commission.status === 'pending' ? 'warning' : (commission.status === 'paid' ? 'info' : 'danger')) %>">
                    <%= commission.status.charAt(0).toUpperCase() + commission.status.slice(1) %>
                  </span>
                </td>
              </tr>
              <% }); %>
            </tbody>
          </table>
          <% } else { %>
          <div class="partner-empty-state">
            <i data-lucide="inbox"></i>
            <h3>No Commissions Yet</h3>
            <p>When your referrals make purchases, your commissions will appear here.</p>
          </div>
          <% } %>
        </div>

        <!-- Pagination -->
        <% if (pagination && pagination.totalPages > 1) { %>
        <div class="partner-pagination">
          <% if (pagination.currentPage > 1) { %>
          <a href="?page=<%= pagination.currentPage - 1 %><%= status ? '&status=' + status : '' %>" class="partner-pagination-btn">
            <i data-lucide="chevron-left"></i>
          </a>
          <% } else { %>
          <span class="partner-pagination-btn disabled"><i data-lucide="chevron-left"></i></span>
          <% } %>

          <% for (let i = 1; i <= pagination.totalPages; i++) { %>
            <% if (i === pagination.currentPage) { %>
            <span class="partner-pagination-btn active"><%= i %></span>
            <% } else if (Math.abs(i - pagination.currentPage) < 3 || i === 1 || i === pagination.totalPages) { %>
            <a href="?page=<%= i %><%= status ? '&status=' + status : '' %>" class="partner-pagination-btn"><%= i %></a>
            <% } else if (Math.abs(i - pagination.currentPage) === 3) { %>
            <span class="partner-pagination-dots">...</span>
            <% } %>
          <% } %>

          <% if (pagination.currentPage < pagination.totalPages) { %>
          <a href="?page=<%= pagination.currentPage + 1 %><%= status ? '&status=' + status : '' %>" class="partner-pagination-btn">
            <i data-lucide="chevron-right"></i>
          </a>
          <% } else { %>
          <span class="partner-pagination-btn disabled"><i data-lucide="chevron-right"></i></span>
          <% } %>
        </div>
        <% } %>
      </div>

      <!-- How Commissions Work -->
      <div class="partner-info-box" style="margin-top: 2rem;">
        <i data-lucide="info"></i>
        <div class="partner-info-box-content">
          <h4>How Commissions Work</h4>
          <p>
            You earn <strong><%= partner.commissionRate %>%</strong> commission on every order placed by your referrals. 
            Commissions are calculated on the order total and are reviewed within 24-48 hours. 
            Once approved, they'll be included in your next monthly payout.
          </p>
        </div>
      </div>
    </div>
  </main>

  <%- include('partials/footer') %>
</div>