<%- include('partials/header') %>
<link rel="stylesheet" href="/css/adminCSS/admin-dashboard.css">
<link rel="stylesheet" href="/css/adminCSS/admin-aog.css">
</head>
<body class="module-aviation">
  <div class="admin-wrapper">
    <%- include('partials/sidebar', { activePage: 'aog', currentModule: 'aviation' }) %>
    
    <main class="admin-main">
      <%- include('partials/topbar', { pageTitle: 'AOG Cases', currentModule: 'aviation' }) %>
      
      <div class="admin-content">
        <!-- Aviation Module Banner -->
        <div class="module-info-banner">
          <div class="module-info-icon">
            <i data-lucide="alert-triangle"></i>
          </div>
          <div class="module-info-content">
            <div class="module-info-title">AOG (Aircraft On Ground) Cases</div>
            <div class="module-info-desc">Critical aircraft parts requiring immediate attention</div>
          </div>
          <div class="module-info-stats">
            <div class="module-info-stat">
              <div class="module-info-stat-value" style="color: #ef4444;"><%= aogCases.filter(c => c.priority === 'critical').length %></div>
              <div class="module-info-stat-label">Critical</div>
            </div>
            <div class="module-info-stat">
              <div class="module-info-stat-value"><%= aogCases.length %></div>
              <div class="module-info-stat-label">Total Cases</div>
            </div>
          </div>
        </div>

        <div class="page-header">
          <h2>Active AOG Cases</h2>
          <a href="/admin/aog/create" class="admin-btn admin-btn-primary">
            <i data-lucide="plus"></i>
            Create AOG Case
          </a>
        </div>

        <!-- Stats Row -->
        <div class="aog-stats-row">
          <div class="aog-stat-card">
            <div class="aog-stat-icon critical">
              <i data-lucide="alert-circle"></i>
            </div>
            <div class="aog-stat-content">
              <div class="stat-value"><%= aogCases.filter(c => c.priority === 'critical').length %></div>
              <div class="stat-label">Critical Priority</div>
            </div>
          </div>
          <div class="aog-stat-card">
            <div class="aog-stat-icon high">
              <i data-lucide="alert-triangle"></i>
            </div>
            <div class="aog-stat-content">
              <div class="stat-value"><%= aogCases.filter(c => c.priority === 'high').length %></div>
              <div class="stat-label">High Priority</div>
            </div>
          </div>
          <div class="aog-stat-card">
            <div class="aog-stat-icon transit">
              <i data-lucide="truck"></i>
            </div>
            <div class="aog-stat-content">
              <div class="stat-value"><%= aogCases.filter(c => c.status === 'shipped').length %></div>
              <div class="stat-label">In Transit</div>
            </div>
          </div>
          <div class="aog-stat-card">
            <div class="aog-stat-icon delivered">
              <i data-lucide="check-circle"></i>
            </div>
            <div class="aog-stat-content">
              <div class="stat-value"><%= aogCases.filter(c => c.status === 'delivered').length %></div>
              <div class="stat-label">Delivered Today</div>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="aog-filters">
          <div class="aog-search-bar">
            <button class="search-icon-btn" type="button">
              <i data-lucide="search"></i>
            </button>
            <input type="text" class="search-input" placeholder="Search by Case ID, Aircraft, or Customer..." id="aogSearch">
          </div>
          <select class="aog-filter-select" id="priorityFilter">
            <option value="">All Priorities</option>
            <option value="critical">Critical</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
          </select>
          <select class="aog-filter-select" id="statusFilter">
            <option value="">All Statuses</option>
            <option value="sourcing">Sourcing</option>
            <option value="quotes_received">Quotes Received</option>
            <option value="in_progress">In Progress</option>
            <option value="shipped">Shipped</option>
            <option value="delivered">Delivered</option>
          </select>
        </div>

        <!-- AOG Cases Table -->
        <div class="aog-table-container">
          <table class="aog-table">
            <thead>
              <tr>
                <th>Case ID</th>
                <th>Aircraft</th>
                <th>Part Number</th>
                <th>Customer</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Time Elapsed</th>
                <th>Time Remaining</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="aogTableBody">
              <% aogCases.forEach((aog, index) => { %>
              <tr class="priority-<%= aog.priority %>" data-created="<%= aog.createdTimestamp || Date.now() - (index * 3600000) %>" data-deadline="<%= aog.deadlineTimestamp || Date.now() + ((24 - index * 4) * 3600000) %>">
                <td>
                  <a href="/admin/aog/<%= aog.id %>" class="case-id-link">
                    <i data-lucide="external-link"></i>
                    <%= aog.id %>
                  </a>
                </td>
                <td>
                  <div class="aircraft-info">
                    <span class="aircraft-type"><%= aog.aircraft %></span>
                    <span class="aircraft-reg"><%= aog.registration %></span>
                  </div>
                </td>
                <td><%= aog.partNumber %></td>
                <td><%= aog.customer %></td>
                <td>
                  <span class="priority-badge <%= aog.priority %>">
                    <i data-lucide="<%= aog.priority === 'critical' ? 'alert-circle' : 'alert-triangle' %>"></i>
                    <%= aog.priority.toUpperCase() %>
                  </span>
                </td>
                <td>
                  <span class="status-badge <%= aog.status %>">
                    <%= aog.status.replace('_', ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') %>
                  </span>
                </td>
                <td class="timer-cell">
                  <div class="timer-elapsed">
                    <i data-lucide="clock"></i>
                    <span class="elapsed-time">00:00:00</span>
                  </div>
                </td>
                <td class="timer-cell">
                  <div class="timer-remaining ok">
                    <i data-lucide="hourglass"></i>
                    <span class="remaining-time">00:00:00</span>
                  </div>
                </td>
                <td>
                  <div class="aog-actions">
                    <a href="/admin/aog/<%= aog.id %>" class="aog-action-btn view" title="View Details">
                      <i data-lucide="eye"></i>
                    </a>
                    <a href="/admin/aog/<%= aog.id %>/edit" class="aog-action-btn edit" title="Edit Case">
                      <i data-lucide="edit-3"></i>
                    </a>
                  </div>
                </td>
              </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Update Status Modal -->
  <div class="modal-overlay" id="statusModal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <div class="modal-icon" style="background: rgba(14, 165, 233, 0.12); color: #0ea5e9;">
          <i data-lucide="refresh-cw"></i>
        </div>
        <div>
          <h3>Update Status</h3>
          <p id="statusModalCase">Case AOG-001</p>
        </div>
        <button class="modal-close" onclick="closeModal('statusModal')">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body" style="padding: 1.5rem;">
        <div class="form-group" style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--admin-text-secondary);">New Status</label>
          <select class="form-input" id="newStatus" style="width: 100%;">
            <option value="sourcing">Sourcing</option>
            <option value="quotes_received">Quotes Received</option>
            <option value="in_progress">In Progress</option>
            <option value="shipped">Shipped</option>
            <option value="delivered">Delivered</option>
            <option value="closed">Closed</option>
          </select>
        </div>
        <div class="form-group">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--admin-text-secondary);">Notes (Optional)</label>
          <textarea class="form-input" id="statusNotes" rows="3" placeholder="Add notes about this status change..." style="width: 100%; resize: vertical;"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="admin-btn admin-btn-secondary" onclick="closeModal('statusModal')">Cancel</button>
        <button class="admin-btn admin-btn-primary" onclick="saveStatus()">
          <i data-lucide="check"></i>
          Update Status
        </button>
      </div>
    </div>
  </div>

  <script>
    // Format time as HH:MM:SS
    function formatTime(ms) {
      if (ms < 0) ms = 0;
      var seconds = Math.floor((ms / 1000) % 60);
      var minutes = Math.floor((ms / (1000 * 60)) % 60);
      var hours = Math.floor(ms / (1000 * 60 * 60));
      return String(hours).padStart(2, '0') + ':' + 
             String(minutes).padStart(2, '0') + ':' + 
             String(seconds).padStart(2, '0');
    }

    // Update all timers
    function updateTimers() {
      var rows = document.querySelectorAll('#aogTableBody tr');
      var now = Date.now();
      
      rows.forEach(function(row) {
        var created = parseInt(row.dataset.created);
        var deadline = parseInt(row.dataset.deadline);
        
        // Elapsed time (since creation)
        var elapsed = now - created;
        var elapsedEl = row.querySelector('.elapsed-time');
        if (elapsedEl) {
          elapsedEl.textContent = formatTime(elapsed);
        }
        
        // Remaining time (until deadline)
        var remaining = deadline - now;
        var remainingEl = row.querySelector('.remaining-time');
        var remainingContainer = row.querySelector('.timer-remaining');
        if (remainingEl && remainingContainer) {
          remainingEl.textContent = formatTime(remaining);
          
          // Update color based on time remaining
          remainingContainer.classList.remove('ok', 'warning', 'critical');
          if (remaining < 2 * 60 * 60 * 1000) { // Less than 2 hours
            remainingContainer.classList.add('critical');
          } else if (remaining < 6 * 60 * 60 * 1000) { // Less than 6 hours
            remainingContainer.classList.add('warning');
          } else {
            remainingContainer.classList.add('ok');
          }
        }
      });
    }

    // Run timer updates every second
    setInterval(updateTimers, 1000);
    updateTimers();

    // Search and filter functionality
    document.getElementById('aogSearch').addEventListener('input', filterTable);
    document.getElementById('priorityFilter').addEventListener('change', filterTable);
    document.getElementById('statusFilter').addEventListener('change', filterTable);

    function filterTable() {
      var search = document.getElementById('aogSearch').value.toLowerCase();
      var priority = document.getElementById('priorityFilter').value;
      var status = document.getElementById('statusFilter').value;
      var rows = document.querySelectorAll('#aogTableBody tr');

      rows.forEach(function(row) {
        var text = row.textContent.toLowerCase();
        var rowPriority = row.classList.contains('priority-critical') ? 'critical' : 
                          row.classList.contains('priority-high') ? 'high' : 'medium';
        var statusBadge = row.querySelector('.status-badge');
        var rowStatus = statusBadge ? statusBadge.classList[1] : '';

        var matchSearch = text.includes(search);
        var matchPriority = !priority || rowPriority === priority;
        var matchStatus = !status || rowStatus === status;

        row.style.display = matchSearch && matchPriority && matchStatus ? '' : 'none';
      });
    }

    // Status update modal
    var currentCaseId = null;

    function updateStatus(caseId) {
      currentCaseId = caseId;
      document.getElementById('statusModalCase').textContent = 'Case ' + caseId;
      document.getElementById('statusModal').classList.add('active');
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function saveStatus() {
      var newStatus = document.getElementById('newStatus').value;
      var notes = document.getElementById('statusNotes').value;
      // In production, this would make an API call
      closeModal('statusModal');
      // Refresh or update the row
      alert('Status updated to: ' + newStatus + (notes ? '\nNotes: ' + notes : ''));
    }

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });
  </script>

<%- include('partials/footer') %>
