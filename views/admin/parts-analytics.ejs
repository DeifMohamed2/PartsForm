<%- include('partials/header') %>
<link rel="stylesheet" href="/css/adminCSS/admin-parts-analytics.css">
</head>
<body>
  <div class="admin-wrapper">
    <%- include('partials/sidebar', { activePage: 'parts-analytics' }) %>
    
    <main class="admin-main">
      <%- include('partials/topbar', { pageTitle: 'Parts Analytics' }) %>
      
      <div class="admin-content">
        
        <!-- Analytics Hero Section -->
        <div class="analytics-hero">
          <div class="analytics-hero-content">
            <div class="analytics-hero-left">
              <div class="analytics-hero-icon">
                <i data-lucide="bar-chart-3"></i>
              </div>
              <div>
                <h1 class="analytics-hero-title">
                  Parts Analytics
                  <span class="analytics-hero-badge">AI-Powered</span>
                </h1>
                <p class="analytics-hero-subtitle">Deep insights into parts demand, search patterns, and purchase behavior</p>
              </div>
            </div>
            <div class="analytics-hero-stats">
              <div class="analytics-hero-stat">
                <div class="analytics-hero-stat-value">--</div>
                <div class="analytics-hero-stat-label">Total Searches</div>
              </div>
              <div class="analytics-hero-stat">
                <div class="analytics-hero-stat-value">--</div>
                <div class="analytics-hero-stat-label">Parts Viewed</div>
              </div>
              <div class="analytics-hero-stat">
                <div class="analytics-hero-stat-value">--</div>
                <div class="analytics-hero-stat-label">Purchases</div>
              </div>
              <div class="analytics-hero-stat">
                <div class="analytics-hero-stat-value">--</div>
                <div class="analytics-hero-stat-label">Conversion Rate</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Quick Stats Grid -->
        <div class="analytics-quick-stats">
          <div style="grid-column: 1 / -1; text-align: center; padding: 1rem; color: var(--admin-text-muted);">
            <i data-lucide="loader" class="animate-spin" style="width: 24px; height: 24px;"></i>
            <span style="margin-left: 0.5rem;">Loading statistics...</span>
          </div>
        </div>
        
        <!-- Analytics Tabs Navigation -->
        <div class="analytics-tabs">
          <button class="analytics-tab active" onclick="switchAnalyticsTab('search-behavior')">
            <i data-lucide="search"></i>
            <span>Search Behavior</span>
          </button>
          <button class="analytics-tab" onclick="switchAnalyticsTab('purchase-patterns')">
            <i data-lucide="shopping-bag"></i>
            <span>Purchase Patterns</span>
          </button>
          <button class="analytics-tab" onclick="switchAnalyticsTab('demand-forecast')">
            <i data-lucide="trending-up"></i>
            <span>Demand Forecast</span>
          </button>
          <button class="analytics-tab" onclick="switchAnalyticsTab('ai-insights')">
            <i data-lucide="brain"></i>
            <span>AI Insights</span>
          </button>
          <button class="analytics-tab" onclick="switchAnalyticsTab('ai-assistant')">
            <i data-lucide="message-circle"></i>
            <span>AI Assistant</span>
          </button>
        </div>
        
        <!-- ============================================
             TAB 1: SEARCH BEHAVIOR
             ============================================ -->
        <div id="tab-search-behavior" class="analytics-panel active">
          
          <div class="search-analytics-grid">
            <!-- Most Searched Parts -->
            <div class="analytics-card">
              <div class="analytics-card-header">
                <div class="analytics-card-title">
                  <div class="analytics-card-title-icon">
                    <i data-lucide="search"></i>
                  </div>
                  <div>
                    <h3>Most Searched Parts</h3>
                    <p>Parts buyers are actively looking for</p>
                  </div>
                </div>
                <select style="padding: 0.5rem 1rem; border: 1px solid var(--admin-border); border-radius: 8px; background: var(--admin-bg-tertiary); font-size: 0.85rem;">
                  <option>Last 7 Days</option>
                  <option>Last 30 Days</option>
                  <option>Last 90 Days</option>
                </select>
              </div>
              <div class="analytics-card-body">
                <table class="searched-parts-table" id="mostSearchedTable">
                  <thead>
                    <tr>
                      <th>Part</th>
                      <th>Searches</th>
                      <th>Conversion</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="4" style="text-align: center; padding: 2rem; color: var(--admin-text-muted);">
                        <i data-lucide="loader" class="animate-spin" style="width: 32px; height: 32px;"></i>
                        <p style="margin-top: 0.5rem;">Loading search data...</p>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <div class="part-info">
                          <div class="part-icon transmission">
                            <i data-lucide="cog"></i>
                          </div>
                          <div>
                            <div class="part-name">Transmission Fluid ATF</div>
                            <div class="part-number">PN: TF-5678-ATF</div>
                          </div>
                        </div>
                      </td>
                      <td><span class="search-count"><i data-lucide="search"></i> 1,287</span></td>
                      <td><span class="conversion-rate medium">52%</span></td>
                      <td><span class="status-badge available">In Stock</span></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Missed Opportunities -->
            <div class="analytics-card">
              <div class="analytics-card-header">
                <div class="analytics-card-title">
                  <div class="analytics-card-title-icon" style="background: #ef4444;">
                    <i data-lucide="alert-triangle"></i>
                  </div>
                  <div>
                    <h3>Missed Opportunities</h3>
                    <p>Searched but not added to cart</p>
                  </div>
                </div>
              </div>
              <div class="analytics-card-body">
                <div class="missed-opportunities-list" id="missedOpportunitiesList">
                  <div style="text-align: center; padding: 2rem; color: var(--admin-text-muted);">
                    <i data-lucide="loader" class="animate-spin" style="width: 32px; height: 32px;"></i>
                    <p style="margin-top: 0.5rem;">Loading missed opportunities...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Search Trends Chart -->
          <div class="analytics-card" style="margin-bottom: 2rem;">
            <div class="analytics-card-header">
              <div class="analytics-card-title">
                <div class="analytics-card-title-icon" style="background: #8b5cf6;">
                  <i data-lucide="activity"></i>
                </div>
                <div>
                  <h3>Search Volume Trends</h3>
                  <p>Daily search patterns over the last 30 days</p>
                </div>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button class="admin-btn admin-btn-secondary" style="padding: 0.4rem 0.75rem; font-size: 0.8rem;">Week</button>
                <button class="admin-btn admin-btn-primary" style="padding: 0.4rem 0.75rem; font-size: 0.8rem;">Month</button>
                <button class="admin-btn admin-btn-secondary" style="padding: 0.4rem 0.75rem; font-size: 0.8rem;">Quarter</button>
              </div>
            </div>
            <div class="analytics-card-body">
              <div class="chart-wrapper">
                <canvas id="searchTrendsChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ============================================
             TAB 2: PURCHASE PATTERNS
             ============================================ -->
        <div id="tab-purchase-patterns" class="analytics-panel">
          
          <!-- Top Purchased Parts Grid -->
          <h3 style="font-size: 1.25rem; font-weight: 700; color: var(--admin-text-primary); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
            <i data-lucide="trophy" style="width: 24px; height: 24px; color: #f59e0b;"></i>
            Top Purchased Parts
          </h3>
          
          <div class="top-parts-grid" id="topPurchasedGrid">
            <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--admin-text-muted);">
              <i data-lucide="loader" class="animate-spin" style="width: 32px; height: 32px;"></i>
              <p style="margin-top: 0.5rem;">Loading top purchased parts...</p>
            </div>
          </div>
          
          <!-- Purchase Analytics Charts -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
            <div class="analytics-card">
              <div class="analytics-card-header">
                <div class="analytics-card-title">
                  <div class="analytics-card-title-icon" style="background: #10b981;">
                    <i data-lucide="pie-chart"></i>
                  </div>
                  <div>
                    <h3>Sales by Category</h3>
                    <p>Revenue distribution this month</p>
                  </div>
                </div>
              </div>
              <div class="analytics-card-body">
                <div class="chart-wrapper" style="height: 280px;">
                  <canvas id="categoryPieChart"></canvas>
                </div>
              </div>
            </div>
            
            <div class="analytics-card">
              <div class="analytics-card-header">
                <div class="analytics-card-title">
                  <div class="analytics-card-title-icon" style="background: #f59e0b;">
                    <i data-lucide="bar-chart-2"></i>
                  </div>
                  <div>
                    <h3>Purchase Frequency</h3>
                    <p>Orders per customer segment</p>
                  </div>
                </div>
              </div>
              <div class="analytics-card-body">
                <div class="chart-wrapper" style="height: 280px;">
                  <canvas id="purchaseFrequencyChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Repeat Purchase Analysis -->
          <div class="analytics-card">
            <div class="analytics-card-header">
              <div class="analytics-card-title">
                <div class="analytics-card-title-icon" style="background: #06b6d4;">
                  <i data-lucide="repeat"></i>
                </div>
                <div>
                  <h3>Top Purchased Parts Summary</h3>
                  <p>Parts with highest sales volume this month</p>
                </div>
              </div>
            </div>
            <div class="analytics-card-body">
              <div id="repeatPurchaseAnalysis" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                <div style="padding: 2rem; text-align: center; grid-column: 1 / -1; color: var(--admin-text-muted);">
                  <i data-lucide="loader" class="animate-spin" style="width: 32px; height: 32px;"></i>
                  <p style="margin-top: 0.5rem;">Loading purchase analysis...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ============================================
             TAB 3: DEMAND FORECAST
             ============================================ -->
        <div id="tab-demand-forecast" class="analytics-panel">
          
          <div class="predictions-grid">
            <!-- Main Forecast Chart -->
            <div class="prediction-chart-card">
              <div class="analytics-card-header">
                <div class="analytics-card-title">
                  <div class="analytics-card-title-icon" style="background: #3b82f6;">
                    <i data-lucide="trending-up"></i>
                  </div>
                  <div>
                    <h3>30-Day Order Trend</h3>
                    <p>Real-time demand based on actual purchase data</p>
                  </div>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                  <div style="display: flex; align-items: center; gap: 0.375rem;">
                    <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px;"></div>
                    <span style="font-size: 0.75rem; color: var(--admin-text-muted);">Historical</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.375rem;">
                    <div style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></div>
                    <span style="font-size: 0.75rem; color: var(--admin-text-muted);">Forecast</span>
                  </div>
                </div>
              </div>
              <div class="analytics-card-body">
                <div class="chart-wrapper" style="height: 350px;">
                  <canvas id="demandForecastChart"></canvas>
                </div>
              </div>
            </div>
            
            <!-- Forecast Metrics Sidebar -->
            <div class="prediction-sidebar">
              <div class="prediction-metric-card">
                <div class="prediction-metric-header">
                  <div class="prediction-metric-icon" style="background: rgba(16, 185, 129, 0.12); color: #10b981;">
                    <i data-lucide="trending-up"></i>
                  </div>
                  <div class="prediction-metric-title">Expected Orders</div>
                </div>
                <div class="prediction-metric-value">4,892</div>
                <div class="prediction-metric-change positive">
                  <i data-lucide="arrow-up"></i>
                  +18.5% vs last month
                </div>
              </div>
              
              <div class="prediction-metric-card">
                <div class="prediction-metric-header">
                  <div class="prediction-metric-icon" style="background: rgba(59, 130, 246, 0.12); color: #3b82f6;">
                    <i data-lucide="dollar-sign"></i>
                  </div>
                  <div class="prediction-metric-title">Projected Revenue</div>
                </div>
                <div class="prediction-metric-value">$1.24M</div>
                <div class="prediction-metric-change positive">
                  <i data-lucide="arrow-up"></i>
                  +12.3% growth
                </div>
              </div>
              
              <div class="prediction-metric-card">
                <div class="prediction-metric-header">
                  <div class="prediction-metric-icon" style="background: rgba(245, 158, 11, 0.12); color: #f59e0b;">
                    <i data-lucide="package"></i>
                  </div>
                  <div class="prediction-metric-title">Stock Needed</div>
                </div>
                <div class="prediction-metric-value">12,456</div>
                <div class="prediction-metric-change negative">
                  <i data-lucide="alert-circle"></i>
                  347 items low
                </div>
              </div>
              
              <div class="prediction-metric-card">
                <div class="prediction-metric-header">
                  <div class="prediction-metric-icon" style="background: rgba(139, 92, 246, 0.12); color: #8b5cf6;">
                    <i data-lucide="target"></i>
                  </div>
                  <div class="prediction-metric-title">Model Accuracy</div>
                </div>
                <div class="prediction-metric-value">94.2%</div>
                <div class="prediction-metric-change positive">
                  <i data-lucide="arrow-up"></i>
                  +2.1% improved
                </div>
              </div>
            </div>
          </div>
          
          <!-- High Demand Parts Forecast -->
          <div class="analytics-card" style="margin-top: 1.5rem;">
            <div class="analytics-card-header">
              <div class="analytics-card-title">
                  <div class="analytics-card-title-icon" style="background: #ef4444;">
                    <i data-lucide="flame"></i>
                  </div>
                <div>
                  <h3>High Demand Parts Forecast</h3>
                  <p>Parts predicted to have increased demand next 30 days</p>
                </div>
              </div>
            </div>
            <div class="analytics-card-body">
              <table class="searched-parts-table" id="demandForecastTable">
                <thead>
                  <tr>
                    <th>Part</th>
                    <th>Current Demand</th>
                    <th>7-Day Forecast</th>
                    <th>Recommendation</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="5" style="text-align: center; padding: 2rem; color: var(--admin-text-muted);">
                      <i data-lucide="loader" class="animate-spin" style="width: 32px; height: 32px;"></i>
                      <p style="margin-top: 0.5rem;">Loading demand forecast...</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- ============================================
             TAB 4: AI INSIGHTS
             ============================================ -->
        <div id="tab-ai-insights" class="analytics-panel">
          
          <div class="ai-insights-section">
            <!-- AI Insights Header -->
            <div class="ai-insights-header">
              <div class="ai-insights-header-content">
                <div class="ai-insights-header-left">
                  <div class="ai-insights-header-icon">
                    <i data-lucide="brain"></i>
                  </div>
                  <div>
                    <h2 class="ai-insights-header-title">AI-Powered Recommendations</h2>
                    <p class="ai-insights-header-subtitle">Actionable insights based on parts analytics and market trends</p>
                  </div>
                </div>
                <div class="ai-status-badge">
                  <span>Model Active â€¢ Last updated 5 min ago</span>
                </div>
              </div>
            </div>
            
            <!-- AI Recommendations Grid -->
            <div class="ai-recommendations-grid" id="aiRecommendationsGrid">
              <div class="ai-recommendation-card insight" style="grid-column: 1 / -1;">
                <div class="ai-recommendation-header">
                  <span class="ai-recommendation-type">Loading</span>
                  <div class="ai-recommendation-icon"><i data-lucide="loader" class="animate-spin"></i></div>
                </div>
                <div class="ai-recommendation-body">
                  <h4 class="ai-recommendation-title">Loading AI Insights...</h4>
                  <p class="ai-recommendation-description">AI is analyzing your data to generate insights and recommendations.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ============================================
             TAB 5: AI ASSISTANT
             ============================================ -->
        <div id="tab-ai-assistant" class="analytics-panel">
          
          <div class="ai-chat-section">
            <div class="ai-chat-header">
              <div class="ai-chat-header-left">
                <div class="ai-chat-avatar">
                  <i data-lucide="bot"></i>
                </div>
                <div>
                  <h3 class="ai-chat-title">Parts Analytics AI Assistant</h3>
                  <p class="ai-chat-subtitle">Ask me anything about your parts data, trends, and recommendations</p>
                </div>
              </div>
              <div class="ai-chat-status">
                <span>Online</span>
              </div>
            </div>
            
            <div class="ai-chat-messages" id="aiChatMessages">
              <!-- AI Welcome Message -->
              <div class="ai-chat-message assistant">
                <div class="ai-chat-message-avatar">
                  <i data-lucide="bot"></i>
                </div>
                <div class="ai-chat-message-content">
                  <p>ğŸ‘‹ Hello! I'm your Parts Analytics AI Assistant. I can help you understand:</p>
                  <ul style="margin: 0.75rem 0; padding-left: 1.25rem;">
                    <li>Which parts are trending and why</li>
                    <li>Demand forecasts and stock recommendations</li>
                    <li>Pricing optimization suggestions</li>
                    <li>Customer purchase patterns</li>
                    <li>Missed sales opportunities</li>
                  </ul>
                  <p>What would you like to know about your parts analytics?</p>
                  
                  <div class="ai-chat-suggestions">
                    <button class="ai-chat-suggestion" onclick="askAI('What are the top trending parts this week?')">Top trending parts</button>
                    <button class="ai-chat-suggestion" onclick="askAI('Show me missed sales opportunities')">Missed opportunities</button>
                    <button class="ai-chat-suggestion" onclick="askAI('What parts should I restock?')">Restock suggestions</button>
                    <button class="ai-chat-suggestion" onclick="askAI('Analyze brake pads demand')">Brake pads analysis</button>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="ai-chat-input-wrapper">
              <div class="ai-chat-input-container">
                <input type="text" class="ai-chat-input" id="aiChatInput" placeholder="Ask about parts, trends, recommendations..." onkeypress="handleChatKeypress(event)">
                <button class="ai-chat-send-btn" onclick="sendAIMessage()">
                  <i data-lucide="send"></i>
                </button>
              </div>
            </div>
          </div>
          
        </div>
        
      </div>
    </main>
  </div>

  <!-- Chart.js Scripts -->
  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GLOBAL STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let analyticsData = {
      dashboard: {},
      mostSearched: [],
      topPurchased: [],
      missedOpportunities: [],
      trending: [],
      searchTrends: [],
      categories: [],
      purchaseFrequency: [],
      excelAnalytics: {},
      demandForecast: {},
      aiInsights: {}
    };
    let currentPeriod = 30; // days
    let isLoading = false;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function fetchAnalyticsData(days = 30) {
      try {
        isLoading = true;
        showLoadingState();
        
        const response = await fetch(`/admin/api/analytics/comprehensive?days=${days}`);
        const result = await response.json();
        
        if (result.success) {
          analyticsData = result.data;
          renderAllData();
        } else {
          console.error('Failed to fetch analytics:', result.error);
          showErrorState('Failed to load analytics data');
        }
      } catch (error) {
        console.error('Error fetching analytics:', error);
        showErrorState('Connection error. Please try again.');
      } finally {
        isLoading = false;
        hideLoadingState();
      }
    }

    async function fetchAIInsights() {
      try {
        const response = await fetch(`/admin/api/analytics/ai-insights?days=${currentPeriod}`);
        const result = await response.json();
        if (result.success) {
          analyticsData.aiInsights = result.data;
          renderAIInsights();
        }
      } catch (error) {
        console.error('Error fetching AI insights:', error);
      }
    }

    async function fetchDemandForecast() {
      try {
        const response = await fetch(`/admin/api/analytics/demand-forecast?days=${currentPeriod}`);
        const result = await response.json();
        if (result.success) {
          analyticsData.demandForecast = result.data;
          renderDemandForecast();
        }
      } catch (error) {
        console.error('Error fetching demand forecast:', error);
      }
    }

    async function syncHistoricalData() {
      try {
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader" class="animate-spin"></i> Syncing...';
        
        const response = await fetch('/admin/api/analytics/sync-historical', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ days: 365 })
        });
        const result = await response.json();
        
        if (result.success) {
          alert(`Successfully synced ${result.data.processed} orders to analytics!`);
          fetchAnalyticsData(currentPeriod);
        }
        
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="refresh-cw"></i> Sync Data';
        lucide.createIcons();
      } catch (error) {
        console.error('Error syncing:', error);
        alert('Sync failed. Please try again.');
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function renderAllData() {
      renderDashboardStats();
      renderQuickStats();
      renderMostSearched();
      renderMissedOpportunities();
      renderTopPurchased();
      renderPurchaseAnalysis();
      renderAIInsights();
      
      // Reinitialize icons
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    }

    function renderDashboardStats() {
      const d = analyticsData.dashboard || {};
      
      // Hero stats
      const heroStats = document.querySelector('.analytics-hero-stats');
      if (heroStats) {
        heroStats.innerHTML = `
          <div class="analytics-hero-stat">
            <div class="analytics-hero-stat-value">${formatNumber(d.totalSearches || 0)}</div>
            <div class="analytics-hero-stat-label">Total Searches</div>
          </div>
          <div class="analytics-hero-stat">
            <div class="analytics-hero-stat-value">${formatNumber(d.partsViewed || 0)}</div>
            <div class="analytics-hero-stat-label">Parts Viewed</div>
          </div>
          <div class="analytics-hero-stat">
            <div class="analytics-hero-stat-value">${formatNumber(d.purchases || 0)}</div>
            <div class="analytics-hero-stat-label">Purchases</div>
          </div>
          <div class="analytics-hero-stat">
            <div class="analytics-hero-stat-value">${d.conversionRate || 0}%</div>
            <div class="analytics-hero-stat-label">Conversion Rate</div>
          </div>
        `;
      }
    }

    function renderQuickStats() {
      const d = analyticsData.dashboard || {};
      
      const statsContainer = document.querySelector('.analytics-quick-stats');
      if (statsContainer) {
        statsContainer.innerHTML = `
          <div class="quick-stat-card blue">
            <div class="quick-stat-header">
              <div class="quick-stat-icon"><i data-lucide="search"></i></div>
              <div class="quick-stat-change ${d.searchesChange >= 0 ? 'positive' : 'negative'}">
                <i data-lucide="${d.searchesChange >= 0 ? 'trending-up' : 'trending-down'}"></i>
                ${d.searchesChange >= 0 ? '+' : ''}${d.searchesChange || 0}%
              </div>
            </div>
            <div class="quick-stat-value">${formatNumber(d.totalSearches || 0)}</div>
            <div class="quick-stat-label">Total Searches This Month</div>
          </div>
          
          <div class="quick-stat-card green">
            <div class="quick-stat-header">
              <div class="quick-stat-icon"><i data-lucide="shopping-cart"></i></div>
              <div class="quick-stat-change ${d.purchasesChange >= 0 ? 'positive' : 'negative'}">
                <i data-lucide="${d.purchasesChange >= 0 ? 'trending-up' : 'trending-down'}"></i>
                ${d.purchasesChange >= 0 ? '+' : ''}${d.purchasesChange || 0}%
              </div>
            </div>
            <div class="quick-stat-value">${formatNumber(d.purchases || 0)}</div>
            <div class="quick-stat-label">Parts Purchased</div>
          </div>
          
          <div class="quick-stat-card purple">
            <div class="quick-stat-header">
              <div class="quick-stat-icon"><i data-lucide="eye-off"></i></div>
              <div class="quick-stat-change negative">
                <i data-lucide="alert-circle"></i>
              </div>
            </div>
            <div class="quick-stat-value">${formatNumber(d.searchedNotBought || 0)}</div>
            <div class="quick-stat-label">Searched Not Bought</div>
          </div>
          
          <div class="quick-stat-card amber">
            <div class="quick-stat-header">
              <div class="quick-stat-icon"><i data-lucide="alert-circle"></i></div>
              <div class="quick-stat-change ${d.missedChange <= 0 ? 'positive' : 'negative'}">
                <i data-lucide="${d.missedChange <= 0 ? 'trending-down' : 'trending-up'}"></i>
                ${d.missedChange >= 0 ? '+' : ''}${d.missedChange || 0}%
              </div>
            </div>
            <div class="quick-stat-value">${formatNumber(d.missedOpportunities || 0)}</div>
            <div class="quick-stat-label">Missing Parts Requests</div>
          </div>
          
          <div class="quick-stat-card cyan">
            <div class="quick-stat-header">
              <div class="quick-stat-icon"><i data-lucide="flame"></i></div>
              <div class="quick-stat-change positive">
                <i data-lucide="trending-up"></i>
              </div>
            </div>
            <div class="quick-stat-value">${formatNumber(d.trendingParts || 0)}</div>
            <div class="quick-stat-label">Trending Parts</div>
          </div>
        `;
      }
    }

    function renderMostSearched() {
      const parts = analyticsData.mostSearched || [];
      const tbody = document.querySelector('#mostSearchedTable tbody');
      if (!tbody) return;

      if (parts.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; padding: 2rem; color: var(--admin-text-muted);">
              <i data-lucide="search" style="width: 48px; height: 48px; opacity: 0.3;"></i>
              <p style="margin-top: 1rem;">No search data yet. Searches will appear here as users search for parts.</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = parts.map(part => `
        <tr>
          <td>
            <div class="part-info">
              <div class="part-icon ${getCategoryClass(part.category)}">
                <i data-lucide="${getCategoryIcon(part.category)}"></i>
              </div>
              <div>
                <div class="part-name">${escapeHtml(part.description || part.partNumber)}</div>
                <div class="part-number">PN: ${escapeHtml(part.partNumber)}</div>
              </div>
            </div>
          </td>
          <td><span class="search-count"><i data-lucide="search"></i> ${formatNumber(part.searches)}</span></td>
          <td><span class="conversion-rate ${getConversionClass(part.conversion)}">${part.conversion}%</span></td>
          <td><span class="status-badge ${getStockStatusClass(part.status)}">${getStockStatusText(part.status)}</span></td>
        </tr>
      `).join('');
    }

    function renderMissedOpportunities() {
      const missed = analyticsData.missedOpportunities || [];
      const container = document.querySelector('#missedOpportunitiesList');
      if (!container) return;

      if (missed.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: var(--admin-text-muted);">
            <i data-lucide="check-circle" style="width: 48px; height: 48px; opacity: 0.3; color: #10b981;"></i>
            <p style="margin-top: 1rem;">Great! No significant missed opportunities detected.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = missed.map(item => `
        <div class="missed-opportunity-item">
          <div class="missed-opportunity-icon">
            <i data-lucide="x-circle"></i>
          </div>
          <div class="missed-opportunity-content">
            <div class="missed-opportunity-name">${escapeHtml(item.partNumber)}</div>
            <div class="missed-opportunity-meta">${escapeHtml(item.reason)} ${item.isExcelSearch ? 'â€¢ Excel Import' : ''}</div>
          </div>
          <div class="missed-opportunity-value">
            <div class="missed-opportunity-searches">${formatNumber(item.searches)}</div>
            <div class="missed-opportunity-label">searches</div>
          </div>
        </div>
      `).join('');
    }

    function renderTopPurchased() {
      const parts = analyticsData.topPurchased || [];
      const container = document.querySelector('#topPurchasedGrid');
      if (!container) return;

      if (parts.length === 0) {
        container.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--admin-text-muted);">
            <i data-lucide="shopping-bag" style="width: 48px; height: 48px; opacity: 0.3;"></i>
            <p style="margin-top: 1rem;">No purchase data yet. Purchases will appear here.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = parts.slice(0, 4).map((part, index) => {
        const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : 'default';
        // Use part number as the main display, with description below
        const displayName = part.partNumber || 'Unknown Part';
        const displayDesc = part.description && part.description !== part.partNumber ? part.description : '';
        return `
          <div class="top-part-card">
            <div class="top-part-rank ${rankClass}">${index + 1}</div>
            <div class="top-part-icon" style="background: ${getCategoryBg(part.category)}; color: ${getCategoryColor(part.category)};">
              <i data-lucide="${getCategoryIcon(part.category)}"></i>
            </div>
            <div class="top-part-name" title="${escapeHtml(displayName)}">${escapeHtml(displayName)}</div>
            ${displayDesc ? `<div class="top-part-desc" style="font-size: 0.75rem; color: var(--admin-text-muted); margin-top: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${escapeHtml(displayDesc)}">${escapeHtml(displayDesc)}</div>` : ''}
            <div class="top-part-category">${escapeHtml(part.brand || part.category || 'General')}</div>
            <div class="top-part-stats">
              <div class="top-part-stat">
                <div class="top-part-stat-value">${formatNumber(part.orders)}</div>
                <div class="top-part-stat-label">Orders</div>
              </div>
              <div class="top-part-stat">
                <div class="top-part-stat-value">${formatCurrency(part.revenue)}</div>
                <div class="top-part-stat-label">Revenue</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderPurchaseAnalysis() {
      const parts = analyticsData.topPurchased || [];
      const container = document.getElementById('repeatPurchaseAnalysis');
      if (!container) return;
      
      // Get top 3 purchased parts from the data
      const topParts = parts.slice(0, 3);
      
      if (topParts.length === 0) {
        container.innerHTML = `
          <div style="padding: 2rem; text-align: center; grid-column: 1 / -1; color: var(--admin-text-muted);">
            <i data-lucide="shopping-bag" style="width: 48px; height: 48px; opacity: 0.3;"></i>
            <p style="margin-top: 0.5rem;">No purchase data available yet</p>
          </div>
        `;
        return;
      }
      
      const colors = ['#3b82f6', '#10b981', '#8b5cf6'];
      
      // Calculate total orders for percentage calculation
      const totalOrders = parts.reduce((sum, p) => sum + (p.orders || 0), 0);
      
      container.innerHTML = topParts.map((part, index) => {
        const percentage = totalOrders > 0 ? Math.round((part.orders / totalOrders) * 100) : 0;
        const displayName = part.partNumber || 'Unknown';
        const displayDesc = part.description && part.description !== part.partNumber 
          ? part.description.substring(0, 25) + (part.description.length > 25 ? '...' : '')
          : part.brand || 'Part';
        
        return `
          <div style="padding: 1.5rem; background: var(--admin-bg-tertiary); border-radius: 16px; text-align: center;">
            <div style="font-size: 2rem; font-weight: 800; color: ${colors[index]};">${part.orders}</div>
            <div style="font-size: 0.85rem; color: var(--admin-text-primary); margin-top: 0.5rem; font-weight: 600;" title="${part.partNumber}">${displayName}</div>
            <div style="font-size: 0.75rem; color: var(--admin-text-muted); margin-top: 0.25rem;">${displayDesc}</div>
            <div style="font-size: 0.7rem; color: ${colors[index]}; margin-top: 0.5rem; font-weight: 600;">
              ${formatCurrency(part.revenue)} revenue
            </div>
            <div style="font-size: 0.65rem; color: var(--admin-text-secondary); margin-top: 0.25rem;">${percentage}% of orders</div>
          </div>
        `;
      }).join('');
    }

    function renderAIInsights() {
      const insights = analyticsData.aiInsights || {};
      const container = document.querySelector('#aiRecommendationsGrid');
      if (!container) return;

      const recommendations = insights.recommendations || [];
      const keyInsights = insights.keyInsights || [];

      if (keyInsights.length === 0 && recommendations.length === 0) {
        container.innerHTML = `
          <div class="ai-recommendation-card insight" style="grid-column: 1 / -1;">
            <div class="ai-recommendation-header">
              <span class="ai-recommendation-type">Getting Started</span>
              <div class="ai-recommendation-icon"><i data-lucide="info"></i></div>
            </div>
            <div class="ai-recommendation-body">
              <h4 class="ai-recommendation-title">Building Intelligence</h4>
              <p class="ai-recommendation-description">AI insights will appear as more data is collected. Keep using the system and check back soon!</p>
              <button class="ai-recommendation-action" onclick="syncHistoricalData()">
                <i data-lucide="refresh-cw"></i>
                Sync Historical Data
              </button>
            </div>
          </div>
        `;
        return;
      }

      let html = '';
      
      keyInsights.forEach(insight => {
        const cardType = insight.type === 'success' ? 'opportunity' : 
                        insight.type === 'warning' ? 'warning' : 'insight';
        html += `
          <div class="ai-recommendation-card ${cardType}">
            <div class="ai-recommendation-header">
              <span class="ai-recommendation-type">${escapeHtml(insight.type || 'Insight')}</span>
              <div class="ai-recommendation-icon"><i data-lucide="${insight.icon || 'lightbulb'}"></i></div>
            </div>
            <div class="ai-recommendation-body">
              <h4 class="ai-recommendation-title">${escapeHtml(insight.title)}</h4>
              <p class="ai-recommendation-description">${escapeHtml(insight.description)}</p>
            </div>
          </div>
        `;
      });

      recommendations.forEach(rec => {
        const cardType = rec.priority === 'high' ? 'warning' : 'opportunity';
        html += `
          <div class="ai-recommendation-card ${cardType}">
            <div class="ai-recommendation-header">
              <span class="ai-recommendation-type">${rec.priority} Priority</span>
              <div class="ai-recommendation-icon"><i data-lucide="target"></i></div>
            </div>
            <div class="ai-recommendation-body">
              <h4 class="ai-recommendation-title">${escapeHtml(rec.action)}</h4>
              <p class="ai-recommendation-description">${escapeHtml(rec.description)}</p>
              <div class="ai-recommendation-impact">
                <span class="ai-recommendation-impact-label">Impact</span>
                <span class="ai-recommendation-impact-value">${escapeHtml(rec.impact)}</span>
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function renderDemandForecast() {
      const forecast = analyticsData.demandForecast || {};
      const forecasts = forecast.forecasts || [];
      const summary = forecast.summary || {};
      
      // Update sidebar metrics with real data
      updateDemandForecastSidebar(forecast);
      
      const tbody = document.querySelector('#demandForecastTable tbody');
      if (!tbody) return;

      if (forecasts.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 2rem; color: var(--admin-text-muted);">
              <p>No purchase data available for forecasting. Data will appear as orders are placed.</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = forecasts.slice(0, 8).map(item => {
        const displayName = item.partNumber || 'Unknown';
        const displayDesc = item.description && item.description !== item.partNumber ? item.description : '';
        const trendIcon = item.trend === 'rising' ? 'trending-up' : item.trend === 'falling' ? 'trending-down' : 'minus';
        const trendColor = item.trend === 'rising' ? '#ef4444' : item.trend === 'falling' ? '#3b82f6' : '#6b7280';
        
        return `
        <tr>
          <td>
            <div class="part-info">
              <div class="part-icon ${getCategoryClass(item.category || 'general')}">
                <i data-lucide="${getCategoryIcon(item.category || 'general')}"></i>
              </div>
              <div>
                <div class="part-name" style="font-weight: 600;">${escapeHtml(displayName)}</div>
                ${displayDesc ? `<div class="part-number" style="font-size: 0.75rem; color: var(--admin-text-muted);">${escapeHtml(displayDesc.substring(0, 40))}${displayDesc.length > 40 ? '...' : ''}</div>` : ''}
                <div class="part-number" style="font-size: 0.7rem; color: var(--admin-text-secondary);">${item.brand || 'N/A'}</div>
              </div>
            </div>
          </td>
          <td>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-weight: 600;">${formatNumber(item.currentDemand)}</span>
              <i data-lucide="${trendIcon}" style="width: 16px; height: 16px; color: ${trendColor};"></i>
              <span style="font-size: 0.75rem; color: ${trendColor};">${item.weeklyChange >= 0 ? '+' : ''}${item.weeklyChange}%</span>
            </div>
          </td>
          <td>
            <span style="font-weight: 700; color: ${item.forecast7Days > item.thisWeekOrders ? '#10b981' : '#6b7280'};">
              ${formatNumber(item.forecast7Days)}
            </span>
          </td>
          <td>
            <span class="status-badge ${item.recommendation.includes('Increase') || item.recommendation.includes('ensure') ? 'limited' : item.recommendation.includes('Monitor') ? 'warning' : 'available'}">
              ${item.recommendation}
            </span>
          </td>
          <td>
            <button class="admin-btn admin-btn-${item.recommendation.includes('Increase') || item.recommendation.includes('ensure') ? 'primary' : 'secondary'}" style="padding: 0.4rem 0.75rem; font-size: 0.8rem;">
              ${item.recommendation.includes('Increase') || item.recommendation.includes('ensure') ? 'Order Now' : 'Monitor'}
            </button>
          </td>
        </tr>
      `}).join('');
    }
    
    function updateDemandForecastSidebar(forecast) {
      const summary = forecast.summary || {};
      const forecasts = forecast.forecasts || [];
      
      // Calculate totals from forecasts
      const totalForecast7Days = forecasts.reduce((sum, f) => sum + (f.forecast7Days || 0), 0);
      const totalRevenue = forecasts.reduce((sum, f) => sum + (f.revenue || 0), 0);
      const avgConfidence = forecasts.length > 0 
        ? Math.round(forecasts.reduce((sum, f) => sum + (f.confidence || 0), 0) / forecasts.length)
        : 0;
      
      // Week over week change
      const weekChange = summary.totalLastWeek > 0 
        ? Math.round(((summary.totalThisWeek - summary.totalLastWeek) / summary.totalLastWeek) * 100)
        : (summary.totalThisWeek > 0 ? 100 : 0);
      
      // Update the sidebar cards
      const sidebar = document.querySelector('.prediction-sidebar');
      if (sidebar) {
        sidebar.innerHTML = `
          <div class="prediction-metric-card">
            <div class="prediction-metric-header">
              <div class="prediction-metric-icon" style="background: rgba(16, 185, 129, 0.12); color: #10b981;">
                <i data-lucide="trending-up"></i>
              </div>
              <div class="prediction-metric-title">This Week Orders</div>
            </div>
            <div class="prediction-metric-value">${formatNumber(summary.totalThisWeek || 0)}</div>
            <div class="prediction-metric-change ${weekChange >= 0 ? 'positive' : 'negative'}">
              <i data-lucide="${weekChange >= 0 ? 'arrow-up' : 'arrow-down'}"></i>
              ${weekChange >= 0 ? '+' : ''}${weekChange}% vs last week
            </div>
          </div>
          
          <div class="prediction-metric-card">
            <div class="prediction-metric-header">
              <div class="prediction-metric-icon" style="background: rgba(59, 130, 246, 0.12); color: #3b82f6;">
                <i data-lucide="dollar-sign"></i>
              </div>
              <div class="prediction-metric-title">Month Revenue</div>
            </div>
            <div class="prediction-metric-value">${formatCurrency(totalRevenue)}</div>
            <div class="prediction-metric-change positive">
              <i data-lucide="package"></i>
              ${formatNumber(summary.totalThisMonth || 0)} orders
            </div>
          </div>
          
          <div class="prediction-metric-card">
            <div class="prediction-metric-header">
              <div class="prediction-metric-icon" style="background: rgba(245, 158, 11, 0.12); color: #f59e0b;">
                <i data-lucide="package"></i>
              </div>
              <div class="prediction-metric-title">7-Day Forecast</div>
            </div>
            <div class="prediction-metric-value">${formatNumber(totalForecast7Days)}</div>
            <div class="prediction-metric-change ${totalForecast7Days > summary.totalThisWeek ? 'positive' : 'neutral'}">
              <i data-lucide="calendar"></i>
              Expected orders
            </div>
          </div>
          
          <div class="prediction-metric-card">
            <div class="prediction-metric-header">
              <div class="prediction-metric-icon" style="background: rgba(139, 92, 246, 0.12); color: #8b5cf6;">
                <i data-lucide="target"></i>
              </div>
              <div class="prediction-metric-title">Unique Parts</div>
            </div>
            <div class="prediction-metric-value">${formatNumber(summary.uniquePartsOrdered || 0)}</div>
            <div class="prediction-metric-change positive">
              <i data-lucide="box"></i>
              Parts ordered this month
            </div>
          </div>
        `;
        
        // Reinitialize Lucide icons
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CHART FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function initSearchTrendsChart() {
      const ctx = document.getElementById('searchTrendsChart');
      if (!ctx) return;
      
      const trends = analyticsData.searchTrends || [];
      const labels = trends.map(t => t.date);
      const data = trends.map(t => t.totalSearches);
      
      // Use fallback data if no real data
      const chartLabels = labels.length > 0 ? labels : Array.from({length: 30}, (_, i) => `Day ${i + 1}`);
      const chartData = data.length > 0 ? data : Array(30).fill(0);
      
      const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
      gradient.addColorStop(1, 'rgba(59, 130, 246, 0.02)');
      
      if (window.searchTrendsChartInstance) {
        window.searchTrendsChartInstance.destroy();
      }
      
      window.searchTrendsChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'Searches',
            data: chartData,
            borderColor: '#3b82f6',
            backgroundColor: gradient,
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#3b82f6',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { backgroundColor: 'rgba(30, 41, 59, 0.95)', padding: 12, cornerRadius: 8 }
          },
          scales: {
            y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' }, ticks: { color: '#64748b' } },
            x: { grid: { display: false }, ticks: { color: '#64748b', maxTicksLimit: 10 } }
          }
        }
      });
    }
    
    function initPurchaseCharts() {
      // Category Pie Chart
      const pieCtx = document.getElementById('categoryPieChart');
      if (pieCtx) {
        const categories = analyticsData.categories || [];
        const labels = categories.length > 0 ? categories.map(c => c.category) : ['No Data'];
        const data = categories.length > 0 ? categories.map(c => c.revenue) : [1];
        
        if (window.categoryPieChartInstance) window.categoryPieChartInstance.destroy();
        
        window.categoryPieChartInstance = new Chart(pieCtx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: ['#ef4444', '#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#06b6d4'],
              borderWidth: 0,
              hoverOffset: 10
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 15 } } },
            cutout: '60%'
          }
        });
      }
      
      // Purchase Frequency Chart
      const freqCtx = document.getElementById('purchaseFrequencyChart');
      if (freqCtx) {
        const frequency = analyticsData.purchaseFrequency || [];
        const labels = frequency.length > 0 ? frequency.map(f => f.label) : ['1-time', '2-3 times', '4-6 times', '7+ times'];
        const data = frequency.length > 0 ? frequency.map(f => f.count) : [0, 0, 0, 0];
        
        if (window.purchaseFreqChartInstance) window.purchaseFreqChartInstance.destroy();
        
        window.purchaseFreqChartInstance = new Chart(freqCtx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{ label: 'Customers', data: data, backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b'], borderRadius: 8 }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' }, ticks: { color: '#64748b' } },
              x: { grid: { display: false }, ticks: { color: '#64748b' } }
            }
          }
        });
      }
    }
    
    function initDemandForecastChart() {
      const ctx = document.getElementById('demandForecastChart');
      if (!ctx) return;
      
      const forecast = analyticsData.demandForecast || {};
      const trendData = forecast.trendData || [];
      
      // Build chart data from trend data (uses orders not totalSearches)
      const labels = trendData.length > 0 
        ? [...trendData.map(t => t.date.split('-').slice(1).join('/')), 'Forecast +1', 'Forecast +2', 'Forecast +3']
        : ['Week -4', 'Week -3', 'Week -2', 'Week -1', 'Current', 'Forecast +1', 'Forecast +2', 'Forecast +3'];
      
      const historicalData = trendData.length > 0 
        ? [...trendData.map(t => t.orders || 0), null, null, null]
        : [0, 0, 0, 0, 0, null, null, null];
      
      // Calculate forecast based on recent trend
      const recentValues = historicalData.filter(v => v !== null && v > 0);
      const lastValue = recentValues.length > 0 ? recentValues[recentValues.length - 1] : 0;
      const avgValue = recentValues.length > 0 ? Math.round(recentValues.reduce((a, b) => a + b, 0) / recentValues.length) : 0;
      
      const forecastData = trendData.length > 0
        ? [...trendData.map(() => null), avgValue, Math.round(avgValue * 1.05), Math.round(avgValue * 1.1)]
        : [null, null, null, null, null, 0, 0, 0];
      
      if (window.demandForecastChartInstance) window.demandForecastChartInstance.destroy();
      
      const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 320);
      gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
      gradient.addColorStop(1, 'rgba(59, 130, 246, 0.02)');
      
      const forecastGradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 320);
      forecastGradient.addColorStop(0, 'rgba(16, 185, 129, 0.3)');
      forecastGradient.addColorStop(1, 'rgba(16, 185, 129, 0.02)');
      
      window.demandForecastChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.slice(-10),
          datasets: [
            {
              label: 'Historical',
              data: historicalData.slice(-10),
              borderColor: '#3b82f6',
              backgroundColor: gradient,
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#3b82f6',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 5
            },
            {
              label: 'Forecast',
              data: forecastData.slice(-10),
              borderColor: '#10b981',
              backgroundColor: forecastGradient,
              borderWidth: 3,
              borderDash: [5, 5],
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#10b981',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 5
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(30, 41, 59, 0.95)', padding: 12, cornerRadius: 8 } },
          scales: {
            y: { beginAtZero: false, grid: { color: 'rgba(0, 0, 0, 0.05)' }, ticks: { color: '#64748b' } },
            x: { grid: { display: false }, ticks: { color: '#64748b' } }
          }
        }
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB SWITCHING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function switchAnalyticsTab(tabName) {
      document.querySelectorAll('.analytics-panel').forEach(panel => panel.classList.remove('active'));
      document.querySelectorAll('.analytics-tab').forEach(tab => tab.classList.remove('active'));
      
      document.getElementById('tab-' + tabName).classList.add('active');
      event.target.closest('.analytics-tab').classList.add('active');
      
      if (typeof lucide !== 'undefined') lucide.createIcons();
      
      // Initialize charts for tab
      if (tabName === 'search-behavior' && !window.searchTrendsChartInit) {
        setTimeout(() => { initSearchTrendsChart(); window.searchTrendsChartInit = true; }, 100);
      }
      if (tabName === 'purchase-patterns' && !window.purchaseChartsInit) {
        setTimeout(() => { initPurchaseCharts(); window.purchaseChartsInit = true; }, 100);
      }
      if (tabName === 'demand-forecast') {
        fetchDemandForecast();
        setTimeout(() => { initDemandForecastChart(); window.demandForecastChartInit = true; }, 100);
      }
      if (tabName === 'ai-insights') {
        fetchAIInsights();
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AI CHAT FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Parse and clean AI response - handles markdown code fences and basic formatting
    function parseAIResponse(text) {
      if (!text) return '<p>No response received.</p>';
      
      // Remove markdown code fences (```html, ```, etc.)
      let cleaned = text
        .replace(/```html\s*/gi, '')
        .replace(/```\s*/g, '')
        .trim();
      
      // If response doesn't start with HTML tag, wrap in paragraph
      if (!cleaned.match(/^\s*<[a-z]/i)) {
        // Convert line breaks to paragraphs for plain text
        cleaned = cleaned
          .split(/\n\n+/)
          .map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`)
          .join('');
      }
      
      // Convert markdown-style bold **text** to <strong>
      cleaned = cleaned.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      
      // Convert markdown-style italic *text* to <em>
      cleaned = cleaned.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');
      
      // Convert markdown bullet points to HTML lists
      cleaned = cleaned.replace(/(<p>\s*[-â€¢]\s*.+(?:<br>[-â€¢]\s*.+)*<\/p>)/gi, (match) => {
        const items = match
          .replace(/<\/?p>/gi, '')
          .split(/<br>/i)
          .filter(i => i.trim())
          .map(i => `<li>${i.replace(/^\s*[-â€¢]\s*/, '')}</li>`)
          .join('');
        return `<ul>${items}</ul>`;
      });
      
      return cleaned;
    }
    
    function askAI(question) {
      document.getElementById('aiChatInput').value = question;
      sendAIMessage();
    }
    
    function handleChatKeypress(event) {
      if (event.key === 'Enter') sendAIMessage();
    }
    
    async function sendAIMessage() {
      const input = document.getElementById('aiChatInput');
      const messagesContainer = document.getElementById('aiChatMessages');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Add user message
      messagesContainer.insertAdjacentHTML('beforeend', `
        <div class="ai-chat-message user">
          <div class="ai-chat-message-avatar"><i data-lucide="user"></i></div>
          <div class="ai-chat-message-content"><p>${escapeHtml(message)}</p></div>
        </div>
      `);
      
      input.value = '';
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      // Show loading
      messagesContainer.insertAdjacentHTML('beforeend', `
        <div class="ai-chat-message assistant" id="aiLoadingMessage">
          <div class="ai-chat-message-avatar"><i data-lucide="bot"></i></div>
          <div class="ai-chat-message-content"><p><em>Analyzing your data...</em></p></div>
        </div>
      `);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      if (typeof lucide !== 'undefined') lucide.createIcons();
      
      try {
        const response = await fetch('/admin/api/analytics/ai-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        const result = await response.json();
        
        // Remove loading message
        const loadingMsg = document.getElementById('aiLoadingMessage');
        if (loadingMsg) loadingMsg.remove();
        
        // Add AI response - parse and clean the response
        const rawResponse = result.success ? result.data.response : 'Sorry, I encountered an error. Please try again.';
        const aiResponse = parseAIResponse(rawResponse);
        messagesContainer.insertAdjacentHTML('beforeend', `
          <div class="ai-chat-message assistant">
            <div class="ai-chat-message-avatar"><i data-lucide="bot"></i></div>
            <div class="ai-chat-message-content">${aiResponse}</div>
          </div>
        `);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
      } catch (error) {
        const loadingMsg = document.getElementById('aiLoadingMessage');
        if (loadingMsg) loadingMsg.remove();
        
        messagesContainer.insertAdjacentHTML('beforeend', `
          <div class="ai-chat-message assistant">
            <div class="ai-chat-message-avatar"><i data-lucide="bot"></i></div>
            <div class="ai-chat-message-content"><p>Sorry, I encountered a connection error. Please try again.</p></div>
          </div>
        `);
      }
      
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILITY FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toLocaleString();
    }
    
    function formatCurrency(amount) {
      if (amount >= 1000000) return '$' + (amount / 1000000).toFixed(1) + 'M';
      if (amount >= 1000) return '$' + (amount / 1000).toFixed(0) + 'K';
      return '$' + amount.toLocaleString();
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function getCategoryClass(category) {
      const cat = (category || '').toLowerCase();
      if (cat.includes('brake')) return 'brake';
      if (cat.includes('engine') || cat.includes('motor')) return 'engine';
      if (cat.includes('electric') || cat.includes('ignition')) return 'electrical';
      if (cat.includes('suspens') || cat.includes('strut')) return 'suspension';
      if (cat.includes('filter')) return 'body';
      if (cat.includes('transmiss')) return 'transmission';
      return 'general';
    }
    
    function getCategoryIcon(category) {
      const cat = (category || '').toLowerCase();
      if (cat.includes('brake')) return 'disc';
      if (cat.includes('engine') || cat.includes('motor')) return 'settings';
      if (cat.includes('electric') || cat.includes('ignition')) return 'zap';
      if (cat.includes('suspens') || cat.includes('strut')) return 'move-vertical';
      if (cat.includes('filter')) return 'filter';
      if (cat.includes('transmiss')) return 'cog';
      return 'package';
    }
    
    function getCategoryColor(category) {
      const cat = (category || '').toLowerCase();
      if (cat.includes('brake')) return '#ef4444';
      if (cat.includes('engine')) return '#3b82f6';
      if (cat.includes('electric')) return '#f59e0b';
      if (cat.includes('suspens')) return '#8b5cf6';
      if (cat.includes('filter')) return '#10b981';
      return '#64748b';
    }
    
    function getCategoryBg(category) {
      return `${getCategoryColor(category)}1f`;
    }
    
    function getConversionClass(rate) {
      if (rate >= 60) return 'high';
      if (rate >= 30) return 'medium';
      return 'low';
    }
    
    function getStockStatusClass(status) {
      if (status === 'available' || status === 'in-stock') return 'available';
      if (status === 'limited' || status === 'low-stock') return 'limited';
      return 'out-of-stock';
    }
    
    function getStockStatusText(status) {
      if (status === 'available' || status === 'in-stock') return 'In Stock';
      if (status === 'limited' || status === 'low-stock') return 'Low Stock';
      return 'Out of Stock';
    }
    
    function showLoadingState() {
      // Add loading overlay or skeleton states
    }
    
    function hideLoadingState() {
      // Remove loading states
    }
    
    function showErrorState(message) {
      console.error(message);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INITIALIZATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    document.addEventListener('DOMContentLoaded', function() {
      // Fetch initial data
      fetchAnalyticsData(currentPeriod);
      
      // Initialize first chart
      setTimeout(function() {
        initSearchTrendsChart();
        window.searchTrendsChartInit = true;
      }, 500);
    });

    // Period selector change handler
    function changePeriod(days) {
      currentPeriod = days;
      fetchAnalyticsData(days);
      
      // Update active button states
      document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
    }
  </script>

<%- include('partials/footer') %>
