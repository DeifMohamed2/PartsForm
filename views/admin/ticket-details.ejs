<%- include('partials/header') %>
<link rel="stylesheet" href="/css/adminCSS/admin-dashboard.css">
<link rel="stylesheet" href="/css/adminCSS/admin-tickets.css">
</head>
<body class="<%= typeof currentModule !== 'undefined' && currentModule ? 'module-' + currentModule : '' %>" data-ticket-id="<%= ticket.id %>" data-ticket-oid="<%= ticket._id %>">
  <div class="admin-wrapper">
    <%- include('partials/sidebar', { activePage: 'tickets', currentModule: currentModule }) %>
    
    <main class="admin-main">
      <%- include('partials/topbar', { pageTitle: 'Ticket Chat', currentModule: currentModule }) %>
      
      <div class="admin-content">
        <!-- Breadcrumb -->
        <div style="margin-bottom: 1.5rem;">
          <a href="/admin/tickets<%= currentModule ? '?module=' + currentModule : '' %>" style="color: var(--admin-text-muted); text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
            <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
            Back to Tickets
          </a>
        </div>

        <!-- Ticket Details Layout -->
        <div class="ticket-details-layout">
          <!-- Sidebar -->
          <div class="ticket-sidebar">
            <!-- Ticket Info -->
            <div class="ticket-info-card">
              <div class="ticket-info-header">
                <h3><i data-lucide="ticket"></i> Ticket Information</h3>
              </div>
              <div class="ticket-info-body">
                <div class="info-row">
                  <span class="info-label">Ticket ID</span>
                  <span class="info-value" style="color: var(--module-primary, var(--admin-primary));"><%= ticket.id %></span>
                </div>
                <div class="info-row">
                  <span class="info-label">Order</span>
                  <span class="info-value"><%= ticket.orderNumber || 'N/A' %></span>
                </div>
                <div class="info-row">
                  <span class="info-label">Category</span>
                  <span class="info-value"><%= ticket.category %></span>
                </div>
                <div class="info-row">
                  <span class="info-label">Priority</span>
                  <span class="info-value">
                    <span class="priority-badge <%= ticket.priority || 'medium' %>" style="padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase;">
                      <%= (ticket.priority || 'medium').toUpperCase() %>
                    </span>
                  </span>
                </div>
                <div class="info-row">
                  <span class="info-label">Created</span>
                  <span class="info-value"><%= new Date(ticket.createdAt).toLocaleDateString() %></span>
                </div>
                <div class="info-row">
                  <span class="info-label">Messages</span>
                  <span class="info-value"><%= ticket.messages ? ticket.messages.length : 0 %></span>
                </div>
              </div>
              <div class="status-update-section">
                <label>Update Status</label>
                <select class="status-select" id="statusSelect" onchange="updateStatus()">
                  <option value="open" <%= ticket.status === 'open' ? 'selected' : '' %>>Open</option>
                  <option value="in-progress" <%= ticket.status === 'in-progress' ? 'selected' : '' %>>In Progress</option>
                  <option value="resolved" <%= ticket.status === 'resolved' ? 'selected' : '' %>>Resolved</option>
                  <option value="closed">Closed</option>
                </select>
              </div>
            </div>

            <!-- Customer Info -->
            <div class="ticket-info-card">
              <div class="ticket-info-header">
                <h3><i data-lucide="user"></i> Customer</h3>
              </div>
              <div class="ticket-info-body">
                <div style="display: flex; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid var(--admin-border);">
                  <div class="customer-avatar">
                    <%= (ticket.customerName || ticket.customer || 'C').charAt(0).toUpperCase() %>
                  </div>
                  <div>
                    <div style="font-weight: 600; color: var(--admin-text-primary);"><%= ticket.customerName || ticket.customer || 'Customer' %></div>
                    <div style="font-size: 0.8rem; color: var(--admin-text-muted);"><%= ticket.customerEmail || ticket.email || '' %></div>
                  </div>
                </div>
                <div class="info-row">
                  <span class="info-label">Industry</span>
                  <span class="info-value"><%= ticket.industry || 'N/A' %></span>
                </div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="ticket-info-card">
              <div class="ticket-info-header">
                <h3><i data-lucide="zap"></i> Quick Actions</h3>
              </div>
              <div class="ticket-info-body" style="display: flex; flex-direction: column; gap: 0.5rem;">
                <button class="admin-btn admin-btn-secondary" style="width: 100%; justify-content: center;" onclick="markResolved()">
                  <i data-lucide="check-circle"></i>
                  Mark Resolved
                </button>
                <button class="admin-btn" style="width: 100%; justify-content: center; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none;" onclick="closeTicket()">
                  <i data-lucide="x-circle"></i>
                  Close Ticket
                </button>
              </div>
            </div>
          </div>

          <!-- Chat Container -->
          <div class="chat-container">
            <div class="chat-header">
              <div class="chat-header-icon">
                <i data-lucide="message-circle"></i>
              </div>
              <div class="chat-header-text">
                <h3><%= ticket.subject %></h3>
                <p>Conversation with <%= ticket.customerName || ticket.customer || 'Customer' %></p>
              </div>
              <div style="margin-left: auto;">
                <span class="ticket-status-badge <%= ticket.status %>">
                  <% if (ticket.status === 'open') { %>
                    <i data-lucide="inbox"></i>
                  <% } else if (ticket.status === 'in-progress') { %>
                    <i data-lucide="loader"></i>
                  <% } else { %>
                    <i data-lucide="check-circle"></i>
                  <% } %>
                  <%= ticket.status.split('-').map(function(w) { return w.charAt(0).toUpperCase() + w.slice(1); }).join(' ') %>
                </span>
              </div>
            </div>

            <div class="chat-messages" id="chatMessages">
              <%
                var messages = ticket.messages || [
                  { sender: 'customer', content: ticket.description || 'Initial ticket description', time: ticket.createdAt || new Date().toISOString() }
                ];
              %>
              <% messages.forEach(function(msg) { %>
              <div class="message <%= msg.sender === 'admin' ? 'admin' : 'customer' %>">
                <div class="message-avatar">
                  <% if (msg.sender === 'admin') { %>A<% } else { %><%= (ticket.customerName || 'C').charAt(0) %><% } %>
                </div>
                <div class="message-bubble">
                  <div class="message-text"><%= msg.content || msg.text %></div>
                  <% if (msg.attachments && msg.attachments.length > 0) { %>
                  <div class="message-attachments">
                    <% msg.attachments.forEach(function(file) { 
                      var isImage = file.mimetype && file.mimetype.startsWith('image/');
                      var isPdf = file.mimetype && file.mimetype.includes('pdf');
                      var iconName = isImage ? 'image' : (isPdf ? 'file-text' : 'file');
                    %>
                    <a href="<%= file.path %>" download="<%= file.originalName %>" class="attachment-link attachment-file">
                      <div class="attachment-icon"><i data-lucide="<%= iconName %>"></i></div>
                      <div class="attachment-info">
                        <span class="attachment-name"><%= file.originalName %></span>
                        <span class="attachment-meta"><%= Math.round((file.size || 0) / 1024) %> KB<%= isImage ? ' • Image' : '' %></span>
                      </div>
                      <div class="attachment-download"><i data-lucide="download"></i></div>
                    </a>
                    <% }); %>
                  </div>
                  <% } %>
                  <div class="message-time">
                    <%= msg.sender === 'admin' ? 'Admin' : (ticket.customerName || 'Customer') %> • 
                    <%= typeof msg.time === 'string' ? msg.time : new Date(msg.time || msg.createdAt).toLocaleString() %>
                  </div>
                </div>
              </div>
              <% }); %>
            </div>

            <div class="chat-input-container">
              <div class="quick-replies">
                <button class="quick-reply-btn" onclick="insertQuickReply('Thank you for reaching out. We are looking into this.')">Thanks for reaching out</button>
                <button class="quick-reply-btn" onclick="insertQuickReply('Your issue has been resolved. Please let us know if you need further assistance.')">Issue resolved</button>
                <button class="quick-reply-btn" onclick="insertQuickReply('Could you please provide more details about the issue?')">Need more details</button>
              </div>
              <form id="chatForm" class="chat-input-form" onsubmit="sendMessage(event)">
                <div class="chat-input-wrapper">
                  <textarea 
                    id="messageInput" 
                    class="chat-textarea" 
                    placeholder="Type your message..."
                    rows="1"
                  ></textarea>
                  <button type="button" class="btn-attach" onclick="document.getElementById('fileInput').click()">
                    <i data-lucide="paperclip"></i>
                  </button>
                  <input type="file" id="fileInput" multiple hidden>
                </div>
                <button type="submit" class="btn-send">
                  <i data-lucide="send"></i>
                  <span>Send</span>
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    window.adminTicketId = '<%= ticket.id %>';
    window.adminTicketOid = '<%= ticket._id %>';
    window.adminModuleParam = '<%= currentModule ? "?module=" + currentModule : "" %>';
    window.customerName = '<%= ticket.customerName || ticket.customer || "Customer" %>';
    window.ticketStatus = '<%= ticket.status %>';
  </script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/adminJS/admin-ticket-details.js"></script>

<%- include('partials/footer') %>
