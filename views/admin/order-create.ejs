<%- include('partials/header') %>
<link rel="stylesheet" href="/css/adminCSS/admin-dashboard.css">
<link rel="stylesheet" href="/css/adminCSS/admin-orders.css">
<style>
  /* Create Order Styles */
  .create-order-page {
    max-width: 1200px;
    margin: 0 auto;
  }
  
  .create-order-grid {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 1.5rem;
  }
  
  /* Form Card */
  .form-card {
    background: var(--admin-bg-secondary);
    border: 1px solid var(--admin-border);
    border-radius: 16px;
    overflow: visible;
    margin-bottom: 1.5rem;
    position: relative;
  }
  
  /* Fix header rounded corners since overflow is visible */
  .form-card-header {
    border-radius: 16px 16px 0 0;
  }
  
  .form-card-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--admin-border);
    background: var(--admin-bg-tertiary);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .form-card-header h3 {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--admin-text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .form-card-header h3 i {
    width: 18px;
    height: 18px;
    color: var(--module-primary, var(--admin-primary));
  }
  
  .form-card-body {
    padding: 1.5rem;
  }
  
  /* Form Elements */
  .form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 1.25rem;
  }
  
  .form-row:last-child {
    margin-bottom: 0;
  }
  
  .form-row.single {
    grid-template-columns: 1fr;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .form-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--admin-text-primary);
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }
  
  .form-label .required {
    color: #ef4444;
  }
  
  .form-input,
  .form-select,
  .form-textarea {
    padding: 0.75rem 1rem;
    background: var(--admin-bg-primary);
    border: 1px solid var(--admin-border);
    border-radius: 10px;
    color: var(--admin-text-primary);
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }
  
  .form-input:focus,
  .form-select:focus,
  .form-textarea:focus {
    outline: none;
    border-color: var(--module-primary, var(--admin-primary));
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  .form-textarea {
    min-height: 100px;
    resize: vertical;
  }
  
  .form-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    padding-right: 2.5rem;
  }
  
  /* Part Search Section */
  .part-search-section {
    margin-bottom: 1.5rem;
  }
  
  .part-search-container {
    position: relative;
  }
  
  .part-search-input {
    width: 100%;
    padding: 1rem 1rem 1rem 3rem;
    background: var(--admin-bg-primary);
    border: 2px solid var(--admin-border);
    border-radius: 12px;
    color: var(--admin-text-primary);
    font-size: 0.95rem;
    transition: all 0.2s ease;
  }
  
  .part-search-input:focus {
    outline: none;
    border-color: var(--module-primary, var(--admin-primary));
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }
  
  .part-search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    color: var(--admin-text-muted);
    pointer-events: none;
  }
  
  .part-search-loading {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    display: none;
  }
  
  .part-search-loading.active {
    display: block;
  }
  
  .part-search-loading i {
    width: 20px;
    height: 20px;
    color: var(--module-primary, var(--admin-primary));
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  /* Search Results Dropdown */
  .part-search-results {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    right: 0;
    background: var(--admin-bg-secondary);
    border: 1px solid var(--admin-border);
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(0, 0, 0, 0.1);
    max-height: 400px;
    overflow-y: auto;
    z-index: 9999;
    display: none;
  }
  
  /* Ensure part search container has stacking context */
  .part-search-section {
    position: relative;
    z-index: 100;
  }
  
  .part-search-results.active {
    display: block;
  }
  
  .part-search-results-header {
    padding: 0.5rem 0.75rem;
    background: var(--admin-bg-tertiary);
    border-bottom: 1px solid var(--admin-border);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--admin-text-muted);
    position: sticky;
    top: 0;
    z-index: 1;
  }
  
  /* Suggestions Style */
  .suggestion-item {
    padding: 0.6rem 0.75rem;
    border-bottom: 1px solid var(--admin-border);
    cursor: pointer;
    transition: background 0.15s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .suggestion-item:last-child {
    border-bottom: none;
  }
  
  .suggestion-item:hover {
    background: var(--admin-bg-tertiary);
  }
  
  .suggestion-part-number {
    font-weight: 600;
    color: var(--admin-text-primary);
    font-family: 'SF Mono', 'Monaco', monospace;
    font-size: 0.9rem;
  }
  
  .suggestion-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.75rem;
    color: var(--admin-text-muted);
  }
  
  .suggestion-meta .brand {
    background: rgba(59, 130, 246, 0.1);
    color: var(--module-primary, #3b82f6);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    font-weight: 500;
  }
  
  .suggestion-arrow {
    color: var(--admin-text-muted);
    width: 16px;
    height: 16px;
  }
  
  /* Results Table Style */
  .results-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
  }
  
  .results-table th {
    text-align: left;
    padding: 0.5rem 0.6rem;
    background: var(--admin-bg-tertiary);
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    color: var(--admin-text-muted);
    border-bottom: 1px solid var(--admin-border);
    position: sticky;
    top: 0;
  }
  
  .results-table td {
    padding: 0.5rem 0.6rem;
    border-bottom: 1px solid var(--admin-border);
    color: var(--admin-text-primary);
  }
  
  .results-table tr:hover {
    background: var(--admin-bg-tertiary);
  }
  
  .results-table .part-num {
    font-family: 'SF Mono', 'Monaco', monospace;
    font-weight: 600;
    font-size: 0.8rem;
  }
  
  .results-table .price-cell {
    font-weight: 700;
    color: var(--module-primary, var(--admin-primary));
    white-space: nowrap;
  }
  
  .results-table .add-btn {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    background: var(--module-primary, var(--admin-primary));
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
  }
  
  .results-table .add-btn:hover {
    transform: scale(1.1);
  }
  
  .results-table .add-btn i {
    width: 14px;
    height: 14px;
  }
  
  /* Legacy styles kept for compatibility */
  .part-search-item {
    padding: 1rem;
    border-bottom: 1px solid var(--admin-border);
    cursor: pointer;
    transition: background 0.2s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }
  
  .part-search-item:last-child {
    border-bottom: none;
  }
  
  .part-search-item:hover {
    background: var(--admin-bg-tertiary);
  }
  
  .part-search-item-info {
    flex: 1;
  }
  
  .part-search-item-number {
    font-weight: 600;
    color: var(--admin-text-primary);
    font-family: 'SF Mono', 'Monaco', monospace;
    margin-bottom: 0.25rem;
  }
  
  .part-search-item-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.8rem;
    color: var(--admin-text-muted);
  }
  
  .part-search-item-meta span {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }
  
  .part-search-item-price {
    font-weight: 700;
    color: var(--module-primary, var(--admin-primary));
    font-size: 1rem;
  }
  
  .part-search-item-add {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    background: var(--module-primary, var(--admin-primary));
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }
  
  .part-search-item-add:hover {
    transform: scale(1.1);
  }
  
  .part-search-item-add i {
    width: 18px;
    height: 18px;
  }
  
  .part-search-empty {
    padding: 2rem;
    text-align: center;
    color: var(--admin-text-muted);
  }
  
  .part-search-empty i {
    width: 40px;
    height: 40px;
    margin-bottom: 0.75rem;
    opacity: 0.5;
  }
  
  /* Selected Items List */
  .selected-items {
    margin-top: 1rem;
  }
  
  .selected-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--admin-bg-tertiary);
    border: 1px solid var(--admin-border);
    border-radius: 12px;
    margin-bottom: 0.75rem;
  }
  
  .selected-item-icon {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--admin-bg-secondary) 0%, var(--admin-bg-primary) 100%);
    border: 1px solid var(--admin-border);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  
  .selected-item-icon i {
    width: 20px;
    height: 20px;
    color: var(--module-primary, var(--admin-primary));
  }
  
  .selected-item-info {
    flex: 1;
    min-width: 0;
  }
  
  .selected-item-name {
    font-weight: 600;
    color: var(--admin-text-primary);
    font-size: 0.9rem;
    margin-bottom: 0.2rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .selected-item-meta {
    display: flex;
    gap: 0.75rem;
    font-size: 0.8rem;
    color: var(--admin-text-muted);
  }
  
  .selected-item-price {
    font-weight: 700;
    color: var(--admin-text-primary);
    font-size: 0.95rem;
    white-space: nowrap;
  }
  
  .selected-item-remove {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }
  
  .selected-item-remove:hover {
    background: rgba(239, 68, 68, 0.2);
  }
  
  .selected-item-remove i {
    width: 16px;
    height: 16px;
  }
  
  .no-items-message {
    text-align: center;
    padding: 2rem;
    color: var(--admin-text-muted);
    border: 2px dashed var(--admin-border);
    border-radius: 12px;
  }
  
  .no-items-message i {
    width: 40px;
    height: 40px;
    margin-bottom: 0.5rem;
    opacity: 0.5;
  }
  
  .no-items-message p {
    margin: 0;
    font-size: 0.9rem;
  }
  
  /* Order Summary Sidebar */
  .order-summary-sidebar {
    position: sticky;
    top: 1.5rem;
  }
  
  .summary-total-row {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--admin-border);
  }
  
  .summary-total-row:last-child {
    border-bottom: none;
  }
  
  .summary-total-row.grand-total {
    border-top: 2px solid var(--admin-border);
    margin-top: 0.5rem;
    padding-top: 1rem;
  }
  
  .summary-total-row .label {
    color: var(--admin-text-muted);
    font-size: 0.9rem;
  }
  
  .summary-total-row .value {
    font-weight: 600;
    color: var(--admin-text-primary);
  }
  
  .summary-total-row.grand-total .label,
  .summary-total-row.grand-total .value {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--admin-text-primary);
  }
  
  .items-count-badge {
    background: var(--module-primary, var(--admin-primary));
    color: white;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.2rem 0.5rem;
    border-radius: 20px;
    margin-left: 0.5rem;
  }
  
  /* Form Actions */
  .form-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 1.5rem;
  }
  
  .form-actions .admin-btn {
    width: 100%;
    justify-content: center;
    padding: 0.875rem 1.5rem;
  }
  
  @media (max-width: 1024px) {
    .create-order-grid {
      grid-template-columns: 1fr;
    }
    
    .order-summary-sidebar {
      position: static;
    }
  }
  
  @media (max-width: 640px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body class="<%= typeof currentModule !== 'undefined' && currentModule ? 'module-' + currentModule : '' %>">
  <div class="admin-wrapper">
    <%- include('partials/sidebar', { activePage: 'orders', currentModule: currentModule }) %>
    
    <main class="admin-main">
      <%- include('partials/topbar', { pageTitle: 'Create Order', currentModule: currentModule }) %>
      
      <div class="admin-content create-order-page">
        <!-- Breadcrumb -->
        <div style="margin-bottom: 1.5rem;">
          <a href="/admin/orders<%= currentModule ? '?module=' + currentModule : '' %>" style="color: var(--admin-text-muted); text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
            <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
            Back to Orders
          </a>
        </div>

        <!-- Page Header -->
        <div class="orders-page-header" style="margin-bottom: 1.5rem;">
          <h2>Create New Order</h2>
        </div>

        <form id="createOrderForm">
          <div class="create-order-grid">
            <!-- Left Column - Main Form -->
            <div>
              <!-- Customer Selection -->
              <div class="form-card">
                <div class="form-card-header">
                  <h3><i data-lucide="user"></i> Customer</h3>
                </div>
                <div class="form-card-body">
                  <div class="form-group">
                    <label class="form-label">Select Customer <span class="required">*</span></label>
                    <select id="buyerId" name="buyerId" class="form-select" required>
                      <option value="">-- Select a customer --</option>
                      <% if (typeof buyers !== 'undefined' && buyers.length > 0) { %>
                        <% buyers.forEach(buyer => { %>
                          <option value="<%= buyer._id %>" 
                                  data-email="<%= buyer.email %>"
                                  data-phone="<%= buyer.phone || '' %>"
                                  data-company="<%= buyer.companyName || '' %>"
                                  data-country="<%= buyer.country || '' %>"
                                  data-city="<%= buyer.city || '' %>">
                            <%= buyer.companyName || (buyer.firstName + ' ' + buyer.lastName) %> (<%= buyer.email %>)
                          </option>
                        <% }); %>
                      <% } %>
                    </select>
                  </div>
                  
                  <div id="customerPreview" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--admin-bg-tertiary); border-radius: 10px;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                      <div style="width: 40px; height: 40px; border-radius: 10px; background: var(--module-primary, #3b82f6); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;" id="customerInitial">?</div>
                      <div>
                        <div style="font-weight: 600; color: var(--admin-text-primary);" id="customerName">-</div>
                        <div style="font-size: 0.85rem; color: var(--admin-text-muted);" id="customerEmail">-</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Parts Search - Separate Card -->
              <div class="form-card" style="z-index: 50;">
                <div class="form-card-header">
                  <h3><i data-lucide="search"></i> Search Parts</h3>
                  <div style="display: flex; gap: 0.5rem;">
                    <button type="button" class="admin-btn admin-btn-secondary" style="padding: 0.4rem 0.75rem; font-size: 0.8rem;" onclick="document.getElementById('excelUploadSection').style.display = document.getElementById('excelUploadSection').style.display === 'none' ? 'block' : 'none';">
                      <i data-lucide="file-spreadsheet" style="width: 14px; height: 14px;"></i>
                      Upload Excel
                    </button>
                  </div>
                </div>
                <div class="form-card-body">
                  <!-- Excel Upload Section (Hidden by default) -->
                  <div id="excelUploadSection" style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: var(--admin-bg-tertiary); border-radius: 12px; border: 2px dashed var(--admin-border);">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                      <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="file-spreadsheet" style="width: 24px; height: 24px; color: white;"></i>
                      </div>
                      <div>
                        <h4 style="margin: 0; font-size: 0.95rem; color: var(--admin-text-primary);">Upload Parts from Excel</h4>
                        <p style="margin: 0; font-size: 0.8rem; color: var(--admin-text-muted);">Upload an Excel file with part numbers and quantities</p>
                      </div>
                    </div>
                    <div style="display: flex; gap: 0.75rem; align-items: center;">
                      <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                      <button type="button" class="admin-btn admin-btn-primary" style="padding: 0.5rem 1rem; font-size: 0.85rem;" onclick="document.getElementById('excelFileInput').click();">
                        <i data-lucide="upload" style="width: 16px; height: 16px;"></i>
                        Choose File
                      </button>
                      <span id="excelFileName" style="font-size: 0.85rem; color: var(--admin-text-muted);">No file selected</span>
                      <button type="button" id="processExcelBtn" class="admin-btn admin-btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.85rem; display: none;">
                        <i data-lucide="check" style="width: 16px; height: 16px;"></i>
                        Process File
                      </button>
                    </div>
                    <div style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--admin-text-muted);">
                      <strong>Format:</strong> Column A = Part Number, Column B = Quantity. <a href="#" style="color: var(--module-primary, #3b82f6);">Download Template</a>
                    </div>
                  </div>

                  <!-- Part Search -->
                  <div class="part-search-section">
                    <label class="form-label" style="margin-bottom: 0.75rem;">Search by Part Number</label>
                    <div class="part-search-container">
                      <i data-lucide="search" class="part-search-icon"></i>
                      <input type="text" 
                             id="partSearchInput" 
                             class="part-search-input" 
                             placeholder="Enter part number to search..."
                             autocomplete="off">
                      <div class="part-search-loading" id="partSearchLoading">
                        <i data-lucide="loader-2"></i>
                      </div>
                      
                      <!-- Search Results -->
                      <div class="part-search-results" id="partSearchResults">
                        <div class="part-search-results-header">Search Results</div>
                        <div id="partSearchResultsList"></div>
                      </div>
                    </div>
                    <p style="margin: 0.5rem 0 0; font-size: 0.75rem; color: var(--admin-text-muted);">
                      Start typing to see suggestions. Click a result to add it to the order.
                    </p>
                  </div>
                </div>
              </div>

              <!-- Selected Items - Separate Card -->
              <div class="form-card">
                <div class="form-card-header">
                  <h3><i data-lucide="shopping-cart"></i> Order Items <span class="items-count-badge" id="headerItemsCount">0</span></h3>
                </div>
                <div class="form-card-body">
                  <div id="selectedItemsList">
                    <div class="no-items-message">
                      <i data-lucide="shopping-cart"></i>
                      <p>No items added yet. Search for parts above or upload an Excel file.</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Order Details -->
              <div class="form-card">
                <div class="form-card-header">
                  <h3><i data-lucide="settings"></i> Order Details</h3>
                </div>
                <div class="form-card-body">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Priority</label>
                      <select id="priority" name="priority" class="form-select">
                        <option value="normal">Normal</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Payment Method</label>
                      <select id="paymentMethod" name="paymentMethod" class="form-select">
                        <option value="bank-dubai">Bank Transfer (Dubai)</option>
                        <option value="bank-international">International Wire</option>
                        <option value="card">Credit/Debit Card</option>
                        <option value="paypal">PayPal</option>
                        <option value="cod">Cash on Delivery</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row single">
                    <div class="form-group">
                      <label class="form-label">Order Notes</label>
                      <textarea id="notes" name="notes" class="form-textarea" placeholder="Add any special instructions or notes..."></textarea>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Shipping Address -->
              <div class="form-card">
                <div class="form-card-header">
                  <h3><i data-lucide="map-pin"></i> Shipping Address</h3>
                </div>
                <div class="form-card-body">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Full Name <span class="required">*</span></label>
                      <input type="text" id="shippingName" name="shippingName" class="form-input" placeholder="Recipient name" required>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Phone <span class="required">*</span></label>
                      <input type="text" id="shippingPhone" name="shippingPhone" class="form-input" placeholder="Contact phone" required>
                    </div>
                  </div>
                  <div class="form-row single">
                    <div class="form-group">
                      <label class="form-label">Street Address <span class="required">*</span></label>
                      <input type="text" id="shippingStreet" name="shippingStreet" class="form-input" placeholder="Street address" required>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">City <span class="required">*</span></label>
                      <input type="text" id="shippingCity" name="shippingCity" class="form-input" placeholder="City" required>
                    </div>
                    <div class="form-group">
                      <label class="form-label">State/Province</label>
                      <input type="text" id="shippingState" name="shippingState" class="form-input" placeholder="State/Province">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Country <span class="required">*</span></label>
                      <input type="text" id="shippingCountry" name="shippingCountry" class="form-input" placeholder="Country" required>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Postal Code</label>
                      <input type="text" id="shippingPostalCode" name="shippingPostalCode" class="form-input" placeholder="Postal code">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Column - Order Summary -->
            <div>
              <div class="form-card order-summary-sidebar">
                <div class="form-card-header">
                  <h3><i data-lucide="receipt"></i> Order Summary</h3>
                </div>
                <div class="form-card-body">
                  <div class="summary-total-row">
                    <span class="label">Items<span class="items-count-badge" id="summaryItemsCount">0</span></span>
                    <span class="value" id="summaryItemsTotal">AED 0.00</span>
                  </div>
                  <div class="summary-total-row">
                    <span class="label">Shipping</span>
                    <span class="value">Calculated later</span>
                  </div>
                  <div class="summary-total-row">
                    <span class="label">Processing Fee</span>
                    <span class="value">AED 0.00</span>
                  </div>
                  <div class="summary-total-row grand-total">
                    <span class="label">Total</span>
                    <span class="value" id="summaryGrandTotal">AED 0.00</span>
                  </div>
                </div>
                
                <div style="padding: 0 1.5rem 1.5rem;">
                  <div class="form-actions">
                    <button type="submit" class="admin-btn admin-btn-primary" id="createOrderBtn" disabled>
                      <i data-lucide="check-circle"></i>
                      Create Order
                    </button>
                    <a href="/admin/orders<%= currentModule ? '?module=' + currentModule : '' %>" class="admin-btn admin-btn-secondary">
                      <i data-lucide="x"></i>
                      Cancel
                    </a>
                  </div>
                </div>
              </div>
              
              <!-- Tips Card -->
              <div class="form-card" style="margin-top: 1.5rem;">
                <div class="form-card-header">
                  <h3><i data-lucide="lightbulb"></i> Tips</h3>
                </div>
                <div class="form-card-body" style="font-size: 0.85rem; color: var(--admin-text-muted); line-height: 1.6;">
                  <p style="margin: 0 0 0.75rem;">
                    <strong style="color: var(--admin-text-primary);">Search parts:</strong> Enter a part number to search. Results will show all available suppliers for that part.
                  </p>
                  <p style="margin: 0 0 0.75rem;">
                    <strong style="color: var(--admin-text-primary);">Multiple parts:</strong> You can add multiple parts to the order by searching and clicking the + button.
                  </p>
                  <p style="margin: 0;">
                    <strong style="color: var(--admin-text-primary);">Customer info:</strong> Shipping details will auto-fill when you select a customer.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </main>
  </div>

  <script>
    // Order state
    const orderState = {
      buyerId: null,
      items: [],
      currency: 'AED'
    };
    
    // DOM elements
    const buyerSelect = document.getElementById('buyerId');
    const customerPreview = document.getElementById('customerPreview');
    const partSearchInput = document.getElementById('partSearchInput');
    const partSearchLoading = document.getElementById('partSearchLoading');
    const partSearchResults = document.getElementById('partSearchResults');
    const partSearchResultsList = document.getElementById('partSearchResultsList');
    const selectedItemsList = document.getElementById('selectedItemsList');
    const selectedItemsCount = document.getElementById('selectedItemsCount');
    const summaryItemsCount = document.getElementById('summaryItemsCount');
    const summaryItemsTotal = document.getElementById('summaryItemsTotal');
    const summaryGrandTotal = document.getElementById('summaryGrandTotal');
    const createOrderBtn = document.getElementById('createOrderBtn');
    
    // Customer selection
    buyerSelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      orderState.buyerId = this.value;
      
      if (this.value) {
        const name = selectedOption.text.split(' (')[0];
        const email = selectedOption.dataset.email;
        const phone = selectedOption.dataset.phone;
        const company = selectedOption.dataset.company;
        const country = selectedOption.dataset.country;
        const city = selectedOption.dataset.city;
        
        document.getElementById('customerInitial').textContent = name.charAt(0).toUpperCase();
        document.getElementById('customerName').textContent = name;
        document.getElementById('customerEmail').textContent = email;
        customerPreview.style.display = 'block';
        
        // Auto-fill shipping info
        document.getElementById('shippingName').value = name;
        document.getElementById('shippingPhone').value = phone || '';
        document.getElementById('shippingCountry').value = country || '';
        document.getElementById('shippingCity').value = city || '';
      } else {
        customerPreview.style.display = 'none';
      }
      
      validateForm();
    });
    
    // Part search
    let searchTimeout = null;
    
    partSearchInput.addEventListener('input', function() {
      const query = this.value.trim();
      
      if (searchTimeout) clearTimeout(searchTimeout);
      
      if (query.length < 2) {
        partSearchResults.classList.remove('active');
        return;
      }
      
      searchTimeout = setTimeout(() => searchParts(query), 300);
    });
    
    partSearchInput.addEventListener('focus', function() {
      if (this.value.trim().length >= 2) {
        partSearchResults.classList.add('active');
      }
    });
    
    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.part-search-container')) {
        partSearchResults.classList.remove('active');
      }
    });
    
    async function searchParts(query) {
      partSearchLoading.classList.add('active');
      
      try {
        // First try autocomplete for prefix matching
        const autocompleteResponse = await fetch(`/admin/api/search/autocomplete?q=${encodeURIComponent(query)}&limit=10`);
        const autocompleteData = await autocompleteResponse.json();
        
        if (autocompleteData.success && autocompleteData.suggestions && autocompleteData.suggestions.length > 0) {
          // Get full details for the suggested part numbers
          const partNumbers = autocompleteData.suggestions.map(s => s.partNumber).join(',');
          const partsResponse = await fetch(`/admin/api/search?q=${encodeURIComponent(partNumbers)}&limit=50`);
          const partsData = await partsResponse.json();
          
          partSearchLoading.classList.remove('active');
          
          if (partsData.success && partsData.results && partsData.results.length > 0) {
            renderSearchResults(partsData.results);
            partSearchResults.classList.add('active');
          } else {
            // Show autocomplete suggestions without full details
            renderAutocompleteSuggestions(autocompleteData.suggestions);
            partSearchResults.classList.add('active');
          }
        } else {
          // Fallback to direct exact search
          const response = await fetch(`/admin/api/search?q=${encodeURIComponent(query)}&limit=20`);
          const data = await response.json();
          
          partSearchLoading.classList.remove('active');
          
          if (data.success && data.results && data.results.length > 0) {
            renderSearchResults(data.results);
            partSearchResults.classList.add('active');
          } else {
            partSearchResultsList.innerHTML = `
              <div class="part-search-empty">
                <i data-lucide="search-x"></i>
                <p>No parts found for "${escapeHtml(query)}"</p>
              </div>
            `;
            partSearchResults.classList.add('active');
            if (typeof lucide !== 'undefined') lucide.createIcons();
          }
        }
      } catch (error) {
        console.error('Search error:', error);
        partSearchLoading.classList.remove('active');
        partSearchResultsList.innerHTML = `
          <div class="part-search-empty">
            <i data-lucide="alert-circle"></i>
            <p>Search failed. Please try again.</p>
          </div>
        `;
        partSearchResults.classList.add('active');
        if (typeof lucide !== 'undefined') lucide.createIcons();
      }
    }
    
    function renderAutocompleteSuggestions(suggestions) {
      partSearchResultsList.innerHTML = `
        <div class="part-search-results-header">Suggestions</div>
        ${suggestions.map((suggestion, index) => `
          <div class="suggestion-item" onclick="selectSuggestion('${escapeHtml(suggestion.partNumber)}')">
            <span class="suggestion-part-number">${escapeHtml(suggestion.partNumber)}</span>
            <div class="suggestion-meta">
              <span class="brand">${escapeHtml(suggestion.brand || 'N/A')}</span>
              <span>${suggestion.count || 1} supplier${(suggestion.count || 1) > 1 ? 's' : ''}</span>
              <i data-lucide="chevron-right" class="suggestion-arrow"></i>
            </div>
          </div>
        `).join('')}
      `;
      
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    
    async function selectSuggestion(partNumber) {
      partSearchInput.value = partNumber;
      partSearchResults.classList.remove('active');
      partSearchLoading.classList.add('active');
      
      try {
        const response = await fetch(`/admin/api/search?q=${encodeURIComponent(partNumber)}&limit=50`);
        const data = await response.json();
        
        partSearchLoading.classList.remove('active');
        
        if (data.success && data.results && data.results.length > 0) {
          renderSearchResults(data.results);
          partSearchResults.classList.add('active');
        }
      } catch (error) {
        console.error('Error fetching part details:', error);
        partSearchLoading.classList.remove('active');
      }
    }
    
    function renderSearchResults(results) {
      partSearchResultsList.innerHTML = `
        <table class="results-table">
          <thead>
            <tr>
              <th>Part #</th>
              <th>Brand</th>
              <th>Supplier</th>
              <th>Price</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${results.map((part, index) => `
              <tr>
                <td class="part-num">${escapeHtml(part.partNumber)}</td>
                <td>${escapeHtml(part.brand || '-')}</td>
                <td>${escapeHtml(part.supplier || '-')}</td>
                <td class="price-cell">${part.currency || 'AED'} ${(part.price || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
                <td>
                  <button type="button" class="add-btn" onclick="addPart(${index})">
                    <i data-lucide="plus"></i>
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      // Store results for later reference
      window.searchResults = results;
      
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    
    function addPart(index) {
      const part = window.searchResults[index];
      if (!part) return;
      
      // Add to order items
      orderState.items.push({
        partNumber: part.partNumber,
        description: part.description || part.partNumber,
        brand: part.brand || 'N/A',
        supplier: part.supplier || 'N/A',
        price: parseFloat(part.price) || 0,
        currency: part.currency || 'AED',
        weight: parseFloat(part.weight) || 0,
        stock: part.stock || 'N/A'
      });
      
      updateSelectedItems();
      validateForm();
      
      // Clear search
      partSearchInput.value = '';
      partSearchResults.classList.remove('active');
    }
    
    function removePart(index) {
      orderState.items.splice(index, 1);
      updateSelectedItems();
      validateForm();
    }
    
    function updateSelectedItems() {
      const count = orderState.items.length;
      const headerItemsCount = document.getElementById('headerItemsCount');
      if (headerItemsCount) headerItemsCount.textContent = count;
      summaryItemsCount.textContent = count;
      
      if (count === 0) {
        selectedItemsList.innerHTML = `
          <div class="no-items-message">
            <i data-lucide="shopping-cart"></i>
            <p>No items added yet. Search for parts above or upload an Excel file.</p>
          </div>
        `;
        summaryItemsTotal.textContent = 'AED 0.00';
        summaryGrandTotal.textContent = 'AED 0.00';
        if (typeof lucide !== 'undefined') lucide.createIcons();
        return;
      }
      
      selectedItemsList.innerHTML = orderState.items.map((item, index) => `
        <div class="selected-item">
          <div class="selected-item-icon">
            <i data-lucide="box"></i>
          </div>
          <div class="selected-item-info">
            <div class="selected-item-name">${escapeHtml(item.partNumber)}</div>
            <div class="selected-item-meta">
              <span>${escapeHtml(item.brand)}</span>
              <span>â€¢</span>
              <span>${escapeHtml(item.supplier)}</span>
            </div>
          </div>
          <div class="selected-item-price">${item.currency} ${item.price.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
          <button type="button" class="selected-item-remove" onclick="removePart(${index})">
            <i data-lucide="trash-2"></i>
          </button>
        </div>
      `).join('');
      
      // Calculate totals
      const total = orderState.items.reduce((sum, item) => sum + item.price, 0);
      summaryItemsTotal.textContent = `AED ${total.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
      summaryGrandTotal.textContent = `AED ${total.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
      
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    
    function validateForm() {
      const isValid = orderState.buyerId && 
                      orderState.items.length > 0 &&
                      document.getElementById('shippingName').value.trim() &&
                      document.getElementById('shippingPhone').value.trim() &&
                      document.getElementById('shippingStreet').value.trim() &&
                      document.getElementById('shippingCity').value.trim() &&
                      document.getElementById('shippingCountry').value.trim();
      
      createOrderBtn.disabled = !isValid;
    }
    
    // Validate on input changes
    document.querySelectorAll('#createOrderForm input, #createOrderForm select').forEach(input => {
      input.addEventListener('input', validateForm);
      input.addEventListener('change', validateForm);
    });
    
    // Form submission
    document.getElementById('createOrderForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!orderState.buyerId || orderState.items.length === 0) {
        alert('Please select a customer and add at least one item');
        return;
      }
      
      createOrderBtn.disabled = true;
      createOrderBtn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i> Creating...';
      
      const orderData = {
        buyerId: orderState.buyerId,
        items: orderState.items,
        priority: document.getElementById('priority').value,
        notes: document.getElementById('notes').value,
        payment: {
          method: document.getElementById('paymentMethod').value,
          type: 'full'
        },
        shipping: {
          fullName: document.getElementById('shippingName').value,
          phone: document.getElementById('shippingPhone').value,
          street: document.getElementById('shippingStreet').value,
          city: document.getElementById('shippingCity').value,
          state: document.getElementById('shippingState').value,
          country: document.getElementById('shippingCountry').value,
          postalCode: document.getElementById('shippingPostalCode').value
        }
      };
      
      try {
        const response = await fetch('/admin/api/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(orderData)
        });
        
        const data = await response.json();
        
        if (data.success) {
          window.location.href = '/admin/orders/' + data.order.id + '<%= currentModule ? "?module=" + currentModule : "" %>';
        } else {
          alert(data.error || 'Failed to create order');
          createOrderBtn.disabled = false;
          createOrderBtn.innerHTML = '<i data-lucide="check-circle"></i> Create Order';
          if (typeof lucide !== 'undefined') lucide.createIcons();
        }
      } catch (error) {
        console.error('Error creating order:', error);
        alert('Failed to create order. Please try again.');
        createOrderBtn.disabled = false;
        createOrderBtn.innerHTML = '<i data-lucide="check-circle"></i> Create Order';
        if (typeof lucide !== 'undefined') lucide.createIcons();
      }
    });
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Initialize
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
    
    // Excel file upload handling
    const excelFileInput = document.getElementById('excelFileInput');
    const excelFileName = document.getElementById('excelFileName');
    const processExcelBtn = document.getElementById('processExcelBtn');
    
    excelFileInput.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        excelFileName.textContent = this.files[0].name;
        processExcelBtn.style.display = 'inline-flex';
      } else {
        excelFileName.textContent = 'No file selected';
        processExcelBtn.style.display = 'none';
      }
    });
    
    processExcelBtn.addEventListener('click', async function() {
      const file = excelFileInput.files[0];
      if (!file) return;
      
      processExcelBtn.disabled = true;
      processExcelBtn.innerHTML = '<i data-lucide="loader-2" style="animation: spin 1s linear infinite;"></i> Processing...';
      
      const formData = new FormData();
      formData.append('file', file);
      
      try {
        const response = await fetch('/admin/api/orders/upload-parts', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success && data.parts && data.parts.length > 0) {
          // Add all parts from Excel
          data.parts.forEach(part => {
            orderState.items.push({
              partNumber: part.partNumber,
              description: part.description || part.partNumber,
              brand: part.brand || 'N/A',
              supplier: part.supplier || 'N/A',
              price: parseFloat(part.price) || 0,
              currency: part.currency || 'AED',
              weight: parseFloat(part.weight) || 0,
              quantity: parseInt(part.quantity) || 1,
              stock: part.stock || 'N/A'
            });
          });
          
          updateSelectedItems();
          validateForm();
          
          // Reset upload section
          excelFileInput.value = '';
          excelFileName.textContent = 'No file selected';
          processExcelBtn.style.display = 'none';
          document.getElementById('excelUploadSection').style.display = 'none';
          
          alert(`Successfully added ${data.parts.length} parts from Excel file.`);
        } else {
          alert(data.error || 'No parts found in the Excel file.');
        }
      } catch (error) {
        console.error('Error processing Excel:', error);
        alert('Failed to process Excel file. Please try again.');
      } finally {
        processExcelBtn.disabled = false;
        processExcelBtn.innerHTML = '<i data-lucide="check" style="width: 16px; height: 16px;"></i> Process File';
        if (typeof lucide !== 'undefined') lucide.createIcons();
      }
    });
  </script>

<%- include('partials/footer') %>
