<%- include('partials/header') %>
<link rel="stylesheet" href="/css/adminCSS/admin-dashboard.css">
<link rel="stylesheet" href="/css/adminCSS/admin-orders.css">
<style>
  /* Edit Order Styles */
  .edit-order-page {
    max-width: 1200px;
    margin: 0 auto;
  }
  
  .edit-order-grid {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 1.5rem;
  }
  
  /* Form Card */
  .form-card {
    background: var(--admin-bg-secondary);
    border: 1px solid var(--admin-border);
    border-radius: 16px;
    overflow: visible;
    margin-bottom: 1.5rem;
    position: relative;
  }
  
  /* Fix header rounded corners since overflow is visible */
  .form-card-header {
    border-radius: 16px 16px 0 0;
  }
  
  .form-card-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--admin-border);
    background: var(--admin-bg-tertiary);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .form-card-header h3 {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--admin-text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .form-card-header h3 i {
    width: 18px;
    height: 18px;
    color: var(--module-primary, var(--admin-primary));
  }
  
  .form-card-body {
    padding: 1.5rem;
  }
  
  /* Form Elements */
  .form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 1.25rem;
  }
  
  .form-row:last-child {
    margin-bottom: 0;
  }
  
  .form-row.single {
    grid-template-columns: 1fr;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .form-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--admin-text-primary);
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }
  
  .form-label .required {
    color: #ef4444;
  }
  
  .form-input,
  .form-select,
  .form-textarea {
    padding: 0.75rem 1rem;
    background: var(--admin-bg-primary);
    border: 1px solid var(--admin-border);
    border-radius: 10px;
    color: var(--admin-text-primary);
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }
  
  .form-input:focus,
  .form-select:focus,
  .form-textarea:focus {
    outline: none;
    border-color: var(--module-primary, var(--admin-primary));
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  .form-input:disabled {
    background: var(--admin-bg-tertiary);
    opacity: 0.7;
  }
  
  .form-textarea {
    min-height: 100px;
    resize: vertical;
  }
  
  .form-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    padding-right: 2.5rem;
  }
  
  /* Order Header Card */
  .order-header-card {
    background: linear-gradient(135deg, var(--admin-bg-secondary) 0%, var(--admin-bg-tertiary) 100%);
    border: 1px solid var(--admin-border);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .order-header-info {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .order-number-badge {
    padding: 0.75rem 1.25rem;
    background: var(--module-primary, var(--admin-primary));
    color: white;
    border-radius: 12px;
    font-family: 'SF Mono', 'Monaco', monospace;
    font-weight: 600;
    font-size: 1rem;
  }
  
  .order-header-meta {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .order-header-meta h2 {
    margin: 0;
    font-size: 1.25rem;
    color: var(--admin-text-primary);
  }
  
  .order-header-meta span {
    font-size: 0.85rem;
    color: var(--admin-text-muted);
  }
  
  .part-search-container {
    position: relative;
  }
  
  .part-search-input {
    width: 100%;
    padding: 1rem 1rem 1rem 3rem;
    background: var(--admin-bg-primary);
    border: 2px solid var(--admin-border);
    border-radius: 12px;
    color: var(--admin-text-primary);
    font-size: 0.95rem;
    transition: all 0.2s ease;
  }
  
  .part-search-input:focus {
    outline: none;
    border-color: var(--module-primary, var(--admin-primary));
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }
  
  .part-search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    color: var(--admin-text-muted);
    pointer-events: none;
  }
  
  .part-search-loading {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    display: none;
  }
  
  .part-search-loading.active {
    display: block;
  }
  
  .part-search-loading i {
    width: 20px;
    height: 20px;
    color: var(--module-primary, var(--admin-primary));
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  /* Search Results Dropdown */
  .part-search-results {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    right: 0;
    background: var(--admin-bg-secondary);
    border: 1px solid var(--admin-border);
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(0, 0, 0, 0.1);
    max-height: 400px;
    overflow-y: auto;
    z-index: 9999;
    display: none;
  }
  
  /* Ensure part search container has stacking context */
  .part-search-section {
    position: relative;
    z-index: 100;
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--admin-border);
  }
  
  .part-search-results.active {
    display: block;
  }
  
  .part-search-results-header {
    padding: 0.5rem 0.75rem;
    background: var(--admin-bg-tertiary);
    border-bottom: 1px solid var(--admin-border);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--admin-text-muted);
    position: sticky;
    top: 0;
    z-index: 1;
  }
  
  /* Suggestions Style */
  .suggestion-item {
    padding: 0.6rem 0.75rem;
    border-bottom: 1px solid var(--admin-border);
    cursor: pointer;
    transition: background 0.15s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .suggestion-item:last-child {
    border-bottom: none;
  }
  
  .suggestion-item:hover {
    background: var(--admin-bg-tertiary);
  }
  
  .suggestion-part-number {
    font-weight: 600;
    color: var(--admin-text-primary);
    font-family: 'SF Mono', 'Monaco', monospace;
    font-size: 0.85rem;
  }
  
  .suggestion-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.7rem;
    color: var(--admin-text-muted);
  }
  
  .suggestion-meta .brand {
    background: rgba(59, 130, 246, 0.1);
    color: var(--module-primary, #3b82f6);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    font-weight: 500;
  }
  
  .suggestion-arrow {
    color: var(--admin-text-muted);
    width: 14px;
    height: 14px;
  }
  
  /* Results Table Style */
  .results-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.75rem;
  }
  
  .results-table th {
    text-align: left;
    padding: 0.4rem 0.5rem;
    background: var(--admin-bg-tertiary);
    font-size: 0.6rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    color: var(--admin-text-muted);
    border-bottom: 1px solid var(--admin-border);
    position: sticky;
    top: 0;
  }
  
  .results-table td {
    padding: 0.4rem 0.5rem;
    border-bottom: 1px solid var(--admin-border);
    color: var(--admin-text-primary);
  }
  
  .results-table tr:hover {
    background: var(--admin-bg-tertiary);
  }
  
  .results-table .part-num {
    font-family: 'SF Mono', 'Monaco', monospace;
    font-weight: 600;
  }
  
  .results-table .price-cell {
    font-weight: 700;
    color: var(--module-primary, var(--admin-primary));
    white-space: nowrap;
  }
  
  .results-table .add-btn {
    width: 24px;
    height: 24px;
    border-radius: 5px;
    background: var(--module-primary, var(--admin-primary));
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
  }
  
  .results-table .add-btn:hover {
    transform: scale(1.1);
  }
  
  .results-table .add-btn i {
    width: 12px;
    height: 12px;
  }

  .part-search-item {
    padding: 1rem;
    border-bottom: 1px solid var(--admin-border);
    cursor: pointer;
    transition: background 0.2s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }
  
  .part-search-item:last-child {
    border-bottom: none;
  }
  
  .part-search-item:hover {
    background: var(--admin-bg-tertiary);
  }
  
  .part-search-item-info {
    flex: 1;
  }
  
  .part-search-item-number {
    font-weight: 600;
    color: var(--admin-text-primary);
    font-family: 'SF Mono', 'Monaco', monospace;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
  }
  
  .part-search-item-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.8rem;
    color: var(--admin-text-muted);
  }
  
  .part-search-item-price {
    font-weight: 700;
    color: var(--module-primary, var(--admin-primary));
    font-size: 0.95rem;
  }
  
  .part-search-item-add {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: var(--module-primary, var(--admin-primary));
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }
  
  .part-search-item-add:hover {
    transform: scale(1.1);
  }
  
  .part-search-item-add i {
    width: 16px;
    height: 16px;
  }
  
  .part-search-empty {
    padding: 2rem;
    text-align: center;
    color: var(--admin-text-muted);
  }
  
  .part-search-empty i {
    width: 32px;
    height: 32px;
    margin-bottom: 0.5rem;
    opacity: 0.5;
  }
  
  /* Selected Items List */
  .selected-items-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .selected-items-table th {
    text-align: left;
    padding: 0.75rem 1rem;
    background: var(--admin-bg-tertiary);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--admin-text-muted);
    border-bottom: 1px solid var(--admin-border);
  }
  
  .selected-items-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--admin-border);
    font-size: 0.9rem;
    color: var(--admin-text-primary);
  }
  
  .selected-items-table tr:last-child td {
    border-bottom: none;
  }
  
  .selected-items-table .part-number {
    font-family: 'SF Mono', 'Monaco', monospace;
    font-weight: 600;
  }
  
  .selected-items-table .price {
    font-weight: 600;
    color: var(--module-primary, var(--admin-primary));
  }
  
  .remove-item-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  
  .remove-item-btn:hover {
    background: rgba(239, 68, 68, 0.2);
  }
  
  .remove-item-btn i {
    width: 16px;
    height: 16px;
  }
  
  .no-items-row td {
    text-align: center;
    padding: 2rem !important;
    color: var(--admin-text-muted);
  }
  
  /* Order Summary Sidebar */
  .order-summary-sidebar {
    position: sticky;
    top: 1.5rem;
  }
  
  .summary-total-row {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--admin-border);
  }
  
  .summary-total-row:last-child {
    border-bottom: none;
  }
  
  .summary-total-row.grand-total {
    border-top: 2px solid var(--admin-border);
    margin-top: 0.5rem;
    padding-top: 1rem;
  }
  
  .summary-total-row .label {
    color: var(--admin-text-muted);
    font-size: 0.9rem;
  }
  
  .summary-total-row .value {
    font-weight: 600;
    color: var(--admin-text-primary);
  }
  
  .summary-total-row.grand-total .label,
  .summary-total-row.grand-total .value {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--admin-text-primary);
  }
  
  .items-count-badge {
    background: var(--module-primary, var(--admin-primary));
    color: white;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.2rem 0.5rem;
    border-radius: 20px;
    margin-left: 0.5rem;
  }
  
  /* Status Select */
  .status-select-wrapper {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--admin-bg-tertiary);
    border-radius: 12px;
  }
  
  .status-select-wrapper .form-select {
    flex: 1;
  }
  
  /* Form Actions */
  .form-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 1.5rem;
  }
  
  .form-actions .admin-btn {
    width: 100%;
    justify-content: center;
    padding: 0.875rem 1.5rem;
  }
  
  .danger-zone {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--admin-border);
  }
  
  .danger-btn {
    width: 100%;
    padding: 0.75rem 1rem;
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.2);
    border-radius: 10px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
  }
  
  .danger-btn:hover {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.3);
  }
  
  .danger-btn i {
    width: 16px;
    height: 16px;
  }
  
  @media (max-width: 1024px) {
    .edit-order-grid {
      grid-template-columns: 1fr;
    }
    
    .order-summary-sidebar {
      position: static;
    }
  }
  
  @media (max-width: 640px) {
    .form-row {
      grid-template-columns: 1fr;
    }
    
    .order-header-card {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start;
    }
  }
</style>
</head>
<body class="<%= typeof currentModule !== 'undefined' && currentModule ? 'module-' + currentModule : '' %>">
  <div class="admin-wrapper">
    <%- include('partials/sidebar', { activePage: 'orders', currentModule: currentModule }) %>
    
    <main class="admin-main">
      <%- include('partials/topbar', { pageTitle: 'Edit Order', currentModule: currentModule }) %>
      
      <div class="admin-content edit-order-page">
        <!-- Breadcrumb -->
        <div style="margin-bottom: 1.5rem;">
          <a href="/admin/orders<%= currentModule ? '?module=' + currentModule : '' %>" style="color: var(--admin-text-muted); text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
            <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
            Back to Orders
          </a>
        </div>

        <!-- Order Header -->
        <div class="order-header-card">
          <div class="order-header-info">
            <div class="order-number-badge"><%= order.id %></div>
            <div class="order-header-meta">
              <h2>Edit Order</h2>
              <span>Created: <%= order.date %></span>
            </div>
          </div>
          <a href="/admin/orders/<%= order.id %><%= currentModule ? '?module=' + currentModule : '' %>" class="admin-btn admin-btn-secondary">
            <i data-lucide="eye"></i>
            View Order
          </a>
        </div>

        <form id="editOrderForm">
          <div class="edit-order-grid">
            <!-- Left Column - Main Form -->
            <div>
              <!-- Status Update -->
              <div class="form-card">
                <div class="form-card-header">
                  <h3><i data-lucide="activity"></i> Order Status</h3>
                </div>
                <div class="form-card-body">
                  <div class="status-select-wrapper">
                    <label class="form-label" style="margin: 0;">Status:</label>
                    <select id="orderStatus" name="status" class="form-select">
                      <option value="pending" <%= order.status === 'pending' ? 'selected' : '' %>>Pending</option>
                      <option value="confirmed" <%= order.status === 'confirmed' ? 'selected' : '' %>>Confirmed</option>
                      <option value="processing" <%= order.status === 'processing' ? 'selected' : '' %>>Processing</option>
                      <option value="shipped" <%= order.status === 'shipped' ? 'selected' : '' %>>Shipped</option>
                      <option value="delivered" <%= order.status === 'delivered' ? 'selected' : '' %>>Delivered</option>
                      <option value="cancelled" <%= order.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                    </select>
                    <span class="status-badge <%= order.status %>" id="statusBadge" style="display: flex; align-items: center; gap: 0.25rem;">
                      <% 
                        const statusIcons = {
                          pending: 'clock',
                          confirmed: 'check',
                          processing: 'loader',
                          shipped: 'truck',
                          delivered: 'check-circle',
                          cancelled: 'x-circle'
                        };
                      %>
                      <i data-lucide="<%= statusIcons[order.status] || 'circle' %>"></i>
                      <%= order.status %>
                    </span>
                  </div>
                </div>
              </div>

              <!-- Customer Information (Read-only) -->
              <div class="form-card">
                <div class="form-card-header">
                  <h3><i data-lucide="user"></i> Customer Information</h3>
                </div>
                <div class="form-card-body">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Customer</label>
                      <input type="text" class="form-input" value="<%= order.customer %>" disabled>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Email</label>
                      <input type="email" class="form-input" value="<%= order.email || 'N/A' %>" disabled>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Order Items -->
              <div class="form-card">
                <div class="form-card-header">
                  <h3><i data-lucide="package"></i> Order Items</h3>
                </div>
                <div class="form-card-body">
                  <!-- Part Search -->
                  <div class="part-search-section">
                    <label class="form-label" style="margin-bottom: 0.75rem;">Add More Parts</label>
                    <div class="part-search-container">
                      <i data-lucide="search" class="part-search-icon"></i>
                      <input type="text" 
                             id="partSearchInput" 
                             class="part-search-input" 
                             placeholder="Search part number to add..."
                             autocomplete="off">
                      <div class="part-search-loading" id="partSearchLoading">
                        <i data-lucide="loader-2"></i>
                      </div>
                      
                      <!-- Search Results -->
                      <div class="part-search-results" id="partSearchResults">
                        <div class="part-search-results-header">Search Results</div>
                        <div id="partSearchResultsList"></div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Items Table -->
                  <table class="selected-items-table" id="itemsTable">
                    <thead>
                      <tr>
                        <th>Part Number</th>
                        <th>Brand</th>
                        <th>Supplier</th>
                        <th>Price</th>
                        <th style="width: 50px;"></th>
                      </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                      <% if (order.items && order.items.length > 0) { %>
                        <% order.items.forEach((item, index) => { %>
                          <tr data-index="<%= index %>">
                            <td class="part-number"><%= item.partNumber %></td>
                            <td><%= item.brand || 'N/A' %></td>
                            <td><%= item.supplier || 'N/A' %></td>
                            <td class="price"><%= item.currency || 'AED' %> <%= (item.price || 0).toLocaleString('en-US', { minimumFractionDigits: 2 }) %></td>
                            <td>
                              <button type="button" class="remove-item-btn" onclick="removeItem(<%= index %>)" <%= order.items.length === 1 ? 'disabled style="opacity: 0.3;"' : '' %>>
                                <i data-lucide="trash-2"></i>
                              </button>
                            </td>
                          </tr>
                        <% }); %>
                      <% } else { %>
                        <tr class="no-items-row">
                          <td colspan="5">
                            <i data-lucide="package-x"></i>
                            <p>No items in this order</p>
                          </td>
                        </tr>
                      <% } %>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Order Details -->
              <div class="form-card">
                <div class="form-card-header">
                  <h3><i data-lucide="settings"></i> Order Details</h3>
                </div>
                <div class="form-card-body">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Priority</label>
                      <select id="priority" name="priority" class="form-select">
                        <option value="normal" <%= order.priority === 'normal' ? 'selected' : '' %>>Normal</option>
                        <option value="high" <%= order.priority === 'high' ? 'selected' : '' %>>High</option>
                        <option value="urgent" <%= order.priority === 'urgent' ? 'selected' : '' %>>Urgent</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Payment Method</label>
                      <select id="paymentMethod" name="paymentMethod" class="form-select">
                        <% const paymentMethod = order.payment?.method || 'bank-dubai'; %>
                        <option value="bank-dubai" <%= paymentMethod === 'bank-dubai' ? 'selected' : '' %>>Bank Transfer (Dubai)</option>
                        <option value="bank-international" <%= paymentMethod === 'bank-international' ? 'selected' : '' %>>International Wire</option>
                        <option value="card" <%= paymentMethod === 'card' ? 'selected' : '' %>>Credit/Debit Card</option>
                        <option value="paypal" <%= paymentMethod === 'paypal' ? 'selected' : '' %>>PayPal</option>
                        <option value="cod" <%= paymentMethod === 'cod' ? 'selected' : '' %>>Cash on Delivery</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row single">
                    <div class="form-group">
                      <label class="form-label">Order Notes</label>
                      <textarea id="notes" name="notes" class="form-textarea" placeholder="Add any special instructions or notes..."><%= order.notes || '' %></textarea>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Shipping Address -->
              <div class="form-card">
                <div class="form-card-header">
                  <h3><i data-lucide="map-pin"></i> Shipping Address</h3>
                </div>
                <div class="form-card-body">
                  <% const shipping = order.shipping || {}; %>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Full Name <span class="required">*</span></label>
                      <input type="text" id="shippingName" name="shippingName" class="form-input" value="<%= shipping.fullName || '' %>" required>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Phone <span class="required">*</span></label>
                      <input type="text" id="shippingPhone" name="shippingPhone" class="form-input" value="<%= shipping.phone || '' %>" required>
                    </div>
                  </div>
                  <div class="form-row single">
                    <div class="form-group">
                      <label class="form-label">Street Address <span class="required">*</span></label>
                      <input type="text" id="shippingStreet" name="shippingStreet" class="form-input" value="<%= shipping.street || '' %>" required>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">City <span class="required">*</span></label>
                      <input type="text" id="shippingCity" name="shippingCity" class="form-input" value="<%= shipping.city || '' %>" required>
                    </div>
                    <div class="form-group">
                      <label class="form-label">State/Province</label>
                      <input type="text" id="shippingState" name="shippingState" class="form-input" value="<%= shipping.state || '' %>">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Country <span class="required">*</span></label>
                      <input type="text" id="shippingCountry" name="shippingCountry" class="form-input" value="<%= shipping.country || '' %>" required>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Postal Code</label>
                      <input type="text" id="shippingPostalCode" name="shippingPostalCode" class="form-input" value="<%= shipping.postalCode || '' %>">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Column - Order Summary -->
            <div>
              <div class="form-card order-summary-sidebar">
                <div class="form-card-header">
                  <h3><i data-lucide="receipt"></i> Order Summary</h3>
                </div>
                <div class="form-card-body">
                  <% const pricing = order.pricing || { subtotal: 0, tax: 0, shipping: 0, total: 0 }; %>
                  <div class="summary-total-row">
                    <span class="label">Items<span class="items-count-badge" id="summaryItemsCount"><%= order.items?.length || 0 %></span></span>
                    <span class="value" id="summaryItemsTotal"><%= pricing.currency || 'AED' %> <%= (pricing.subtotal || 0).toLocaleString('en-US', { minimumFractionDigits: 2 }) %></span>
                  </div>
                  <div class="summary-total-row">
                    <span class="label">Shipping</span>
                    <span class="value"><%= pricing.currency || 'AED' %> <%= (pricing.shipping || 0).toLocaleString('en-US', { minimumFractionDigits: 2 }) %></span>
                  </div>
                  <div class="summary-total-row">
                    <span class="label">Processing Fee</span>
                    <span class="value"><%= pricing.currency || 'AED' %> <%= (pricing.processingFee || 0).toLocaleString('en-US', { minimumFractionDigits: 2 }) %></span>
                  </div>
                  <div class="summary-total-row grand-total">
                    <span class="label">Total</span>
                    <span class="value" id="summaryGrandTotal"><%= pricing.currency || 'AED' %> <%= (pricing.total || 0).toLocaleString('en-US', { minimumFractionDigits: 2 }) %></span>
                  </div>
                </div>
                
                <div style="padding: 0 1.5rem 1.5rem;">
                  <div class="form-actions">
                    <button type="submit" class="admin-btn admin-btn-primary" id="saveOrderBtn">
                      <i data-lucide="check-circle"></i>
                      Save Changes
                    </button>
                    <a href="/admin/orders/<%= order.id %><%= currentModule ? '?module=' + currentModule : '' %>" class="admin-btn admin-btn-secondary">
                      <i data-lucide="x"></i>
                      Cancel
                    </a>
                  </div>
                  
                  <div class="danger-zone">
                    <button type="button" class="danger-btn" onclick="confirmDelete()">
                      <i data-lucide="trash-2"></i>
                      Delete Order
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </main>
  </div>

  <script>
    // Order state
    const orderState = {
      id: '<%= order.id %>',
      items: <%= JSON.stringify(order.items || []) %>,
      currency: '<%= order.pricing?.currency || "AED" %>'
    };
    
    // DOM elements
    const partSearchInput = document.getElementById('partSearchInput');
    const partSearchLoading = document.getElementById('partSearchLoading');
    const partSearchResults = document.getElementById('partSearchResults');
    const partSearchResultsList = document.getElementById('partSearchResultsList');
    const itemsTableBody = document.getElementById('itemsTableBody');
    const summaryItemsCount = document.getElementById('summaryItemsCount');
    const summaryItemsTotal = document.getElementById('summaryItemsTotal');
    const summaryGrandTotal = document.getElementById('summaryGrandTotal');
    
    // Part search
    let searchTimeout = null;
    
    partSearchInput.addEventListener('input', function() {
      const query = this.value.trim();
      
      if (searchTimeout) clearTimeout(searchTimeout);
      
      if (query.length < 2) {
        partSearchResults.classList.remove('active');
        return;
      }
      
      searchTimeout = setTimeout(() => searchParts(query), 300);
    });
    
    partSearchInput.addEventListener('focus', function() {
      if (this.value.trim().length >= 2) {
        partSearchResults.classList.add('active');
      }
    });
    
    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.part-search-container')) {
        partSearchResults.classList.remove('active');
      }
    });
    
    async function searchParts(query) {
      partSearchLoading.classList.add('active');
      
      try {
        // First try autocomplete for prefix matching
        const autocompleteResponse = await fetch(`/admin/api/search/autocomplete?q=${encodeURIComponent(query)}&limit=10`);
        const autocompleteData = await autocompleteResponse.json();
        
        if (autocompleteData.success && autocompleteData.suggestions && autocompleteData.suggestions.length > 0) {
          // Get full details for the first suggested part number
          const partNumber = autocompleteData.suggestions[0].partNumber;
          const partsResponse = await fetch(`/admin/api/search?q=${encodeURIComponent(partNumber)}&limit=20`);
          const partsData = await partsResponse.json();
          
          partSearchLoading.classList.remove('active');
          
          if (partsData.success && partsData.results && partsData.results.length > 0) {
            renderSearchResults(partsData.results);
            partSearchResults.classList.add('active');
          } else {
            // Show autocomplete suggestions
            renderAutocompleteSuggestions(autocompleteData.suggestions);
            partSearchResults.classList.add('active');
          }
        } else {
          // Fallback to direct exact search
          const response = await fetch(`/admin/api/search?q=${encodeURIComponent(query)}&limit=10`);
          const data = await response.json();
          
          partSearchLoading.classList.remove('active');
          
          if (data.success && data.results && data.results.length > 0) {
            renderSearchResults(data.results);
            partSearchResults.classList.add('active');
          } else {
            partSearchResultsList.innerHTML = `
              <div class="part-search-empty">
                <i data-lucide="search-x"></i>
                <p>No parts found</p>
              </div>
            `;
            partSearchResults.classList.add('active');
            if (typeof lucide !== 'undefined') lucide.createIcons();
          }
        }
      } catch (error) {
        console.error('Search error:', error);
        partSearchLoading.classList.remove('active');
      }
    }
    
    function renderAutocompleteSuggestions(suggestions) {
      partSearchResultsList.innerHTML = `
        <div class="part-search-results-header">Suggestions</div>
        ${suggestions.map((suggestion, index) => `
          <div class="suggestion-item" onclick="selectSuggestion('${escapeHtml(suggestion.partNumber)}')">
            <span class="suggestion-part-number">${escapeHtml(suggestion.partNumber)}</span>
            <div class="suggestion-meta">
              <span class="brand">${escapeHtml(suggestion.brand || 'N/A')}</span>
              <span>${suggestion.count || 1} supplier${(suggestion.count || 1) > 1 ? 's' : ''}</span>
              <i data-lucide="chevron-right" class="suggestion-arrow"></i>
            </div>
          </div>
        `).join('')}
      `;
      
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    
    async function selectSuggestion(partNumber) {
      partSearchInput.value = partNumber;
      partSearchResults.classList.remove('active');
      partSearchLoading.classList.add('active');
      
      try {
        const response = await fetch(`/admin/api/search?q=${encodeURIComponent(partNumber)}&limit=20`);
        const data = await response.json();
        
        partSearchLoading.classList.remove('active');
        
        if (data.success && data.results && data.results.length > 0) {
          renderSearchResults(data.results);
          partSearchResults.classList.add('active');
        }
      } catch (error) {
        console.error('Error fetching part details:', error);
        partSearchLoading.classList.remove('active');
      }
    }
    
    function renderSearchResults(results) {
      partSearchResultsList.innerHTML = `
        <table class="results-table">
          <thead>
            <tr>
              <th>Part #</th>
              <th>Brand</th>
              <th>Supplier</th>
              <th>Price</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${results.map((part, index) => `
              <tr>
                <td class="part-num">${escapeHtml(part.partNumber)}</td>
                <td>${escapeHtml(part.brand || '-')}</td>
                <td>${escapeHtml(part.supplier || '-')}</td>
                <td class="price-cell">${part.currency || 'AED'} ${(part.price || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
                <td>
                  <button type="button" class="add-btn" onclick="addPart(${index})">
                    <i data-lucide="plus"></i>
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      window.searchResults = results;
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    
    function addPart(index) {
      const part = window.searchResults[index];
      if (!part) return;
      
      orderState.items.push({
        partNumber: part.partNumber,
        description: part.description || part.partNumber,
        brand: part.brand || 'N/A',
        supplier: part.supplier || 'N/A',
        price: parseFloat(part.price) || 0,
        currency: part.currency || 'AED',
        weight: parseFloat(part.weight) || 0,
        stock: part.stock || 'N/A'
      });
      
      updateItemsTable();
      partSearchInput.value = '';
      partSearchResults.classList.remove('active');
    }
    
    function removeItem(index) {
      if (orderState.items.length <= 1) return;
      orderState.items.splice(index, 1);
      updateItemsTable();
    }
    
    function updateItemsTable() {
      const count = orderState.items.length;
      summaryItemsCount.textContent = count;
      
      if (count === 0) {
        itemsTableBody.innerHTML = `
          <tr class="no-items-row">
            <td colspan="5">
              <i data-lucide="package-x"></i>
              <p>No items in this order</p>
            </td>
          </tr>
        `;
        summaryItemsTotal.textContent = 'AED 0.00';
        summaryGrandTotal.textContent = 'AED 0.00';
        if (typeof lucide !== 'undefined') lucide.createIcons();
        return;
      }
      
      itemsTableBody.innerHTML = orderState.items.map((item, index) => `
        <tr data-index="${index}">
          <td class="part-number">${escapeHtml(item.partNumber)}</td>
          <td>${escapeHtml(item.brand || 'N/A')}</td>
          <td>${escapeHtml(item.supplier || 'N/A')}</td>
          <td class="price">${item.currency || 'AED'} ${(item.price || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
          <td>
            <button type="button" class="remove-item-btn" onclick="removeItem(${index})" ${count === 1 ? 'disabled style="opacity: 0.3;"' : ''}>
              <i data-lucide="trash-2"></i>
            </button>
          </td>
        </tr>
      `).join('');
      
      // Calculate totals
      const total = orderState.items.reduce((sum, item) => sum + (item.price || 0), 0);
      summaryItemsTotal.textContent = `${orderState.currency} ${total.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
      summaryGrandTotal.textContent = `${orderState.currency} ${total.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
      
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    
    // Status change preview
    document.getElementById('orderStatus').addEventListener('change', function() {
      const badge = document.getElementById('statusBadge');
      const status = this.value;
      badge.className = 'status-badge ' + status;
      
      const iconMap = {
        'pending': 'clock',
        'confirmed': 'check',
        'processing': 'loader',
        'shipped': 'truck',
        'delivered': 'check-circle',
        'cancelled': 'x-circle'
      };
      
      badge.innerHTML = '<i data-lucide="' + iconMap[status] + '"></i> ' + status;
      badge.style.display = 'flex';
      badge.style.alignItems = 'center';
      badge.style.gap = '0.25rem';
      if (typeof lucide !== 'undefined') lucide.createIcons();
    });
    
    // Delete confirmation
    async function confirmDelete() {
      if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
        try {
          const response = await fetch('/admin/api/orders/<%= order.id %>', {
            method: 'DELETE'
          });
          
          const data = await response.json();
          
          if (data.success) {
            window.location.href = '/admin/orders<%= currentModule ? "?module=" + currentModule : "" %>';
          } else {
            alert(data.error || 'Failed to delete order');
          }
        } catch (error) {
          console.error('Delete error:', error);
          alert('Failed to delete order');
        }
      }
    }
    
    // Form submission
    document.getElementById('editOrderForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const saveBtn = document.getElementById('saveOrderBtn');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i> Saving...';
      
      const orderData = {
        status: document.getElementById('orderStatus').value,
        priority: document.getElementById('priority').value,
        notes: document.getElementById('notes').value,
        items: orderState.items,
        payment: {
          method: document.getElementById('paymentMethod').value
        },
        shipping: {
          fullName: document.getElementById('shippingName').value,
          phone: document.getElementById('shippingPhone').value,
          street: document.getElementById('shippingStreet').value,
          city: document.getElementById('shippingCity').value,
          state: document.getElementById('shippingState').value,
          country: document.getElementById('shippingCountry').value,
          postalCode: document.getElementById('shippingPostalCode').value
        }
      };
      
      try {
        const response = await fetch('/admin/api/orders/<%= order.id %>', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(orderData)
        });
        
        const data = await response.json();
        
        if (data.success) {
          window.location.href = '/admin/orders/<%= order.id %><%= currentModule ? "?module=" + currentModule : "" %>';
        } else {
          alert(data.error || 'Failed to update order');
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i data-lucide="check-circle"></i> Save Changes';
          if (typeof lucide !== 'undefined') lucide.createIcons();
        }
      } catch (error) {
        console.error('Error updating order:', error);
        alert('Failed to update order. Please try again.');
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i data-lucide="check-circle"></i> Save Changes';
        if (typeof lucide !== 'undefined') lucide.createIcons();
      }
    });
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Initialize
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>

<%- include('partials/footer') %>
