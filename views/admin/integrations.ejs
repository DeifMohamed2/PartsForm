<%- include('partials/header') %>
<link rel="stylesheet" href="/css/adminCSS/admin-dashboard.css">
<link rel="stylesheet" href="/css/adminCSS/admin-integrations.css">
<link rel="stylesheet" href="/css/adminCSS/sync-details-panel.css">
</head>
<body class="<%= typeof currentModule !== 'undefined' && currentModule ? 'module-' + currentModule : '' %>">
  <div class="admin-wrapper">
    <%- include('partials/sidebar', { activePage: 'integrations', currentModule: currentModule }) %>
    
    <main class="admin-main">
      <%- include('partials/topbar', { pageTitle: 'Integrations', currentModule: currentModule }) %>
      
      <div class="admin-content">
        <!-- Module-Specific Integrations View -->
        <div class="integrations-module-view">
          <!-- Simplified Breadcrumb (Removed selection link) -->
          <div class="integrations-breadcrumb">
            <span class="breadcrumb-item"><i data-lucide="plug"></i> Integrations</span>
            <i data-lucide="chevron-right"></i>
            <span><%= moduleConfig.name %> Connections</span>
          </div>

          <!-- Module Header -->
          <div class="module-header">
            <div class="module-header-icon <%= currentModule %>">
              <i data-lucide="<%= moduleConfig.icon %>"></i>
            </div>
            <div class="module-header-info">
              <h1><%= moduleConfig.name %> Integrations</h1>
              <p>Manage FTP connections, API integrations, and data synchronization</p>
            </div>
            <div class="module-header-actions">
              <button class="admin-btn admin-btn-secondary" onclick="syncAllSources()">
                <i data-lucide="refresh-cw"></i>
                Sync All
              </button>
              <a href="/admin/integrations/create?module=<%= currentModule %>" class="admin-btn admin-btn-primary">
                <i data-lucide="plus"></i>
                Add Connection
              </a>
            </div>
          </div>

          <!-- Connection Stats -->
          <div class="connection-stats-row">
            <div class="conn-stat-card">
              <div class="conn-stat-icon green">
                <i data-lucide="check-circle"></i>
              </div>
              <div class="conn-stat-content">
                <span class="conn-stat-value"><%= typeof stats !== 'undefined' ? stats.activeConnections : 0 %></span>
                <span class="conn-stat-label">Active Connections</span>
              </div>
            </div>
            <div class="conn-stat-card">
              <div class="conn-stat-icon blue">
                <i data-lucide="database"></i>
              </div>
              <div class="conn-stat-content">
                <span class="conn-stat-value"><%= typeof stats !== 'undefined' && stats.totalRecords ? (stats.totalRecords >= 1000000 ? (stats.totalRecords / 1000000).toFixed(1) + 'M' : stats.totalRecords >= 1000 ? (stats.totalRecords / 1000).toFixed(0) + 'K' : stats.totalRecords) : '0' %></span>
                <span class="conn-stat-label">Total Parts</span>
              </div>
            </div>
            <div class="conn-stat-card">
              <div class="conn-stat-icon purple">
                <i data-lucide="clock"></i>
              </div>
              <div class="conn-stat-content">
                <span class="conn-stat-value"><%= typeof stats !== 'undefined' && stats.lastSync ? (function() { var d = new Date(stats.lastSync); var now = new Date(); var diff = Math.floor((now - d) / 60000); if (diff < 60) return diff + ' min ago'; if (diff < 1440) return Math.floor(diff / 60) + 'h ago'; return Math.floor(diff / 1440) + 'd ago'; })() : 'Never' %></span>
                <span class="conn-stat-label">Last Sync</span>
              </div>
            </div>
            <div class="conn-stat-card">
              <div class="conn-stat-icon orange">
                <i data-lucide="calendar"></i>
              </div>
              <div class="conn-stat-content">
                <span class="conn-stat-value"><%= typeof stats !== 'undefined' ? stats.totalConnections : 0 %></span>
                <span class="conn-stat-label">Total Connections</span>
              </div>
            </div>
          </div>

          <!-- Tabs -->
          <div class="integrations-tabs">
            <button class="intg-tab active" data-tab="ftp">
              <i data-lucide="folder"></i>
              FTP Connections
            </button>
            <button class="intg-tab" data-tab="api">
              <i data-lucide="code"></i>
              API Connections
            </button>
            <button class="intg-tab" data-tab="sync">
              <i data-lucide="refresh-cw"></i>
              Sync History
            </button>
            <button class="intg-tab" data-tab="mapping">
              <i data-lucide="git-branch"></i>
              Field Mapping
            </button>
          </div>

          <!-- FTP Connections Tab -->
          <div class="intg-tab-content active" id="tab-ftp">
            <div class="connections-list">
              <% 
              var ftpConnections = (typeof integrations !== 'undefined' ? integrations : []).filter(function(i) { return i.type === 'ftp'; });
              if (ftpConnections.length === 0) { %>
              <div class="empty-connections" style="text-align: center; padding: 3rem; color: var(--admin-text-muted);">
                <i data-lucide="hard-drive" style="width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.5;"></i>
                <h3 style="margin-bottom: 0.5rem; color: var(--admin-text-secondary);">No FTP Connections</h3>
                <p style="margin-bottom: 1.5rem;">Add your first FTP connection to start importing parts data.</p>
                <a href="/admin/integrations/create?module=<%= currentModule %>" class="admin-btn admin-btn-primary">
                  <i data-lucide="plus"></i>
                  Add FTP Connection
                </a>
              </div>
              <% } else { %>
              <% ftpConnections.forEach(function(conn) { 
                var statusClass = conn.status === 'active' ? 'connected' : conn.status === 'error' ? 'error' : 'disconnected';
                var lastSyncText = 'Never';
                if (conn.lastSync && conn.lastSync.date) {
                  var d = new Date(conn.lastSync.date);
                  var now = new Date();
                  var diff = Math.floor((now - d) / 60000);
                  if (diff < 60) lastSyncText = diff + ' min ago';
                  else if (diff < 1440) lastSyncText = Math.floor(diff / 60) + 'h ago';
                  else lastSyncText = Math.floor(diff / 1440) + ' days ago';
                }
                var scheduleText = conn.syncSchedule && conn.syncSchedule.enabled ? conn.syncSchedule.frequency : 'Manual';
                var recordsText = conn.stats && conn.stats.totalRecords ? (conn.stats.totalRecords >= 1000000 ? (conn.stats.totalRecords / 1000000).toFixed(1) + 'M' : conn.stats.totalRecords >= 1000 ? Math.floor(conn.stats.totalRecords / 1000) + 'K' : conn.stats.totalRecords) : '0';
              %>
              <div class="connection-card <%= statusClass %>" data-id="<%= conn._id %>">
                <div class="conn-status-indicator"></div>
                <div class="conn-icon">
                  <i data-lucide="hard-drive"></i>
                </div>
                <div class="conn-main-info">
                  <h3><%= conn.name %></h3>
                  <div class="conn-details">
                    <span class="conn-detail"><i data-lucide="server"></i> <%= conn.ftp ? conn.ftp.host : 'N/A' %></span>
                    <span class="conn-detail"><i data-lucide="user"></i> <%= conn.ftp ? conn.ftp.username : 'N/A' %></span>
                  </div>
                </div>
                <div class="conn-stats">
                  <div class="conn-stat-mini">
                    <span class="value"><%= conn.stats && conn.stats.filesProcessed ? conn.stats.filesProcessed : 0 %></span>
                    <span class="label">Files</span>
                  </div>
                  <div class="conn-stat-mini">
                    <span class="value"><%= recordsText %></span>
                    <span class="label">Records</span>
                  </div>
                </div>
                <div class="conn-sync-info">
                  <% if (conn.status === 'error' && conn.lastSync && conn.lastSync.error) { %>
                  <span class="sync-error"><i data-lucide="alert-triangle"></i> <%= conn.lastSync.error.substring(0, 30) %></span>
                  <% } else { %>
                  <span class="sync-time"><i data-lucide="clock"></i> <%= lastSyncText %></span>
                  <% } %>
                  <span class="sync-schedule"><i data-lucide="refresh-cw"></i> <%= scheduleText %></span>
                </div>
                <div class="conn-actions">
                  <button class="conn-action-btn" title="Sync Now" onclick="syncConnection('<%= conn._id %>')">
                    <i data-lucide="refresh-cw"></i>
                  </button>
                  <button class="conn-action-btn" title="Test Connection" onclick="testConnection('<%= conn._id %>')">
                    <i data-lucide="play"></i>
                  </button>
                  <button class="conn-action-btn" title="Edit" onclick="editConnection('<%= conn._id %>')">
                    <i data-lucide="edit-2"></i>
                  </button>
                  <button class="conn-action-btn danger" title="Delete" onclick="deleteConnection('<%= conn._id %>', '<%= conn.name %>')">
                    <i data-lucide="trash-2"></i>
                  </button>
                </div>
              </div>

              <!-- Sync Details Panel -->
              <div class="sync-details-panel collapsed" id="sync-panel-<%= conn._id %>" data-integration-id="<%= conn._id %>">
                <div class="sync-panel-header" onclick="toggleSyncPanel(event, '<%= conn._id %>')">
                  <div class="sync-panel-left">
                    <div class="sync-panel-icon <%= conn.status === 'syncing' ? 'syncing' : conn.status === 'error' ? 'error' : '' %>">
                      <i data-lucide="<%= conn.status === 'syncing' ? 'loader-2' : conn.status === 'error' ? 'alert-circle' : 'download' %>"></i>
                    </div>
                    <div class="sync-panel-info">
                      <div class="sync-panel-title">
                        Sync Details
                        <span class="sync-status-badge <%= conn.status === 'syncing' ? 'syncing' : conn.status === 'error' ? 'error' : conn.lastSync ? 'completed' : 'pending' %>">
                          <i data-lucide="<%= conn.status === 'syncing' ? 'loader-2' : conn.status === 'error' ? 'x-circle' : 'check-circle' %>"></i>
                          <%= conn.status === 'syncing' ? 'Syncing' : conn.status === 'error' ? 'Error' : conn.lastSync ? 'Completed' : 'Pending' %>
                        </span>
                      </div>
                      <div class="sync-panel-subtitle">
                        <span class="sync-quick-stat">
                          <i data-lucide="file"></i>
                          <strong><%= conn.lastSync && conn.lastSync.files ? conn.lastSync.files.length : 0 %></strong> Files
                        </span>
                        <span class="sync-quick-stat">
                          <i data-lucide="database"></i>
                          <strong><%= conn.lastSync && conn.lastSync.recordsProcessed ? conn.lastSync.recordsProcessed : 0 %></strong> Records
                        </span>
                        <span class="sync-quick-stat">
                          <i data-lucide="clock"></i>
                          <strong><%= conn.lastSync && conn.lastSync.duration ? Math.ceil(conn.lastSync.duration / 1000) + 's' : '-' %></strong>
                        </span>
                      </div>
                    </div>
                  </div>
                  <div class="sync-panel-right">
                    <% if (conn.lastSync && conn.lastSync.files) { %>
                    <div class="sync-progress-mini">
                      <div class="sync-progress-mini-bar" style="width: 100%;"></div>
                    </div>
                    <% } %>
                    <div class="sync-toggle-icon">
                      <i data-lucide="chevron-down"></i>
                    </div>
                  </div>
                </div>

                <div class="sync-panel-content">
                  <div class="sync-content-inner">
                    <% if (conn.lastSync) { %>
                      <!-- Summary Grid -->
                      <div class="sync-summary-grid">
                        <div class="sync-summary-item">
                          <div class="sync-summary-value">
                            <i data-lucide="file"></i>
                            <%= conn.lastSync.files ? conn.lastSync.files.length : 0 %>
                          </div>
                          <div class="sync-summary-label">Files Processed</div>
                        </div>
                        <div class="sync-summary-item">
                          <div class="sync-summary-value">
                            <i data-lucide="database"></i>
                            <%= conn.lastSync.recordsProcessed || 0 %>
                          </div>
                          <div class="sync-summary-label">Total Records</div>
                        </div>
                        <div class="sync-summary-item">
                          <div class="sync-summary-value">
                            <%= conn.lastSync.recordsInserted || 0 %>
                          </div>
                          <div class="sync-summary-label">Inserted</div>
                        </div>
                        <div class="sync-summary-item">
                          <div class="sync-summary-value">
                            <%= conn.lastSync.recordsUpdated || 0 %>
                          </div>
                          <div class="sync-summary-label">Updated</div>
                        </div>
                      </div>

                      <!-- Files List -->
                      <% if (conn.lastSync.files && conn.lastSync.files.length > 0) { %>
                      <div>
                        <div class="sync-files-header">
                          <div class="sync-files-title">
                            <i data-lucide="file-text"></i>
                            Files
                          </div>
                          <div class="sync-files-count"><%= conn.lastSync.files.length %></div>
                        </div>
                        <div class="sync-files-list">
                          <% conn.lastSync.files.forEach(function(file) { 
                            var sizeFormatted = file.size > (1024 * 1024) 
                              ? (file.size / (1024 * 1024)).toFixed(2) + ' MB'
                              : file.size > 1024
                              ? (file.size / 1024).toFixed(2) + ' KB'
                              : file.size + ' B';
                          %>
                          <div class="sync-file-item">
                            <div class="sync-file-icon">
                              <i data-lucide="file-text"></i>
                            </div>
                            <div class="sync-file-info">
                              <div class="sync-file-name"><%= file.name %></div>
                              <div class="sync-file-stats">
                                <div class="sync-file-stat">
                                  <i data-lucide="hard-drive"></i>
                                  <strong><%= sizeFormatted %></strong>
                                </div>
                                <div class="sync-file-stat">
                                  <i data-lucide="database"></i>
                                  <strong><%= file.records || 0 %></strong> records
                                </div>
                              </div>
                              <div class="sync-file-progress">
                                <div class="sync-file-progress-bar" style="width: 100%;"></div>
                              </div>
                            </div>
                            <div class="sync-file-status">
                              <span class="sync-file-status-badge <%= file.status === 'success' ? 'completed' : 'pending' %>">
                                <i data-lucide="<%= file.status === 'success' ? 'check-circle' : 'loader-2' %>"></i>
                                <%= file.status === 'success' ? 'Completed' : 'Processing' %>
                              </span>
                            </div>
                          </div>
                          <% }); %>
                        </div>
                      </div>
                      <% } %>

                      <!-- Time Estimate -->
                      <div class="sync-time-estimate">
                        <div class="sync-time-estimate-content">
                          <div class="sync-time-estimate-icon">
                            <i data-lucide="clock"></i>
                          </div>
                          <div class="sync-time-estimate-info">
                            <h4>Sync Duration</h4>
                            <p>Last sync completed in <%= Math.ceil(conn.lastSync.duration / 1000) %>s</p>
                          </div>
                        </div>
                        <div class="sync-time-estimate-value">
                          <%= Math.ceil(conn.lastSync.duration / 1000) %>s
                        </div>
                      </div>

                      <% if (conn.lastSync.error) { %>
                      <div class="sync-error-message">
                        <strong>Sync Error</strong>
                        <p><%= conn.lastSync.error %></p>
                      </div>
                      <% } %>
                    <% } else { %>
                      <div style="text-align: center; padding: 2rem; color: var(--admin-text-muted);">
                        <i data-lucide="inbox" style="width: 40px; height: 40px; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>No sync data available yet. Click "Sync Now" to start synchronization.</p>
                      </div>
                    <% } %>
                  </div>
                </div>
              </div>
              <% }); %>
              <% } %>
            </div>
          </div>

          <!-- API Connections Tab -->
          <div class="intg-tab-content" id="tab-api">
            <div class="connections-list">
              <% 
              var apiConnections = (typeof integrations !== 'undefined' ? integrations : []).filter(function(i) { return i.type === 'api'; });
              if (apiConnections.length === 0) { %>
              <div class="empty-connections" style="text-align: center; padding: 3rem; color: var(--admin-text-muted);">
                <i data-lucide="code" style="width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.5;"></i>
                <h3 style="margin-bottom: 0.5rem; color: var(--admin-text-secondary);">No API Connections</h3>
                <p style="margin-bottom: 1.5rem;">Add your first REST API connection to fetch parts data.</p>
                <a href="/admin/integrations/create?module=<%= currentModule %>" class="admin-btn admin-btn-primary">
                  <i data-lucide="plus"></i>
                  Add API Connection
                </a>
              </div>
              <% } else { %>
              <% apiConnections.forEach(function(api) { 
                var statusClass = api.status === 'active' ? 'connected' : api.status === 'error' ? 'error' : 'disconnected';
                var lastCallText = 'Never';
                if (api.lastSync && api.lastSync.date) {
                  var d = new Date(api.lastSync.date);
                  var now = new Date();
                  var diff = Math.floor((now - d) / 60000);
                  if (diff < 60) lastCallText = diff + ' min ago';
                  else if (diff < 1440) lastCallText = Math.floor(diff / 60) + 'h ago';
                  else lastCallText = Math.floor(diff / 1440) + ' days ago';
                }
                var requestsText = api.stats && api.stats.totalRecords ? api.stats.totalRecords + '/day' : '0/day';
              %>
              <div class="connection-card <%= statusClass %>" data-id="<%= api._id %>">
                <div class="conn-status-indicator"></div>
                <div class="conn-icon api">
                  <i data-lucide="code"></i>
                </div>
                <div class="conn-main-info">
                  <h3><%= api.name %></h3>
                  <div class="conn-details">
                    <span class="conn-detail"><i data-lucide="link"></i> <%= api.api ? api.api.baseUrl : 'N/A' %></span>
                    <span class="conn-detail"><i data-lucide="key"></i> <%= api.api ? api.api.authType : 'N/A' %></span>
                  </div>
                </div>
                <div class="conn-stats">
                  <div class="conn-stat-mini">
                    <span class="value"><%= requestsText %></span>
                    <span class="label">Requests</span>
                  </div>
                </div>
                <div class="conn-sync-info">
                  <span class="sync-time"><i data-lucide="clock"></i> <%= lastCallText %></span>
                </div>
                <div class="conn-actions">
                  <button class="conn-action-btn" title="Test API" onclick="testConnection('<%= api._id %>')">
                    <i data-lucide="play"></i>
                  </button>
                  <button class="conn-action-btn" title="Sync Data" onclick="syncConnection('<%= api._id %>')">
                    <i data-lucide="refresh-cw"></i>
                  </button>
                  <button class="conn-action-btn" title="Edit" onclick="editConnection('<%= api._id %>')">
                    <i data-lucide="edit-2"></i>
                  </button>
                  <button class="conn-action-btn danger" title="Delete" onclick="deleteConnection('<%= api._id %>', '<%= api.name %>')">
                    <i data-lucide="trash-2"></i>
                  </button>
                </div>
              </div>
              <% }); %>
              <% } %>

              <button class="add-connection-btn" onclick="window.location.href='/admin/integrations/create?module=<%= currentModule %>'">
                <i data-lucide="plus"></i>
                <span>Add API Connection</span>
              </button>
            </div>
          </div>

          <!-- Sync History Tab -->
          <div class="intg-tab-content" id="tab-sync">
            <div class="sync-history-table">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Source</th>
                    <th>Type</th>
                    <th>Started</th>
                    <th>Duration</th>
                    <th>Records</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% 
                  // Build sync history from all integrations
                  var syncHistory = [];
                  if (typeof integrations !== 'undefined') {
                    integrations.forEach(function(intg) {
                      if (intg.lastSync && intg.lastSync.date) {
                        var startedText = 'Unknown';
                        var d = new Date(intg.lastSync.date);
                        var now = new Date();
                        var diff = Math.floor((now - d) / 60000);
                        if (diff < 60) startedText = diff + ' min ago';
                        else if (diff < 1440) startedText = Math.floor(diff / 60) + ' hours ago';
                        else startedText = Math.floor(diff / 1440) + ' days ago';
                        
                        var durationText = intg.lastSync.duration ? (Math.floor(intg.lastSync.duration / 60000) + 'm ' + Math.floor((intg.lastSync.duration % 60000) / 1000) + 's') : '--';
                        var recordsText = intg.lastSync.recordsProcessed ? intg.lastSync.recordsProcessed.toLocaleString() : '0';
                        
                        syncHistory.push({
                          source: intg.name,
                          type: intg.type.toUpperCase(),
                          started: startedText,
                          duration: durationText,
                          records: recordsText,
                          status: intg.lastSync.success ? 'success' : 'failed',
                          error: intg.lastSync.error || null,
                          id: intg._id
                        });
                      }
                    });
                  }
                  
                  if (syncHistory.length === 0) { %>
                  <tr>
                    <td colspan="7" style="text-align: center; padding: 2rem; color: var(--admin-text-muted);">
                      No sync history yet. Run a sync on one of your connections to see history here.
                    </td>
                  </tr>
                  <% } else { %>
                  <% syncHistory.forEach(function(sync) { %>
                  <tr>
                    <td><strong><%= sync.source %></strong></td>
                    <td><span class="type-badge <%= sync.type.toLowerCase() %>"><%= sync.type %></span></td>
                    <td><%= sync.started %></td>
                    <td><%= sync.duration %></td>
                    <td><%= sync.records %></td>
                    <td>
                      <span class="status-badge <%= sync.status %>">
                        <% if (sync.status === 'success') { %>
                        <i data-lucide="check-circle"></i>
                        <% } else { %>
                        <i data-lucide="x-circle"></i>
                        <% } %>
                        <%= sync.status.charAt(0).toUpperCase() + sync.status.slice(1) %>
                      </span>
                    </td>
                    <td>
                      <button class="table-action-btn" title="View Details" onclick="viewSyncDetails('<%= sync.id %>')">
                        <i data-lucide="eye"></i>
                      </button>
                      <% if (sync.status === 'failed') { %>
                      <button class="table-action-btn" title="Retry" onclick="syncConnection('<%= sync.id %>')">
                        <i data-lucide="refresh-cw"></i>
                      </button>
                      <% } %>
                    </td>
                  </tr>
                  <% }); %>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Field Mapping Tab -->
          <div class="intg-tab-content" id="tab-mapping">
            <div class="mapping-info">
              <div class="mapping-header">
                <h3><i data-lucide="git-branch"></i> CSV Field Mapping</h3>
                <p>Configure how CSV columns are mapped to database fields</p>
              </div>

              <div class="mapping-grid">
                <div class="mapping-card">
                  <div class="mapping-card-header">
                    <h4>Part Number</h4>
                    <span class="mapping-required">Required</span>
                  </div>
                  <div class="mapping-sources">
                    <span class="mapping-tag">Part Number</span>
                    <span class="mapping-tag">PartNumber</span>
                    <span class="mapping-tag">part_number</span>
                    <span class="mapping-tag">SKU</span>
                    <span class="mapping-tag">P/N</span>
                  </div>
                </div>

                <div class="mapping-card">
                  <div class="mapping-card-header">
                    <h4>Description</h4>
                    <span class="mapping-optional">Optional</span>
                  </div>
                  <div class="mapping-sources">
                    <span class="mapping-tag">Description</span>
                    <span class="mapping-tag">Product Description</span>
                    <span class="mapping-tag">Item Description</span>
                  </div>
                </div>

                <div class="mapping-card">
                  <div class="mapping-card-header">
                    <h4>Supplier</h4>
                    <span class="mapping-optional">Optional</span>
                  </div>
                  <div class="mapping-sources">
                    <span class="mapping-tag">Supplier</span>
                    <span class="mapping-tag">Vendor</span>
                    <span class="mapping-tag">Manufacturer</span>
                  </div>
                </div>

                <div class="mapping-card">
                  <div class="mapping-card-header">
                    <h4>Price</h4>
                    <span class="mapping-optional">Optional</span>
                  </div>
                  <div class="mapping-sources">
                    <span class="mapping-tag">Price</span>
                    <span class="mapping-tag">Cost</span>
                    <span class="mapping-tag">Unit Price</span>
                  </div>
                </div>
              </div>

              <button class="admin-btn admin-btn-secondary" style="margin-top: 1.5rem;">
                <i data-lucide="plus"></i>
                Add Custom Mapping
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add Connection Modal -->
  <div class="modal-overlay" id="addConnectionModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-icon">
          <i data-lucide="plus"></i>
        </div>
        <div>
          <h3>Add FTP Connection</h3>
          <p>Configure a new FTP data source</p>
        </div>
        <button class="modal-close" onclick="closeModal('addConnectionModal')">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group">
            <label>Connection Name</label>
            <input type="text" class="form-input" placeholder="e.g., Main Supplier FTP">
          </div>
          <div class="form-group">
            <label>FTP Host</label>
            <input type="text" class="form-input" placeholder="ftp.example.com">
          </div>
          <div class="form-group">
            <label>Port</label>
            <input type="number" class="form-input" value="21">
          </div>
          <div class="form-group">
            <label>Username</label>
            <input type="text" class="form-input" placeholder="ftp_user">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          </div>
          <div class="form-group">
            <label>Remote Path</label>
            <input type="text" class="form-input" placeholder="/data/csv/" value="/">
          </div>
          <div class="form-group">
            <label>Sync Schedule</label>
            <select class="form-input">
              <option>Every 6 hours</option>
              <option>Every 12 hours</option>
              <option>Daily</option>
              <option>Weekly</option>
              <option>Manual only</option>
            </select>
          </div>
          <div class="form-group">
            <label>File Pattern</label>
            <input type="text" class="form-input" placeholder="*.csv" value="*.csv">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="admin-btn admin-btn-secondary" onclick="closeModal('addConnectionModal')">Cancel</button>
        <button class="admin-btn" onclick="testNewConnection()" style="background: var(--admin-border); color: var(--admin-text-primary);">
          <i data-lucide="play"></i>
          Test Connection
        </button>
        <button class="admin-btn admin-btn-primary" onclick="saveConnection()">
          <i data-lucide="save"></i>
          Save Connection
        </button>
      </div>
    </div>
  </div>

  <!-- System Config Modal -->
  <div class="modal-overlay" id="systemConfigModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-icon" id="sysConfigIcon">
          <i data-lucide="settings"></i>
        </div>
        <div>
          <h3 id="sysConfigTitle">System Configuration</h3>
          <p id="sysConfigSubtitle">Configure connection settings</p>
        </div>
        <button class="modal-close" onclick="closeModal('systemConfigModal')">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body" id="sysConfigBody">
        <!-- Content injected via JS -->
      </div>
      <div class="modal-footer">
        <button class="admin-btn admin-btn-secondary" onclick="closeModal('systemConfigModal')">Cancel</button>
        <button class="admin-btn admin-btn-primary">
          <i data-lucide="save"></i>
          Save Changes
        </button>
      </div>
    </div>
  </div>

  <!-- Sync Progress Modal -->
  <div class="modal-overlay" id="syncProgressModal">
    <div class="modal-content" style="max-width: 480px;">
      <div class="modal-header">
        <div class="modal-icon sync-icon">
          <i data-lucide="refresh-cw" class="spin-icon"></i>
        </div>
        <div>
          <h3 id="syncModalTitle">Syncing Connection</h3>
          <p id="syncModalSubtitle">Please wait...</p>
        </div>
      </div>
      <div class="modal-body" style="text-align: center; padding: 2rem;">
        <div class="sync-progress">
          <div class="sync-progress-bar"></div>
        </div>
        <div class="sync-status">
          <p id="syncStatusText">Connecting to FTP server...</p>
        </div>
        <p id="syncCurrentFile" style="font-size: 0.8rem; color: var(--admin-text-muted); margin-top: 0.5rem; word-break: break-all; display: none;"></p>
        <div class="sync-details" style="margin-top: 1.5rem; text-align: left; background: var(--admin-bg-secondary); padding: 1rem; border-radius: 10px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="color: var(--admin-text-muted); font-size: 0.85rem;">Files Processed</span>
            <strong id="syncFilesCount">--</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="color: var(--admin-text-muted); font-size: 0.85rem;">Records Processed</span>
            <strong id="syncRecordsCount">--</strong>
          </div>
          <div id="syncErrorsRow" style="display: none; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="color: var(--admin-text-muted); font-size: 0.85rem;">Skipped/Errors</span>
            <strong id="syncErrorsCount" style="color: #f59e0b;">0</strong>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: var(--admin-text-muted); font-size: 0.85rem;">Elapsed Time</span>
            <strong id="syncElapsedTime">0s</strong>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="justify-content: center;">
        <button class="admin-btn admin-btn-secondary" onclick="closeModal('syncProgressModal')">
          <i data-lucide="x"></i>
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="deleteConfirmModal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <div class="modal-icon" style="background: rgba(239, 68, 68, 0.12); color: #ef4444;">
          <i data-lucide="trash-2"></i>
        </div>
        <div>
          <h3>Delete Connection</h3>
          <p>This action cannot be undone</p>
        </div>
        <button class="modal-close" onclick="closeModal('deleteConfirmModal')">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body" style="padding: 1.5rem;">
        <p style="color: var(--admin-text-secondary); margin: 0;">Are you sure you want to delete <strong id="deleteConnName">this connection</strong>? All sync history and configuration will be permanently removed.</p>
      </div>
      <div class="modal-footer">
        <button class="admin-btn admin-btn-secondary" onclick="closeModal('deleteConfirmModal')">
          Cancel
        </button>
        <button class="admin-btn" style="background: #ef4444; color: white;" onclick="confirmDelete()">
          <i data-lucide="trash-2"></i>
          Delete Connection
        </button>
      </div>
    </div>
  </div>

  <script>
    // Current module
    const currentModule = '<%= typeof currentModule !== "undefined" ? currentModule : "automotive-parts" %>';
    
    // Tab switching
    document.querySelectorAll('.intg-tab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        var tabName = this.dataset.tab;
        document.querySelectorAll('.intg-tab').forEach(function(t) { t.classList.remove('active'); });
        document.querySelectorAll('.intg-tab-content').forEach(function(c) { c.classList.remove('active'); });
        this.classList.add('active');
        document.getElementById('tab-' + tabName).classList.add('active');
        if (typeof lucide !== 'undefined') lucide.createIcons();
      });
    });

    // Modal functions
    function openAddConnectionModal() {
      window.location.href = '/admin/integrations/create?module=' + currentModule;
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function openSystemConfig(type) {
      var modal = document.getElementById('systemConfigModal');
      var title = document.getElementById('sysConfigTitle');
      var subtitle = document.getElementById('sysConfigSubtitle');
      var body = document.getElementById('sysConfigBody');
      
      if (type === 'elasticsearch') {
        title.textContent = 'Elasticsearch Configuration';
        subtitle.textContent = 'Configure search engine connection';
        body.innerHTML = '<div class="form-grid"><div class="form-group"><label>Node URL</label><input type="text" class="form-input" value="http://localhost:9200"></div><div class="form-group"><label>Index Name</label><input type="text" class="form-input" value="parts_index"></div><div class="form-group"><label>Username</label><input type="text" class="form-input" placeholder="elastic"></div><div class="form-group"><label>Password</label><input type="password" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div></div>';
      } else if (type === 'mongodb') {
        title.textContent = 'MongoDB Configuration';
        subtitle.textContent = 'Configure database connection';
        body.innerHTML = '<div class="form-grid"><div class="form-group full-width"><label>Connection String</label><input type="text" class="form-input" value="mongodb://localhost:27017"></div><div class="form-group"><label>Database Name</label><input type="text" class="form-input" value="csv_data_db"></div><div class="form-group"><label>Pool Size</label><input type="number" class="form-input" value="50"></div></div>';
      } else if (type === 'redis') {
        title.textContent = 'Redis Cache Configuration';
        subtitle.textContent = 'Configure caching layer';
        body.innerHTML = '<div class="form-grid"><div class="form-group"><label>Host</label><input type="text" class="form-input" value="localhost"></div><div class="form-group"><label>Port</label><input type="number" class="form-input" value="6379"></div><div class="form-group"><label>Password</label><input type="password" class="form-input" placeholder="Optional"></div><div class="form-group"><label>Database</label><input type="number" class="form-input" value="0"></div></div>';
      }
      
      modal.classList.add('active');
    }

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });

    // Show notification - Enhanced modern toast design
    function showNotification(message, type) {
      // Use the global notificationManager from /js/notifications.js
      if (window.notificationManager) {
        window.notificationManager.show(message, type);
      }
    }

    // Sync a connection with real-time progress polling
    async function syncConnection(id) {
      document.getElementById('syncModalTitle').textContent = 'Syncing Connection';
      document.getElementById('syncModalSubtitle').textContent = 'Downloading and processing files...';
      document.getElementById('syncStatusText').textContent = 'Starting sync...';
      document.getElementById('syncFilesCount').textContent = '0';
      document.getElementById('syncRecordsCount').textContent = '0';
      document.getElementById('syncElapsedTime').textContent = '0s';
      document.getElementById('syncCurrentFile').textContent = '';
      document.getElementById('syncCurrentFile').style.display = 'none';
      document.getElementById('syncErrorsRow').style.display = 'none';
      document.getElementById('syncErrorsCount').textContent = '0';
      document.querySelector('.sync-progress-bar').style.background = 'var(--admin-accent)';
      document.getElementById('syncProgressModal').classList.add('active');
      if (typeof lucide !== 'undefined') lucide.createIcons();
      
      var startTime = Date.now();
      var progressPollInterval = null;
      var elapsedInterval = null;
      
      // Update elapsed time
      elapsedInterval = setInterval(function() {
        var elapsed = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('syncElapsedTime').textContent = elapsed + 's';
      }, 1000);
      
      // Poll for progress updates
      async function pollProgress() {
        try {
          const response = await fetch('/admin/api/integrations/' + id + '/progress');
          const data = await response.json();
          
          if (data.success && data.progress) {
            const p = data.progress;
            
            // Update status text
            if (p.message) {
              document.getElementById('syncStatusText').textContent = p.message;
            } else if (p.phase) {
              const phaseMessages = {
                'connecting': 'Connecting to server...',
                'listing': 'Listing files on server...',
                'downloading': 'Downloading files...',
                'parsing': 'Processing CSV data...',
                'fetching': 'Fetching data from API...',
                'indexing': 'Indexing records...',
                'done': 'Sync completed!',
                'failed': 'Sync failed'
              };
              document.getElementById('syncStatusText').textContent = phaseMessages[p.phase] || p.phase;
            }
            
            // Update subtitle based on phase
            if (p.phase === 'downloading' || p.phase === 'parsing') {
              document.getElementById('syncModalSubtitle').textContent = 'Processing files...';
            } else if (p.phase === 'done') {
              document.getElementById('syncModalSubtitle').textContent = 'Sync completed';
            }
            
            // Show current file being processed
            if (p.currentFile) {
              const currentFileEl = document.getElementById('syncCurrentFile');
              currentFileEl.textContent = 'ðŸ“„ ' + p.currentFile;
              currentFileEl.style.display = 'block';
            }
            
            // Update files count
            if (p.filesProcessed !== undefined && p.filesTotal !== undefined) {
              document.getElementById('syncFilesCount').textContent = p.filesProcessed + '/' + p.filesTotal;
            } else if (p.filesTotal !== undefined) {
              document.getElementById('syncFilesCount').textContent = '0/' + p.filesTotal;
            }
            
            // Update records count
            if (p.recordsProcessed !== undefined) {
              document.getElementById('syncRecordsCount').textContent = p.recordsProcessed.toLocaleString();
            }
            
            // Show errors/skipped count
            if (p.errors && p.errors.length > 0) {
              document.getElementById('syncErrorsRow').style.display = 'flex';
              document.getElementById('syncErrorsCount').textContent = p.errors.length;
            }
            
            // Check if completed
            if (p.status === 'completed' || p.status === 'error') {
              clearInterval(progressPollInterval);
              clearInterval(elapsedInterval);
              
              // Hide current file
              document.getElementById('syncCurrentFile').style.display = 'none';
              
              if (p.status === 'completed') {
                document.getElementById('syncModalSubtitle').textContent = 'Sync completed successfully';
                document.getElementById('syncStatusText').textContent = 'Sync completed successfully!';
                document.querySelector('.sync-progress-bar').style.background = '#10b981';
                document.querySelector('.spin-icon').classList.remove('spin-icon');
                // Update final counts
                if (p.recordsInserted !== undefined) {
                  document.getElementById('syncRecordsCount').textContent = 
                    p.recordsInserted.toLocaleString() + ' inserted, ' + 
                    (p.recordsUpdated || 0).toLocaleString() + ' updated';
                }
              } else {
                document.getElementById('syncModalSubtitle').textContent = 'Sync failed';
                document.getElementById('syncStatusText').textContent = 'Sync failed: ' + (p.error || 'Unknown error');
                document.querySelector('.sync-progress-bar').style.background = '#ef4444';
                document.querySelector('.spin-icon').classList.remove('spin-icon');
              }
              
              // Reload page after a delay
              setTimeout(() => {
                window.location.reload();
              }, 3000);
            }
          } else if (!data.isSyncing && data.lastSync) {
            // Sync finished, check last sync status
            clearInterval(progressPollInterval);
            clearInterval(elapsedInterval);
            
            // Hide current file
            document.getElementById('syncCurrentFile').style.display = 'none';
            
            if (data.lastSync.status === 'success') {
              document.getElementById('syncModalSubtitle').textContent = 'Sync completed successfully';
              document.getElementById('syncStatusText').textContent = 'Sync completed successfully!';
              document.getElementById('syncRecordsCount').textContent = 
                (data.lastSync.recordsInserted || 0).toLocaleString() + ' inserted, ' +
                (data.lastSync.recordsUpdated || 0).toLocaleString() + ' updated';
              document.querySelector('.sync-progress-bar').style.background = '#10b981';
            } else {
              document.getElementById('syncModalSubtitle').textContent = 'Sync failed';
              document.getElementById('syncStatusText').textContent = 'Sync failed: ' + (data.lastSync.error || 'Unknown error');
              document.querySelector('.sync-progress-bar').style.background = '#ef4444';
            }
            
            setTimeout(() => {
              window.location.reload();
            }, 3000);
          }
        } catch (error) {
          console.error('Error polling progress:', error);
        }
      }

      try {
        // Start the sync
        const response = await fetch('/admin/api/integrations/' + id + '/sync', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Start polling for progress
          progressPollInterval = setInterval(pollProgress, 1000);
          // Initial poll
          setTimeout(pollProgress, 500);
        } else {
          clearInterval(elapsedInterval);
          document.getElementById('syncStatusText').textContent = 'Failed to start sync: ' + (result.error || 'Unknown error');
          document.querySelector('.sync-progress-bar').style.background = '#ef4444';
        }
      } catch (error) {
        clearInterval(elapsedInterval);
        document.getElementById('syncStatusText').textContent = 'Sync failed: ' + error.message;
        document.querySelector('.sync-progress-bar').style.background = '#ef4444';
      }
    }
    
    // Test a connection
    async function testConnection(id) {
      document.getElementById('syncModalTitle').textContent = 'Testing Connection';
      document.getElementById('syncModalSubtitle').textContent = 'Verifying credentials...';
      document.getElementById('syncStatusText').textContent = 'Attempting to connect...';
      document.getElementById('syncFilesCount').textContent = '--';
      document.getElementById('syncRecordsCount').textContent = '--';
      document.getElementById('syncElapsedTime').textContent = '0s';
      document.querySelector('.sync-progress-bar').style.background = 'var(--admin-accent)';
      document.getElementById('syncProgressModal').classList.add('active');
      if (typeof lucide !== 'undefined') lucide.createIcons();

      try {
        // Get the integration details first
        const getResponse = await fetch('/admin/api/integrations/' + id);
        const integrationData = await getResponse.json();
        
        if (!integrationData.success) {
          throw new Error('Failed to get integration details');
        }

        // Use the integration object from response
        const integration = integrationData.integration;

        const response = await fetch('/admin/api/integrations/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(integration)
        });
        
        const result = await response.json();
        
        if (result.success) {
          document.getElementById('syncModalSubtitle').textContent = 'Test completed successfully';
          document.getElementById('syncStatusText').textContent = 'Connection test successful!';
          if (result.data && result.data.filesCount !== undefined) {
            document.getElementById('syncFilesCount').textContent = result.data.filesCount;
          }
          if (result.estimatedRecords) {
            document.getElementById('syncRecordsCount').textContent = '~' + result.estimatedRecords;
          }
          document.querySelector('.sync-progress-bar').style.background = '#10b981';
        } else {
          document.getElementById('syncModalSubtitle').textContent = 'Test failed';
          document.getElementById('syncStatusText').textContent = 'Connection failed: ' + (result.error || 'Unknown error');
          document.querySelector('.sync-progress-bar').style.background = '#ef4444';
        }
      } catch (error) {
        document.getElementById('syncModalSubtitle').textContent = 'Test failed';
        document.getElementById('syncStatusText').textContent = 'Connection failed: ' + error.message;
        document.querySelector('.sync-progress-bar').style.background = '#ef4444';
      }
    }
    
    // Edit connection
    function editConnection(id) {
      window.location.href = '/admin/integrations/edit/' + id + '?module=' + currentModule;
    }
    
    // Delete connection
    var pendingDeleteId = null;
    var pendingDeleteName = null;
    
    function deleteConnection(id, name) {
      pendingDeleteId = id;
      pendingDeleteName = name || 'this connection';
      document.getElementById('deleteConnName').textContent = pendingDeleteName;
      document.getElementById('deleteConfirmModal').classList.add('active');
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    
    async function confirmDelete() {
      if (!pendingDeleteId) return;
      
      closeModal('deleteConfirmModal');
      
      try {
        const response = await fetch('/admin/api/integrations/' + pendingDeleteId, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
          showNotification('Connection deleted successfully', 'success');
          // Remove the card from the DOM
          const card = document.querySelector('.connection-card[data-id="' + pendingDeleteId + '"]');
          if (card) {
            card.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => card.remove(), 300);
          }
        } else {
          showNotification('Failed to delete: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showNotification('Failed to delete: ' + error.message, 'error');
      }
      
      pendingDeleteId = null;
      pendingDeleteName = null;
    }
    
    // Sync all sources
    async function syncAllSources() {
      document.getElementById('syncModalTitle').textContent = 'Syncing All Sources';
      document.getElementById('syncModalSubtitle').textContent = 'Processing all enabled connections...';
      document.getElementById('syncStatusText').textContent = 'Starting sync...';
      document.getElementById('syncFilesCount').textContent = '0';
      document.getElementById('syncRecordsCount').textContent = '0';
      document.getElementById('syncElapsedTime').textContent = '0s';
      document.querySelector('.sync-progress-bar').style.background = 'var(--admin-accent)';
      document.getElementById('syncProgressModal').classList.add('active');
      if (typeof lucide !== 'undefined') lucide.createIcons();
      
      var startTime = Date.now();
      var updateInterval = setInterval(function() {
        var elapsed = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('syncElapsedTime').textContent = elapsed + 's';
      }, 1000);

      try {
        // Get all integrations and sync them one by one
        const response = await fetch('/admin/api/integrations');
        const integrations = await response.json();
        
        if (!integrations.success || !integrations.data) {
          throw new Error('Failed to get integrations');
        }

        let totalFiles = 0;
        let totalRecords = 0;
        let syncedCount = 0;
        const enabledIntegrations = integrations.data.filter(i => i.isEnabled);

        for (const integration of enabledIntegrations) {
          document.getElementById('syncStatusText').textContent = `Syncing ${integration.name}... (${++syncedCount}/${enabledIntegrations.length})`;
          
          const syncResponse = await fetch('/admin/api/integrations/' + integration._id + '/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          const syncResult = await syncResponse.json();
          
          if (syncResult.success && syncResult.data) {
            totalFiles += syncResult.data.filesProcessed || 0;
            totalRecords += syncResult.data.recordsProcessed || 0;
            document.getElementById('syncFilesCount').textContent = totalFiles;
            document.getElementById('syncRecordsCount').textContent = totalRecords.toLocaleString();
          }
        }

        clearInterval(updateInterval);
        document.getElementById('syncStatusText').textContent = 'All syncs completed!';
        document.querySelector('.sync-progress-bar').style.background = '#10b981';
        
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      } catch (error) {
        clearInterval(updateInterval);
        document.getElementById('syncStatusText').textContent = 'Sync failed: ' + error.message;
        document.querySelector('.sync-progress-bar').style.background = '#ef4444';
      }
    }
    
    // View sync details
    function viewSyncDetails(id) {
      // For now, just redirect to edit page
      editConnection(id);
    }

    // Toggle sync details panel
    function toggleSyncPanel(event, id) {
      event.stopPropagation();
      const panel = document.getElementById('sync-panel-' + id);
      const header = panel.querySelector('.sync-panel-header');
      const content = panel.querySelector('.sync-panel-content');
      
      if (panel.classList.contains('expanded')) {
        panel.classList.remove('expanded');
        header.classList.remove('expanded');
        content.classList.remove('expanded');
      } else {
        // Close all other panels first
        document.querySelectorAll('.sync-details-panel.expanded').forEach(p => {
          p.classList.remove('expanded');
          p.querySelector('.sync-panel-header').classList.remove('expanded');
          p.querySelector('.sync-panel-content').classList.remove('expanded');
        });
        
        panel.classList.add('expanded');
        header.classList.add('expanded');
        content.classList.add('expanded');
        
        // Load fresh sync details
        loadSyncDetails(id);
      }
      
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    
    // Load sync details via API
    async function loadSyncDetails(id) {
      try {
        const response = await fetch('/admin/api/integrations/' + id + '/sync-details');
        const data = await response.json();
        
        if (data.success) {
          updateSyncPanelUI(id, data);
        }
      } catch (error) {
        console.error('Error loading sync details:', error);
      }
    }
    
    // Update sync panel UI with new data
    function updateSyncPanelUI(id, data) {
      const panel = document.getElementById('sync-panel-' + id);
      if (!panel) return;
      
      // Update status badge
      const statusBadge = panel.querySelector('.sync-status-badge');
      if (statusBadge && data.integration) {
        const status = data.integration.status;
        statusBadge.className = 'sync-status-badge ' + (status === 'syncing' ? 'syncing' : status === 'error' ? 'error' : 'completed');
      }
      
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    
    // Check if we just created a new connection that should start syncing
    const urlParams = new URLSearchParams(window.location.search);
    const syncStartedId = urlParams.get('syncStarted');
    if (syncStartedId) {
      showNotification('Auto-sync started for new connection!', 'success');
      // Expand the sync panel for this connection
      setTimeout(() => {
        const panel = document.getElementById('sync-panel-' + syncStartedId);
        if (panel) {
          panel.classList.add('expanded');
          const header = panel.querySelector('.sync-panel-header');
          const content = panel.querySelector('.sync-panel-content');
          if (header) header.classList.add('expanded');
          if (content) content.classList.add('expanded');
          panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Start polling for sync status
          pollSyncStatus(syncStartedId);
        }
        if (typeof lucide !== 'undefined') lucide.createIcons();
      }, 500);
      
      // Clean up URL
      const newUrl = window.location.pathname + window.location.search.replace(/[?&]syncStarted=[^&]+/, '').replace(/^&/, '?');
      window.history.replaceState({}, '', newUrl.replace(/\?$/, ''));
    }
    
    // Poll sync status for live updates
    function pollSyncStatus(id) {
      let pollInterval = setInterval(async () => {
        try {
          const response = await fetch('/admin/api/integrations/' + id);
          const data = await response.json();
          
          if (data.success && data.integration) {
            const integration = data.integration;
            
            // Update the sync panel status
            const panel = document.getElementById('sync-panel-' + id);
            if (panel) {
              const statusBadge = panel.querySelector('.sync-status-badge');
              const panelIcon = panel.querySelector('.sync-panel-icon');
              
              if (integration.status === 'syncing') {
                if (statusBadge) {
                  statusBadge.className = 'sync-status-badge syncing';
                  statusBadge.innerHTML = '<i data-lucide="loader-2"></i> Syncing';
                }
                if (panelIcon) {
                  panelIcon.classList.add('syncing');
                }
              } else {
                // Sync completed
                clearInterval(pollInterval);
                
                if (statusBadge) {
                  statusBadge.className = 'sync-status-badge ' + (integration.status === 'error' ? 'error' : 'completed');
                  statusBadge.innerHTML = '<i data-lucide="' + (integration.status === 'error' ? 'x-circle' : 'check-circle') + '"></i> ' + 
                    (integration.status === 'error' ? 'Error' : 'Completed');
                }
                if (panelIcon) {
                  panelIcon.classList.remove('syncing');
                }
                
                showNotification(integration.status === 'error' ? 'Sync failed!' : 'Sync completed successfully!', 
                  integration.status === 'error' ? 'error' : 'success');
                
                // Reload page after a delay to show updated data
                setTimeout(() => window.location.reload(), 2000);
              }
              
              if (typeof lucide !== 'undefined') lucide.createIcons();
            }
          }
        } catch (error) {
          console.error('Error polling sync status:', error);
          clearInterval(pollInterval);
        }
      }, 2000); // Poll every 2 seconds
      
      // Stop polling after 5 minutes
      setTimeout(() => clearInterval(pollInterval), 300000);
    }

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
      .spin-icon {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(style);
  </script>

<%- include('partials/footer') %>
