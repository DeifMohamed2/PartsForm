<%- include('partials/header') %>
<link rel="stylesheet" href="/css/adminCSS/admin-dashboard.css">
<link rel="stylesheet" href="/css/adminCSS/admin-orders.css">
<style>
  /* Override - All icons with colored backgrounds should be white */
  .status-badge i,
  .status-badge svg,
  .priority-badge i,
  .priority-badge svg,
  .timeline-step.active .timeline-icon i,
  .timeline-step.active .timeline-icon svg,
  .timeline-step.completed .timeline-icon i,
  .timeline-step.completed .timeline-icon svg,
  .timeline-step.cancelled .timeline-icon i,
  .timeline-step.cancelled .timeline-icon svg,
  .activity-icon i,
  .activity-icon svg,
  .meta-icon i,
  .meta-icon svg,
  .item-image i,
  .item-image svg,
  .customer-avatar i,
  .customer-avatar svg {
    color: #fff !important;
    stroke: #fff !important;
  }
  
  /* Status badges with solid backgrounds */
  .status-badge.pending { background: #f59e0b; color: #fff; }
  .status-badge.processing { background: #3b82f6; color: #fff; }
  .status-badge.shipped { background: #8b5cf6; color: #fff; }
  .status-badge.delivered { background: #10b981; color: #fff; }
  .status-badge.completed { background: #10b981; color: #fff; }
  .status-badge.cancelled { background: #ef4444; color: #fff; }
  
  /* Priority badges with solid backgrounds */
  .priority-badge.urgent { background: #ef4444; color: #fff; }
  .priority-badge.high { background: #f59e0b; color: #fff; }
  
  /* Professional Order Details Styles - Clean Design */
  .order-details-page {
    max-width: 1400px;
    margin: 0 auto;
  }
  
  /* Order Hero Header - Clean, No Gradient */
  .order-hero {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  
  .order-hero-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 1.5rem;
  }
  
  .order-hero-main {
    flex: 1;
    min-width: 300px;
  }
  
  .order-number {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.25rem;
  }
  
  .order-number h1 {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    letter-spacing: -0.5px;
  }
  
  .order-badges {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  .order-meta-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1.25rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #f1f5f9;
  }
  
  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.875rem;
  }
  
  .meta-icon {
    width: 42px;
    height: 42px;
    border-radius: 10px;
    background: #3b82f6;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  
  .meta-icon i,
  .meta-icon svg {
    width: 18px;
    height: 18px;
    color: #fff;
    stroke: #fff;
  }
  
  .meta-content {
    display: flex;
    flex-direction: column;
  }
  
  .meta-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #94a3b8;
    margin-bottom: 0.2rem;
    font-weight: 500;
  }
  
  .meta-value {
    font-weight: 600;
    color: #1e293b;
    font-size: 0.95rem;
  }
  
  .order-hero-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  /* Status Timeline - Clean Design */
  .timeline-card {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 1.5rem 2rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  
  .timeline-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.75rem;
  }
  
  .timeline-card-header h3 {
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .timeline-card-header h3 i {
    width: 18px;
    height: 18px;
    color: #3b82f6;
  }
  
  .order-timeline {
    display: flex;
    justify-content: space-between;
    position: relative;
    padding: 0 1.5rem;
  }
  
  .order-timeline::before {
    content: '';
    position: absolute;
    top: 24px;
    left: 4rem;
    right: 4rem;
    height: 3px;
    background: #e2e8f0;
    z-index: 0;
    border-radius: 2px;
  }
  
  .timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    position: relative;
    z-index: 1;
    flex: 1;
  }
  
  .timeline-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8fafc;
    border: 3px solid #e2e8f0;
    margin-bottom: 0.75rem;
    transition: all 0.3s ease;
  }
  
  .timeline-icon i {
    width: 20px;
    height: 20px;
    color: #94a3b8;
  }
  
  .timeline-step.completed .timeline-icon {
    background: #10b981;
    border-color: #10b981;
  }
  
  .timeline-step.completed .timeline-icon i {
    color: #fff;
  }
  
  .timeline-step.active .timeline-icon {
    background: #3b82f6;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
  }
  
  .timeline-step.active .timeline-icon i {
    color: #fff;
  }
  
  .timeline-step.cancelled .timeline-icon {
    background: #ef4444;
    border-color: #ef4444;
  }
  
  .timeline-step.cancelled .timeline-icon i {
    color: #fff;
  }
  
  .timeline-label {
    font-size: 0.8rem;
    font-weight: 600;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .timeline-step.completed .timeline-label,
  .timeline-step.active .timeline-label {
    color: #1e293b;
  }
  
  .timeline-date {
    font-size: 0.75rem;
    color: #94a3b8;
    margin-top: 0.25rem;
  }
  
  /* Main Content Grid */
  .order-content-grid {
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: 1.5rem;
  }
  
  /* Cards - Clean Design */
  .details-card {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  
  .details-card:last-child {
    margin-bottom: 0;
  }
  
  .details-card-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #f1f5f9;
    background: #f8fafc;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .details-card-header h3 {
    font-size: 0.9rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .card-header-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: #3b82f6;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  
  .card-header-icon i {
    width: 16px;
    height: 16px;
    color: #fff;
  }
  
  .details-card-header h3 i:not(.card-header-icon i) {
    width: 16px;
    height: 16px;
    color: #3b82f6;
  }
  
  .details-card-body {
    padding: 1.5rem;
  }
  
  /* Order Items Table */
  .items-table-wrapper {
    overflow-x: auto;
  }
  
  .order-items-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px;
  }
  
  .order-items-table th {
    text-align: left;
    padding: 0.875rem 1rem;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #64748b;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
  }
  
  .order-items-table th:first-child {
    padding-left: 1.5rem;
  }
  
  .order-items-table th:last-child {
    padding-right: 1.5rem;
    text-align: right;
  }
  
  .order-items-table td {
    padding: 1.25rem 1rem;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
  }
  
  .order-items-table td:first-child {
    padding-left: 1.5rem;
  }
  
  .order-items-table td:last-child {
    padding-right: 1.5rem;
    text-align: right;
  }
  
  .order-items-table tbody tr:last-child td {
    border-bottom: none;
  }
  
  .order-items-table tbody tr:hover {
    background: #f8fafc;
  }
  
  .item-info {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .item-image {
    width: 48px;
    height: 48px;
    background: #3b82f6;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  
  .item-image i {
    width: 20px;
    height: 20px;
    color: #fff;
  }
  
  .item-details {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }
  
  .item-name {
    font-weight: 600;
    color: #1e293b;
    font-size: 0.9rem;
  }
  
  .item-part-number {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    font-size: 0.8rem;
    font-weight: 600;
    color: #3b82f6;
    background: #eff6ff;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    width: fit-content;
  }
  
  .item-part-number i {
    width: 12px;
    height: 12px;
  }
  
  .item-meta {
    display: flex;
    gap: 0.75rem;
    font-size: 0.8rem;
    color: #64748b;
  }
  
  .item-meta span {
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }
  
  .item-meta i {
    width: 12px;
    height: 12px;
    opacity: 0.7;
  }
  
  .item-price {
    font-weight: 600;
    color: #1e293b;
    font-size: 0.95rem;
  }
  
  /* Stock Badges */
  .stock-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  .stock-badge.in-stock { background: #dcfce7; color: #16a34a; }
  .stock-badge.low-stock { background: #fef3c7; color: #d97706; }
  .stock-badge.out-stock { background: #fee2e2; color: #dc2626; }
  .stock-badge i { width: 11px; height: 11px; }
  
  /* Order Summary */
  .order-summary {
    padding: 1.25rem 1.5rem;
    background: #f8fafc;
    border-top: 1px solid #e2e8f0;
  }
  
  .summary-row {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    font-size: 0.9rem;
  }
  
  .summary-label {
    color: #64748b;
  }
  
  .summary-value {
    font-weight: 600;
    color: #1e293b;
  }
  
  .summary-row.total {
    border-top: 2px solid #e2e8f0;
    margin-top: 0.75rem;
    padding-top: 1rem;
  }
  
  .summary-row.total .summary-label,
  .summary-row.total .summary-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1e293b;
  }
  
  /* Customer Card - Clean Design */
  .customer-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.25rem;
    padding-bottom: 1.25rem;
    border-bottom: 1px solid #f1f5f9;
  }
  
  .customer-avatar {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    background: #3b82f6;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-weight: 700;
    font-size: 1.25rem;
    flex-shrink: 0;
    overflow: hidden;
  }
  
  .customer-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .customer-avatar .avatar-fallback {
    display: none;
    width: 100%;
    height: 100%;
    align-items: center;
    justify-content: center;
  }
  
  .customer-info h4 {
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 0.25rem;
  }
  
  .customer-info p {
    font-size: 0.85rem;
    color: #64748b;
    margin: 0;
  }
  
  /* Info List */
  .info-list {
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  
  .info-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.875rem 0;
    border-bottom: 1px solid #f1f5f9;
  }
  
  .info-list-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }
  
  .info-list-item:first-child {
    padding-top: 0;
  }
  
  .info-list-label {
    font-size: 0.85rem;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .info-list-label i {
    width: 16px;
    height: 16px;
    color: #94a3b8;
  }
  
  .info-list-value {
    font-weight: 600;
    color: #1e293b;
    text-align: right;
    font-size: 0.9rem;
  }
  
  /* Payment Status Badge */
  .payment-status {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.4rem 0.75rem;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .payment-status.paid {
    background: #dcfce7;
    color: #16a34a;
  }
  
  .payment-status.pending {
    background: #fef3c7;
    color: #d97706;
  }
  
  .payment-status.partial {
    background: #dbeafe;
    color: #2563eb;
  }
  
  .payment-status.failed {
    background: #fee2e2;
    color: #dc2626;
  }
  
  .payment-status i {
    width: 12px;
    height: 12px;
  }
  
  /* Shipping Address */
  .shipping-address {
    color: #475569;
    line-height: 1.8;
    font-size: 0.9rem;
  }
  
  .shipping-address strong {
    display: block;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
    color: #1e293b;
  }
  
  /* Activity Log - Enhanced Design */
  .activity-log {
    max-height: 450px;
    overflow-y: auto;
  }
  
  .activity-item {
    display: flex;
    gap: 1rem;
    padding: 1rem 1.25rem;
    position: relative;
    background: #f8fafc;
    border-radius: 12px;
    margin-bottom: 0.75rem;
  }
  
  .activity-item:last-child {
    margin-bottom: 0;
  }
  
  .activity-icon-wrapper {
    position: relative;
    flex-shrink: 0;
  }
  
  .activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  
  .activity-icon i {
    width: 18px;
    height: 18px;
  }
  
  /* Activity Icon with solid background and white icons */
  .activity-icon.pending { background: #f59e0b; }
  .activity-icon.pending i { color: #fff; }
  .activity-icon.processing { background: #8b5cf6; }
  .activity-icon.processing i { color: #fff; }
  .activity-icon.shipped { background: #3b82f6; }
  .activity-icon.shipped i { color: #fff; }
  .activity-icon.delivered { background: #10b981; }
  .activity-icon.delivered i { color: #fff; }
  .activity-icon.cancelled { background: #ef4444; }
  .activity-icon.cancelled i { color: #fff; }
  .activity-icon.default { background: #64748b; }
  .activity-icon.default i { color: #fff; }
  
  .activity-content {
    flex: 1;
    padding-top: 0.1rem;
  }
  
  .activity-text {
    color: #1e293b;
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 0.5rem;
    font-weight: 500;
  }
  
  .activity-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.75rem;
    color: #94a3b8;
  }
  
  .activity-meta span {
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }
  
  .activity-meta i {
    width: 12px;
    height: 12px;
  }
  
  /* Notes Card */
  .notes-content {
    color: #475569;
    font-size: 0.9rem;
    line-height: 1.8;
  }
  
  /* Status Modal */
  .status-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }
  
  .status-modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }
  
  .status-modal {
    background: var(--admin-bg-secondary);
    border: 1px solid var(--admin-border);
    border-radius: 16px;
    width: 100%;
    max-width: 420px;
    padding: 1.5rem;
    transform: scale(0.9);
    transition: transform 0.3s ease;
  }
  
  .status-modal-overlay.active .status-modal {
    transform: scale(1);
  }
  
  .status-modal h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--admin-text-primary);
    margin: 0 0 1rem;
  }
  
  .status-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }
  
  .status-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    background: var(--admin-bg-primary);
    border: 2px solid var(--admin-border);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .status-option:hover {
    border-color: var(--module-primary, var(--admin-primary));
    background: var(--admin-bg-tertiary);
  }
  
  .status-option.selected {
    border-color: var(--module-primary, var(--admin-primary));
    background: rgba(59, 130, 246, 0.05);
  }
  
  .status-option input {
    display: none;
  }
  
  .status-option-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .status-option-icon i {
    width: 16px;
    height: 16px;
  }
  
  .status-option-content {
    flex: 1;
  }
  
  .status-option-label {
    font-weight: 600;
    color: var(--admin-text-primary);
    font-size: 0.9rem;
  }
  
  .status-option-desc {
    font-size: 0.75rem;
    color: var(--admin-text-muted);
    margin-top: 0.15rem;
  }
  
  .status-modal-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
  }
  
  /* Empty Items */
  .empty-items {
    text-align: center;
    padding: 3rem 1.5rem;
    color: var(--admin-text-muted);
  }
  
  .empty-items i {
    width: 48px;
    height: 48px;
    margin-bottom: 1rem;
    opacity: 0.5;
  }
  
  @media (max-width: 1024px) {
    .order-content-grid {
      grid-template-columns: 1fr;
    }
    
    .order-timeline::before {
      display: none;
    }
    
    .timeline-step {
      flex: 0 0 calc(50% - 0.5rem);
    }
  }
  
  @media (max-width: 640px) {
    .order-hero {
      padding: 1.5rem;
    }
    
    .order-hero-content {
      flex-direction: column;
    }
    
    .order-hero-actions {
      width: 100%;
    }
    
    .order-hero-actions .admin-btn {
      flex: 1;
    }
  }
</style>
</head>
<body>
  <div class="admin-wrapper">
    <%- include('partials/sidebar', { activePage: 'orders' }) %>
    
    <main class="admin-main">
      <%- include('partials/topbar', { pageTitle: 'Order Details' }) %>
      
      <div class="admin-content order-details-page">
        <!-- Breadcrumb -->
        <div style="margin-bottom: 1.5rem;">
          <a href="/admin/orders" style="color: var(--admin-text-muted); text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
            <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
            Back to Orders
          </a>
        </div>

        <!-- Order Hero Header -->
        <div class="order-hero">
          <div class="order-hero-content">
            <div class="order-hero-main">
              <div class="order-number">
                <h1><%= order.id %></h1>
                <div class="order-badges">
                  <span class="status-badge <%= order.status %>">
                    <% if (order.status === 'pending') { %>
                      <i data-lucide="clock"></i>
                    <% } else if (order.status === 'processing') { %>
                      <i data-lucide="loader"></i>
                    <% } else if (order.status === 'shipped') { %>
                      <i data-lucide="truck"></i>
                    <% } else if (order.status === 'delivered' || order.status === 'completed') { %>
                      <i data-lucide="check-circle"></i>
                    <% } else if (order.status === 'cancelled') { %>
                      <i data-lucide="x-circle"></i>
                    <% } %>
                    <%= order.status.charAt(0).toUpperCase() + order.status.slice(1) %>
                  </span>
                  <% if (order.priority !== 'normal') { %>
                  <span class="priority-badge <%= order.priority %>">
                    <i data-lucide="<%= order.priority === 'urgent' ? 'alert-triangle' : 'zap' %>"></i>
                    <%= order.priority.toUpperCase() %>
                  </span>
                  <% } %>
                </div>
              </div>
              
              <div class="order-meta-grid">
                <div class="meta-item">
                  <div class="meta-icon">
                    <i data-lucide="calendar"></i>
                  </div>
                  <div class="meta-content">
                    <span class="meta-label">Order Date</span>
                    <span class="meta-value"><%= order.date %></span>
                  </div>
                </div>
                <div class="meta-item">
                  <div class="meta-icon">
                    <i data-lucide="clock"></i>
                  </div>
                  <div class="meta-content">
                    <span class="meta-label">Time</span>
                    <span class="meta-value"><%= order.time %></span>
                  </div>
                </div>
                <div class="meta-item">
                  <div class="meta-icon">
                    <i data-lucide="package"></i>
                  </div>
                  <div class="meta-content">
                    <span class="meta-label">Items</span>
                    <span class="meta-value"><%= order.totalItems %> item<%= order.totalItems !== 1 ? 's' : '' %></span>
                  </div>
                </div>
                <div class="meta-item">
                  <div class="meta-icon">
                    <i data-lucide="banknote"></i>
                  </div>
                  <div class="meta-content">
                    <span class="meta-label">Total</span>
                    <span class="meta-value"><%= order.currency %> <%= order.amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="order-hero-actions">
              <button class="admin-btn admin-btn-secondary" onclick="window.print()">
                <i data-lucide="printer"></i>
                Print
              </button>
              <a href="/admin/orders/<%= order.id %>/edit" class="admin-btn admin-btn-secondary">
                <i data-lucide="edit-2"></i>
                Edit
              </a>
              <button class="admin-btn admin-btn-primary" onclick="showStatusModal()">
                <i data-lucide="refresh-cw"></i>
                Update Status
              </button>
            </div>
          </div>
        </div>

        <!-- Status Timeline -->
        <div class="timeline-card">
          <div class="timeline-card-header">
            <h3><i data-lucide="git-branch"></i> Order Progress</h3>
            <% if (order.shipping && order.shipping.trackingNumber) { %>
            <span style="font-size: 0.85rem; color: var(--admin-text-muted);">
              Tracking: <strong style="color: var(--admin-text-primary);"><%= order.shipping.trackingNumber %></strong>
            </span>
            <% } %>
          </div>
          <div class="order-timeline">
            <% 
              const statuses = ['pending', 'processing', 'shipped', 'delivered'];
              const statusIndex = statuses.indexOf(order.status);
              const isCancelled = order.status === 'cancelled';
            %>
            <% statuses.forEach((status, index) => { %>
            <div class="timeline-step <%= isCancelled ? (index === 0 ? 'completed' : '') : (index < statusIndex ? 'completed' : (index === statusIndex ? 'active' : '')) %> <%= isCancelled && index === statusIndex ? 'cancelled' : '' %>">
              <div class="timeline-icon">
                <% if (status === 'pending') { %>
                  <i data-lucide="clock"></i>
                <% } else if (status === 'processing') { %>
                  <i data-lucide="settings"></i>
                <% } else if (status === 'shipped') { %>
                  <i data-lucide="truck"></i>
                <% } else { %>
                  <i data-lucide="check-circle"></i>
                <% } %>
              </div>
              <div class="timeline-label"><%= status.charAt(0).toUpperCase() + status.slice(1) %></div>
              <div class="timeline-date">
                <% 
                  const timelineEvent = order.timeline ? order.timeline.find(t => t.status === status) : null;
                  if (timelineEvent) { 
                %>
                  <%= timelineEvent.formattedDate %>
                <% } else { %>
                  -
                <% } %>
              </div>
            </div>
            <% }); %>
          </div>
        </div>

        <!-- Main Content Grid -->
        <div class="order-content-grid">
          <!-- Left Column -->
          <div>
            <!-- Order Items -->
            <div class="details-card">
              <div class="details-card-header">
                <h3><i data-lucide="shopping-bag"></i> Order Items (<%= order.items.length %>)</h3>
              </div>
              <% if (order.items.length > 0) { %>
              <div class="items-table-wrapper">
                <table class="order-items-table">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Supplier</th>
                      <th>Stock</th>
                      <th>Price</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% order.items.forEach((item, index) => { %>
                    <tr>
                      <td>
                        <div class="item-info">
                          <div class="item-image">
                            <i data-lucide="box"></i>
                          </div>
                          <div class="item-details">
                            <div class="item-part-number">
                              <i data-lucide="hash"></i> <%= item.partNumber %>
                            </div>
                            <div class="item-name"><%= item.description || 'Part' %></div>
                            <% if (item.brand && item.brand !== 'N/A') { %>
                            <div class="item-meta">
                              <span><i data-lucide="tag"></i> <%= item.brand %></span>
                            </div>
                            <% } %>
                          </div>
                        </div>
                      </td>
                      <td>
                        <span style="color: #475569;"><%= item.supplier || 'N/A' %></span>
                      </td>
                      <td>
                        <span class="status-badge <%= item.stock === 'In Stock' ? 'delivered' : (item.stock === 'Low Stock' ? 'pending' : 'processing') %>" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">
                          <%= item.stock || 'N/A' %>
                        </span>
                      </td>
                      <td class="item-price">
                        <%= item.currency || order.currency %> <%= (item.price || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                      </td>
                    </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
              <% } else { %>
              <div class="empty-items">
                <i data-lucide="package-x"></i>
                <p>No items in this order</p>
              </div>
              <% } %>
              
              <!-- Order Summary -->
              <div class="order-summary">
                <div class="summary-row">
                  <span class="summary-label">Subtotal (<%= order.items.length %> items)</span>
                  <span class="summary-value"><%= order.currency %> <%= (order.subtotal || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                </div>
                <% if (order.shipping > 0) { %>
                <div class="summary-row">
                  <span class="summary-label">Shipping</span>
                  <span class="summary-value"><%= order.currency %> <%= order.shipping.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                </div>
                <% } %>
                <% if (order.tax > 0) { %>
                <div class="summary-row">
                  <span class="summary-label">Tax</span>
                  <span class="summary-value"><%= order.currency %> <%= order.tax.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                </div>
                <% } %>
                <% if (order.processingFee > 0) { %>
                <div class="summary-row">
                  <span class="summary-label">Processing Fee</span>
                  <span class="summary-value"><%= order.currency %> <%= order.processingFee.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                </div>
                <% } %>
                <% if (order.discount > 0) { %>
                <div class="summary-row">
                  <span class="summary-label">Discount</span>
                  <span class="summary-value" style="color: #10b981;">-<%= order.currency %> <%= order.discount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                </div>
                <% } %>
                <div class="summary-row total">
                  <span class="summary-label">Total</span>
                  <span class="summary-value"><%= order.currency %> <%= (order.amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                </div>
              </div>
            </div>

            <!-- Activity Log -->
            <div class="details-card">
              <div class="details-card-header">
                <h3><i data-lucide="activity"></i> Activity Timeline</h3>
                <button class="admin-btn admin-btn-sm admin-btn-primary" onclick="showAddNoteModal()" style="padding: 0.35rem 0.75rem; font-size: 0.75rem;">
                  <i data-lucide="plus" style="width: 14px; height: 14px;"></i>
                  Add Note
                </button>
              </div>
              <div class="details-card-body">
                <div class="activity-log" id="activityLog">
                  <% if (order.timeline && order.timeline.length > 0) { %>
                    <% order.timeline.slice().reverse().forEach((event, index) => { %>
                    <div class="activity-item">
                      <div class="activity-icon-wrapper">
                        <div class="activity-icon <%= event.isNote ? (event.status || 'note') : (event.status || 'default') %>" style="<%= event.isNote ? 'background: linear-gradient(135deg, #6366f1, #8b5cf6);' : '' %>">
                          <i data-lucide="<%= 
                            event.isNote ? (
                              event.status === 'delay' ? 'clock-alert' :
                              event.status === 'issue' ? 'alert-triangle' :
                              event.status === 'info' ? 'info' :
                              event.status === 'action' ? 'alert-circle' :
                              event.status === 'resolution' ? 'check-square' :
                              'message-square'
                            ) : (
                              event.status === 'pending' ? 'clock' :
                              event.status === 'processing' ? 'settings' :
                              event.status === 'shipped' ? 'truck' :
                              event.status === 'delivered' ? 'check-circle' :
                              event.status === 'cancelled' ? 'x-circle' :
                              'info'
                            )
                          %>"></i>
                        </div>
                      </div>
                      <div class="activity-content">
                        <div class="activity-text"><%= event.message %></div>
                        <div class="activity-meta">
                          <span><i data-lucide="calendar"></i> <%= event.formattedDate || 'N/A' %></span>
                          <span><i data-lucide="clock"></i> <%= event.formattedTime || 'N/A' %></span>
                          <span><i data-lucide="user"></i> <%= event.updatedBy || 'System' %></span>
                        </div>
                      </div>
                    </div>
                    <% }); %>
                  <% } else { %>
                    <div class="activity-item">
                      <div class="activity-icon-wrapper">
                        <div class="activity-icon delivered">
                          <i data-lucide="plus"></i>
                        </div>
                      </div>
                      <div class="activity-content">
                        <div class="activity-text">Order created</div>
                        <div class="activity-meta">
                          <span><i data-lucide="calendar"></i> <%= order.date %></span>
                          <span><i data-lucide="clock"></i> <%= order.time %></span>
                        </div>
                      </div>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>

            <!-- Notes -->
            <% if (order.notes) { %>
            <div class="details-card">
              <div class="details-card-header">
                <h3><i data-lucide="file-text"></i> Order Notes</h3>
              </div>
              <div class="details-card-body">
                <div class="notes-content">
                  <%= order.notes %>
                </div>
              </div>
            </div>
            <% } %>
          </div>

          <!-- Right Column -->
          <div>
            <!-- Customer Info -->
            <div class="details-card">
              <div class="details-card-header">
                <h3><i data-lucide="user"></i> Customer</h3>
                <% if (order.buyer) { %>
                <a href="/admin/users/<%= order.buyer.id %>" class="admin-btn admin-btn-sm admin-btn-ghost" style="padding: 0.35rem 0.75rem; font-size: 0.75rem;">
                  View Profile
                </a>
                <% } %>
              </div>
              <div class="details-card-body">
                <div class="customer-header">
                  <div class="customer-avatar">
                    <% 
                      const customerInitial = order.customer ? order.customer.charAt(0).toUpperCase() : '?';
                      const profilePic = order.buyer && (order.buyer.avatar || order.buyer.profileImage || order.buyer.companyLogo);
                    %>
                    <% if (profilePic) { %>
                      <img src="<%= profilePic %>" alt="<%= order.customer %>" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                      <span class="avatar-fallback"><%= customerInitial %></span>
                    <% } else { %>
                      <%= customerInitial %>
                    <% } %>
                  </div>
                  <div class="customer-info">
                    <h4><%= order.customer || 'Unknown' %></h4>
                    <p><%= order.email || 'N/A' %></p>
                  </div>
                </div>
                <div class="info-list">
                  <div class="info-list-item">
                    <span class="info-list-label"><i data-lucide="phone"></i> Phone</span>
                    <span class="info-list-value"><%= order.phone || 'N/A' %></span>
                  </div>
                  <% if (order.buyer && order.buyer.country) { %>
                  <div class="info-list-item">
                    <span class="info-list-label"><i data-lucide="globe"></i> Location</span>
                    <span class="info-list-value"><%= order.buyer.city ? order.buyer.city + ', ' : '' %><%= order.buyer.country %></span>
                  </div>
                  <% } %>
                </div>
              </div>
            </div>

            <!-- Shipping Info -->
            <div class="details-card">
              <div class="details-card-header">
                <h3><i data-lucide="map-pin"></i> Shipping Address</h3>
              </div>
              <div class="details-card-body">
                <div class="shipping-address">
                  <strong><%= order.shipping ? order.shipping.fullName : 'N/A' %></strong>
                  <% if (order.shipping && order.shipping.street && order.shipping.street !== 'N/A') { %>
                    <%= order.shipping.street %><br>
                  <% } %>
                  <% if (order.shipping && order.shipping.city && order.shipping.city !== 'N/A') { %>
                    <%= order.shipping.city %><%= order.shipping.state ? ', ' + order.shipping.state : '' %> <%= order.shipping.postalCode || '' %><br>
                  <% } %>
                  <% if (order.shipping && order.shipping.country && order.shipping.country !== 'N/A') { %>
                    <%= order.shipping.country %>
                  <% } %>
                </div>
                <% if (order.shipping && order.shipping.phone && order.shipping.phone !== 'N/A') { %>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--admin-border);">
                  <div class="info-list-item" style="border: none; padding: 0;">
                    <span class="info-list-label"><i data-lucide="phone"></i> Contact</span>
                    <span class="info-list-value"><%= order.shipping.phone %></span>
                  </div>
                </div>
                <% } %>
              </div>
            </div>

            <!-- Payment Info -->
            <div class="details-card">
              <div class="details-card-header">
                <h3><i data-lucide="credit-card"></i> Payment</h3>
              </div>
              <div class="details-card-body">
                <div class="info-list">
                  <div class="info-list-item">
                    <span class="info-list-label"><i data-lucide="wallet"></i> Method</span>
                    <span class="info-list-value">
                      <% 
                        const methodLabels = {
                          'card': 'Credit/Debit Card',
                          'bank-dubai': 'Bank Transfer (Dubai)',
                          'bank-international': 'International Wire',
                          'paypal': 'PayPal',
                          'cod': 'Cash on Delivery'
                        };
                      %>
                      <%= order.payment ? (methodLabels[order.payment.method] || order.payment.method) : 'N/A' %>
                    </span>
                  </div>
                  <div class="info-list-item">
                    <span class="info-list-label"><i data-lucide="check-circle"></i> Status</span>
                    <span class="info-list-value">
                      <span class="payment-status <%= order.payment ? order.payment.status : 'pending' %>">
                        <% if (order.payment && order.payment.status === 'paid') { %>
                          <i data-lucide="check"></i>
                        <% } else if (!order.payment || order.payment.status === 'pending') { %>
                          <i data-lucide="clock"></i>
                        <% } else if (order.payment && order.payment.status === 'partial') { %>
                          <i data-lucide="percent"></i>
                        <% } else { %>
                          <i data-lucide="x"></i>
                        <% } %>
                        <%= order.payment ? (order.payment.status.charAt(0).toUpperCase() + order.payment.status.slice(1)) : 'Pending' %>
                      </span>
                    </span>
                  </div>
                  <div class="info-list-item">
                    <span class="info-list-label"><i data-lucide="receipt"></i> Amount Paid</span>
                    <span class="info-list-value" style="color: #10b981;"><%= order.currency %> <%= order.payment ? order.payment.amountPaid.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00' %></span>
                  </div>
                  <% if (order.payment && order.payment.amountDue > 0) { %>
                  <div class="info-list-item">
                    <span class="info-list-label"><i data-lucide="alert-circle"></i> Amount Due</span>
                    <span class="info-list-value" style="color: #f59e0b;"><%= order.currency %> <%= order.payment.amountDue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                  </div>
                  <% } %>
                </div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="details-card">
              <div class="details-card-header">
                <h3><i data-lucide="zap"></i> Quick Actions</h3>
              </div>
              <div class="details-card-body" style="display: flex; flex-direction: column; gap: 0.5rem;">
                <button class="admin-btn admin-btn-secondary" style="width: 100%; justify-content: flex-start;" onclick="window.print()">
                  <i data-lucide="printer"></i>
                  Print Invoice
                </button>
                <button class="admin-btn admin-btn-secondary" style="width: 100%; justify-content: flex-start;">
                  <i data-lucide="mail"></i>
                  Send Update Email
                </button>
                <% if (order.status !== 'cancelled' && order.status !== 'delivered') { %>
                <button class="admin-btn admin-btn-secondary" style="width: 100%; justify-content: flex-start; color: #ef4444;" onclick="cancelOrder()">
                  <i data-lucide="x-circle"></i>
                  Cancel Order
                </button>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Status Update Modal -->
  <div class="status-modal-overlay" id="statusModal">
    <div class="status-modal">
      <h3>Update Order Status</h3>
      <div class="status-options">
        <label class="status-option" data-status="pending">
          <input type="radio" name="newStatus" value="pending" <%= order.status === 'pending' ? 'checked' : '' %>>
          <div class="status-option-icon" style="background: rgba(245, 158, 11, 0.12);">
            <i data-lucide="clock" style="color: #f59e0b;"></i>
          </div>
          <div class="status-option-content">
            <div class="status-option-label">Pending</div>
            <div class="status-option-desc">Order awaiting processing</div>
          </div>
        </label>
        <label class="status-option" data-status="processing">
          <input type="radio" name="newStatus" value="processing" <%= order.status === 'processing' ? 'checked' : '' %>>
          <div class="status-option-icon" style="background: rgba(139, 92, 246, 0.12);">
            <i data-lucide="settings" style="color: #8b5cf6;"></i>
          </div>
          <div class="status-option-content">
            <div class="status-option-label">Processing</div>
            <div class="status-option-desc">Order is being prepared</div>
          </div>
        </label>
        <label class="status-option" data-status="shipped">
          <input type="radio" name="newStatus" value="shipped" <%= order.status === 'shipped' ? 'checked' : '' %>>
          <div class="status-option-icon" style="background: rgba(59, 130, 246, 0.12);">
            <i data-lucide="truck" style="color: #3b82f6;"></i>
          </div>
          <div class="status-option-content">
            <div class="status-option-label">Shipped</div>
            <div class="status-option-desc">Order has been dispatched</div>
          </div>
        </label>
        <label class="status-option" data-status="delivered">
          <input type="radio" name="newStatus" value="delivered" <%= order.status === 'delivered' ? 'checked' : '' %>>
          <div class="status-option-icon" style="background: rgba(16, 185, 129, 0.12);">
            <i data-lucide="check-circle" style="color: #10b981;"></i>
          </div>
          <div class="status-option-content">
            <div class="status-option-label">Delivered</div>
            <div class="status-option-desc">Order completed successfully</div>
          </div>
        </label>
      </div>
      <div class="status-modal-actions">
        <button class="admin-btn admin-btn-secondary" onclick="hideStatusModal()">Cancel</button>
        <button class="admin-btn admin-btn-primary" onclick="updateOrderStatus()">Update Status</button>
      </div>
    </div>
  </div>

  <!-- Add Timeline Note Modal -->
  <div class="status-modal-overlay" id="addNoteModal">
    <div class="status-modal" style="max-width: 500px;">
      <h3 style="display: flex; align-items: center; gap: 0.5rem;">
        <i data-lucide="message-square-plus" style="width: 20px; height: 20px; color: #6366f1;"></i>
        Add Timeline Note
      </h3>
      <p style="font-size: 0.85rem; color: var(--admin-text-muted); margin-bottom: 1.25rem;">
        Add a custom note to the order timeline. This will be visible to the customer.
      </p>
      
      <div style="margin-bottom: 1.25rem;">
        <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--admin-text-primary); margin-bottom: 0.5rem;">
          Note Type
        </label>
        <div class="status-options" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 0;">
          <label class="status-option selected" data-note-type="update" style="padding: 0.6rem 0.75rem;">
            <input type="radio" name="noteType" value="update" checked>
            <div class="status-option-icon" style="background: rgba(59, 130, 246, 0.12); width: 28px; height: 28px;">
              <i data-lucide="refresh-cw" style="color: #3b82f6; width: 14px; height: 14px;"></i>
            </div>
            <div class="status-option-content">
              <div class="status-option-label" style="font-size: 0.8rem;">Update</div>
            </div>
          </label>
          <label class="status-option" data-note-type="delay" style="padding: 0.6rem 0.75rem;">
            <input type="radio" name="noteType" value="delay">
            <div class="status-option-icon" style="background: rgba(245, 158, 11, 0.12); width: 28px; height: 28px;">
              <i data-lucide="clock" style="color: #f59e0b; width: 14px; height: 14px;"></i>
            </div>
            <div class="status-option-content">
              <div class="status-option-label" style="font-size: 0.8rem;">Delay</div>
            </div>
          </label>
          <label class="status-option" data-note-type="issue" style="padding: 0.6rem 0.75rem;">
            <input type="radio" name="noteType" value="issue">
            <div class="status-option-icon" style="background: rgba(239, 68, 68, 0.12); width: 28px; height: 28px;">
              <i data-lucide="alert-triangle" style="color: #ef4444; width: 14px; height: 14px;"></i>
            </div>
            <div class="status-option-content">
              <div class="status-option-label" style="font-size: 0.8rem;">Issue</div>
            </div>
          </label>
          <label class="status-option" data-note-type="info" style="padding: 0.6rem 0.75rem;">
            <input type="radio" name="noteType" value="info">
            <div class="status-option-icon" style="background: rgba(99, 102, 241, 0.12); width: 28px; height: 28px;">
              <i data-lucide="info" style="color: #6366f1; width: 14px; height: 14px;"></i>
            </div>
            <div class="status-option-content">
              <div class="status-option-label" style="font-size: 0.8rem;">Info</div>
            </div>
          </label>
          <label class="status-option" data-note-type="action" style="padding: 0.6rem 0.75rem;">
            <input type="radio" name="noteType" value="action">
            <div class="status-option-icon" style="background: rgba(139, 92, 246, 0.12); width: 28px; height: 28px;">
              <i data-lucide="alert-circle" style="color: #8b5cf6; width: 14px; height: 14px;"></i>
            </div>
            <div class="status-option-content">
              <div class="status-option-label" style="font-size: 0.8rem;">Action</div>
            </div>
          </label>
          <label class="status-option" data-note-type="resolution" style="padding: 0.6rem 0.75rem;">
            <input type="radio" name="noteType" value="resolution">
            <div class="status-option-icon" style="background: rgba(16, 185, 129, 0.12); width: 28px; height: 28px;">
              <i data-lucide="check-square" style="color: #10b981; width: 14px; height: 14px;"></i>
            </div>
            <div class="status-option-content">
              <div class="status-option-label" style="font-size: 0.8rem;">Resolved</div>
            </div>
          </label>
        </div>
      </div>
      
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--admin-text-primary); margin-bottom: 0.5rem;">
          Message <span style="color: #ef4444;">*</span>
        </label>
        <textarea id="noteMessage" placeholder="Enter a detailed message for the customer..." 
          style="width: 100%; min-height: 100px; padding: 0.75rem 1rem; background: var(--admin-bg-primary); border: 1px solid var(--admin-border); border-radius: 10px; color: var(--admin-text-primary); font-size: 0.9rem; resize: vertical;"></textarea>
      </div>
      
      <div class="status-modal-actions">
        <button class="admin-btn admin-btn-secondary" onclick="hideAddNoteModal()">Cancel</button>
        <button class="admin-btn admin-btn-primary" onclick="submitTimelineNote()" id="submitNoteBtn">
          <i data-lucide="send" style="width: 14px; height: 14px;"></i>
          Add Note
        </button>
      </div>
    </div>
  </div>

  <script>
    const statusModal = document.getElementById('statusModal');
    const addNoteModal = document.getElementById('addNoteModal');
    
    function showStatusModal() {
      statusModal.classList.add('active');
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    }
    
    function hideStatusModal() {
      statusModal.classList.remove('active');
    }
    
    function showAddNoteModal() {
      addNoteModal.classList.add('active');
      document.getElementById('noteMessage').value = '';
      document.getElementById('noteMessage').focus();
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    }
    
    function hideAddNoteModal() {
      addNoteModal.classList.remove('active');
    }
    
    // Note type selection
    document.querySelectorAll('#addNoteModal .status-option').forEach(option => {
      option.addEventListener('click', function() {
        document.querySelectorAll('#addNoteModal .status-option').forEach(o => o.classList.remove('selected'));
        this.classList.add('selected');
        this.querySelector('input').checked = true;
      });
    });
    
    async function submitTimelineNote() {
      const message = document.getElementById('noteMessage').value.trim();
      const noteType = document.querySelector('#addNoteModal input[name="noteType"]:checked')?.value || 'update';
      
      if (!message) {
        showAlert('Please enter a message', 'warning');
        return;
      }
      
      const submitBtn = document.getElementById('submitNoteBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i> Adding...';
      if (typeof lucide !== 'undefined') lucide.createIcons();
      
      try {
        const response = await fetch('/admin/api/orders/<%- order.id %>/timeline', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, noteType })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Reload to show the new note
          window.location.reload();
        } else {
          showAlert(data.error || 'Failed to add note', 'error');
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i data-lucide="send"></i> Add Note';
          if (typeof lucide !== 'undefined') lucide.createIcons();
        }
      } catch (error) {
        console.error('Error adding note:', error);
        showAlert('Failed to add timeline note', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i data-lucide="send"></i> Add Note';
        if (typeof lucide !== 'undefined') lucide.createIcons();
      }
    }
    
    document.querySelectorAll('.status-option').forEach(option => {
      option.addEventListener('click', function() {
        const parent = this.closest('.status-options');
        parent.querySelectorAll('.status-option').forEach(o => o.classList.remove('selected'));
        this.classList.add('selected');
        this.querySelector('input').checked = true;
      });
      
      if (option.querySelector('input').checked) {
        option.classList.add('selected');
      }
    });
    
    async function updateOrderStatus() {
      const selectedStatus = document.querySelector('input[name="newStatus"]:checked');
      if (!selectedStatus) {
        showAlert('Please select a status', 'warning');
        return;
      }
      
      try {
        const response = await fetch('/admin/api/orders/<%= order.id %>/status', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: selectedStatus.value })
        });
        
        const data = await response.json();
        
        if (data.success) {
          window.location.reload();
        } else {
          showAlert(data.error || 'Failed to update status', 'error');
        }
      } catch (error) {
        console.error('Error updating status:', error);
        showAlert('Failed to update order status', 'error');
      }
    }
    
    async function cancelOrder() {
      const confirmed = await showConfirm('Are you sure you want to cancel this order? This action cannot be undone.', {
        title: 'Cancel Order',
        type: 'warning',
        confirmText: 'Cancel Order',
        confirmClass: 'danger'
      });
      if (!confirmed) return;
      
      try {
        const response = await fetch('/admin/api/orders/<%= order.id %>/status', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'cancelled', message: 'Order cancelled by admin' })
        });
        
        const data = await response.json();
        
        if (data.success) {
          window.location.reload();
        } else {
          showAlert(data.error || 'Failed to cancel order', 'error');
        }
      } catch (error) {
        console.error('Error cancelling order:', error);
        showAlert('Failed to cancel order', 'error');
      }
    }
    
    statusModal.addEventListener('click', function(e) {
      if (e.target === this) hideStatusModal();
    });
    
    addNoteModal.addEventListener('click', function(e) {
      if (e.target === this) hideAddNoteModal();
    });
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        hideStatusModal();
        hideAddNoteModal();
      }
    });
  </script>

<%- include('partials/footer') %>
