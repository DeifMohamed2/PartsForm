<%- include('partials/header') %>
<link rel="stylesheet" href="/css/adminCSS/admin-dashboard.css">
<link rel="stylesheet" href="/css/adminCSS/admin-integrations.css">
</head>
<body class="<%= typeof currentModule !== 'undefined' && currentModule ? 'module-' + currentModule : '' %>">
  <div class="admin-wrapper">
    <%- include('partials/sidebar', { activePage: 'integrations', currentModule: currentModule }) %>
    
    <main class="admin-main">
      <%- include('partials/topbar', { pageTitle: 'New Connection', currentModule: currentModule }) %>
      
      <div class="admin-content">
        <div class="connection-create-page">
          <!-- Simplified Breadcrumb -->
          <div class="integrations-breadcrumb">
            <a href="/admin/integrations"><i data-lucide="plug"></i> Integrations</a>
            <i data-lucide="chevron-right"></i>
            <span>New Connection</span>
          </div>

          <!-- Page Header -->
          <div class="create-header">
            <div class="create-header-info">
              <h1>Add New Connection</h1>
              <p>Configure a new data source for Automotive Parts</p>
            </div>
          </div>

          <!-- Connection Type Selection -->
          <div class="create-section">
            <div class="section-title">
              <span class="step-number">1</span>
              <h2>Select Connection Type</h2>
            </div>
            
            <div class="connection-type-grid">
              <label class="connection-type-card" data-type="ftp">
                <input type="radio" name="connectionType" value="ftp" checked>
                <div class="type-card-content">
                  <div class="type-icon ftp">
                    <i data-lucide="hard-drive"></i>
                  </div>
                  <div class="type-info">
                    <h3>FTP / SFTP</h3>
                    <p>Connect to FTP servers to import CSV files with parts data</p>
                  </div>
                  <div class="type-features">
                    <span><i data-lucide="check"></i> Scheduled sync</span>
                    <span><i data-lucide="check"></i> CSV parsing</span>
                    <span><i data-lucide="check"></i> Bulk import</span>
                  </div>
                </div>
                <div class="type-checked">
                  <i data-lucide="check-circle"></i>
                </div>
              </label>

              <label class="connection-type-card" data-type="api">
                <input type="radio" name="connectionType" value="api">
                <div class="type-card-content">
                  <div class="type-icon api">
                    <i data-lucide="code"></i>
                  </div>
                  <div class="type-info">
                    <h3>REST API</h3>
                    <p>Connect to REST APIs to fetch parts data in JSON format</p>
                  </div>
                  <div class="type-features">
                    <span><i data-lucide="check"></i> Real-time data</span>
                    <span><i data-lucide="check"></i> OAuth support</span>
                    <span><i data-lucide="check"></i> Webhooks</span>
                  </div>
                </div>
                <div class="type-checked">
                  <i data-lucide="check-circle"></i>
                </div>
              </label>

              <label class="connection-type-card" data-type="excel">
                <input type="radio" name="connectionType" value="excel">
                <div class="type-card-content">
                  <div class="type-icon excel">
                    <i data-lucide="file-spreadsheet"></i>
                  </div>
                  <div class="type-info">
                    <h3>Excel Upload</h3>
                    <p>Upload .xlsx or .csv files with a set validity period</p>
                  </div>
                  <div class="type-features">
                    <span><i data-lucide="check"></i> 1 week/month validity</span>
                    <span><i data-lucide="check"></i> Auto-expiry</span>
                    <span><i data-lucide="check"></i> Direct upload</span>
                  </div>
                </div>
                <div class="type-checked">
                  <i data-lucide="check-circle"></i>
                </div>
              </label>

              <label class="connection-type-card" data-type="google-sheets">
                <input type="radio" name="connectionType" value="google-sheets">
                <div class="type-card-content">
                  <div class="type-icon google-sheets">
                    <i data-lucide="layout-grid"></i>
                  </div>
                  <div class="type-info">
                    <h3>Google Sheets</h3>
                    <p>Sync data directly from a live Google Spreadsheet</p>
                  </div>
                  <div class="type-features">
                    <span><i data-lucide="check"></i> Real-time sync</span>
                    <span><i data-lucide="check"></i> No-code setup</span>
                    <span><i data-lucide="check"></i> Collaborative</span>
                  </div>
                </div>
                <div class="type-checked">
                  <i data-lucide="check-circle"></i>
                </div>
              </label>
            </div>
          </div>

          <!-- FTP Configuration -->
          <div class="create-section config-section" id="config-ftp">
            <div class="section-title">
              <span class="step-number">2</span>
              <h2>FTP Connection Details</h2>
            </div>
            
            <div class="config-form">
              <div class="form-row">
                <div class="form-group">
                  <label>Connection Name <span class="required">*</span></label>
                  <input type="text" class="form-input" placeholder="e.g., Main Supplier FTP">
                  <span class="form-hint">A friendly name to identify this connection</span>
                </div>
                <div class="form-group">
                  <label>Protocol</label>
                  <select class="form-input">
                    <option value="ftp">FTP (Standard)</option>
                    <option value="ftps">FTPS (FTP over SSL)</option>
                    <option value="sftp">SFTP (SSH File Transfer)</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group flex-2">
                  <label>Host / Server <span class="required">*</span></label>
                  <input type="text" class="form-input" placeholder="ftp.example.com">
                </div>
                <div class="form-group">
                  <label>Port</label>
                  <input type="number" class="form-input" value="21">
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Username <span class="required">*</span></label>
                  <input type="text" class="form-input" placeholder="ftp_user">
                </div>
                <div class="form-group">
                  <label>Password <span class="required">*</span></label>
                  <div class="input-with-action">
                    <input type="password" class="form-input" placeholder="••••••••" id="ftpPassword">
                    <button type="button" class="input-action-btn" onclick="togglePassword('ftpPassword')">
                      <i data-lucide="eye"></i>
                    </button>
                  </div>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Remote Directory</label>
                  <input type="text" class="form-input" placeholder="/data/csv/" value="/">
                  <span class="form-hint">Path to the directory containing your data files</span>
                </div>
                <div class="form-group">
                  <label>File Pattern</label>
                  <input type="text" class="form-input" placeholder="*.csv" value="*.csv">
                  <span class="form-hint">Glob pattern to match files (e.g., *.csv, parts_*.txt)</span>
                </div>
              </div>

              <div class="form-divider"></div>

              <h3 class="subsection-title"><i data-lucide="clock"></i> Sync Schedule</h3>
              
              <div class="form-row">
                <div class="form-group">
                  <label>Sync Frequency</label>
                  <select class="form-input" id="syncFrequency">
                    <option value="manual">Manual only</option>
                    <option value="hourly">Every hour</option>
                    <option value="6hours" selected>Every 6 hours</option>
                    <option value="12hours">Every 12 hours</option>
                    <option value="daily">Once daily</option>
                    <option value="weekly">Once weekly</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Preferred Time</label>
                  <input type="time" class="form-input" value="02:00">
                  <span class="form-hint">Best time to run syncs (for daily/weekly)</span>
                </div>
              </div>

              <div class="form-divider"></div>

              <h3 class="subsection-title"><i data-lucide="sliders"></i> Advanced Options</h3>
              
              <div class="options-grid">
                <label class="option-toggle">
                  <input type="checkbox" checked>
                  <span class="toggle-slider"></span>
                  <div class="option-info">
                    <span class="option-label">Enable connection</span>
                    <span class="option-desc">Start syncing immediately after creation</span>
                  </div>
                </label>

                <label class="option-toggle">
                  <input type="checkbox" checked>
                  <span class="toggle-slider"></span>
                  <div class="option-info">
                    <span class="option-label">Passive mode</span>
                    <span class="option-desc">Use passive mode for FTP connections</span>
                  </div>
                </label>

                <label class="option-toggle">
                  <input type="checkbox">
                  <span class="toggle-slider"></span>
                  <div class="option-info">
                    <span class="option-label">Delete after import</span>
                    <span class="option-desc">Remove files from server after successful import</span>
                  </div>
                </label>

                <label class="option-toggle">
                  <input type="checkbox" checked>
                  <span class="toggle-slider"></span>
                  <div class="option-info">
                    <span class="option-label">Send notifications</span>
                    <span class="option-desc">Email alerts for sync failures</span>
                  </div>
                </label>
              </div>
            </div>
          </div>

          <!-- API Configuration (hidden by default) -->
          <div class="create-section config-section" id="config-api" style="display: none;">
            <div class="section-title">
              <span class="step-number">2</span>
              <h2>API Connection Details</h2>
            </div>
            
            <div class="config-form">
              <div class="form-row">
                <div class="form-group">
                  <label>Connection Name <span class="required">*</span></label>
                  <input type="text" class="form-input" placeholder="e.g., PartsBase API">
                </div>
                <div class="form-group">
                  <label>API Type</label>
                  <select class="form-input">
                    <option value="rest">REST API</option>
                    <option value="graphql">GraphQL</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group full-width">
                  <label>Base URL <span class="required">*</span></label>
                  <input type="text" class="form-input" placeholder="https://api.example.com/v2">
                </div>
              </div>

              <div class="form-divider"></div>

              <h3 class="subsection-title"><i data-lucide="key"></i> Authentication</h3>
              
              <div class="form-row">
                <div class="form-group">
                  <label>Auth Type</label>
                  <select class="form-input" id="apiAuthType">
                    <option value="none">No Authentication</option>
                    <option value="apikey" selected>API Key</option>
                    <option value="bearer">Bearer Token</option>
                    <option value="oauth2">OAuth 2.0</option>
                    <option value="basic">Basic Auth</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>API Key / Token</label>
                  <div class="input-with-action">
                    <input type="password" class="form-input" placeholder="••••••••" id="apiKey">
                    <button type="button" class="input-action-btn" onclick="togglePassword('apiKey')">
                      <i data-lucide="eye"></i>
                    </button>
                  </div>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Header Name</label>
                  <input type="text" class="form-input" placeholder="X-API-Key" value="Authorization">
                  <span class="form-hint">Header to send the API key in</span>
                </div>
                <div class="form-group">
                  <label>Rate Limit (req/min)</label>
                  <input type="number" class="form-input" placeholder="60" value="60">
                </div>
              </div>
            </div>
          </div>

          <!-- Excel Configuration (hidden by default) -->
          <div class="create-section config-section" id="config-excel" style="display: none;">
            <div class="section-title">
              <span class="step-number">2</span>
              <h2>Excel Upload Details</h2>
            </div>
            
            <div class="config-form">
              <div class="form-row">
                <div class="form-group flex-2">
                  <label>Export/Batch Name <span class="required">*</span></label>
                  <input type="text" class="form-input" placeholder="e.g., Q1 Performance Parts Batch">
                </div>
                <div class="form-group">
                  <label>Data Validity Period</label>
                  <select class="form-input">
                    <option value="1week">1 Week (Short-term)</option>
                    <option value="2weeks">2 Weeks</option>
                    <option value="1month" selected>1 Month (Standard)</option>
                    <option value="quarter">1 Quarter</option>
                    <option value="permanent">Permanent / Manual Delete</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group full-width">
                  <div class="upload-container-box">
                    <label>Upload File (.xlsx, .xls, .csv)</label>
                    <div class="file-upload-zone" id="excelUploadZone">
                      <i data-lucide="upload-cloud"></i>
                      <div class="upload-text">
                        <p><strong>Click to upload</strong> or drag and drop</p>
                        <span>Max file size: 50MB</span>
                      </div>
                      <input type="file" id="excelFileInput" hidden accept=".xlsx,.xls,.csv">
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-divider"></div>

              <h3 class="subsection-title"><i data-lucide="layers"></i> Data Handling</h3>
              <div class="options-grid">
                <label class="option-toggle">
                  <input type="checkbox" checked>
                  <span class="toggle-slider"></span>
                  <div class="option-info">
                    <span class="option-label">Clear previous data</span>
                    <span class="option-desc">Replace all previous items from this source</span>
                  </div>
                </label>
                <label class="option-toggle">
                  <input type="checkbox">
                  <span class="toggle-slider"></span>
                  <div class="option-info">
                    <span class="option-label">Auto-notify buyers</span>
                    <span class="option-desc">Alert buyers when significant price drops occur</span>
                  </div>
                </label>
              </div>
            </div>
          </div>

          <!-- Google Sheets Configuration (hidden by default) -->
          <div class="create-section config-section" id="config-google-sheets" style="display: none;">
            <div class="section-title">
              <span class="step-number">2</span>
              <h2>Google Sheets Sync Details</h2>
            </div>
            
            <div class="config-form">
              <div class="form-row">
                <div class="form-group full-width">
                  <label>Google Spreadsheet URL / ID <span class="required">*</span></label>
                  <input type="text" class="form-input" placeholder="https://docs.google.com/spreadsheets/d/...">
                  <span class="form-hint">Ensure the sheet is shared with the service account email provided in settings.</span>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Sheet Name / Tab</label>
                  <input type="text" class="form-input" placeholder="Sheet1" value="Sheet1">
                </div>
                <div class="form-group">
                  <label>Sync Mode</label>
                  <select class="form-input">
                    <option value="realtime" selected>Real-time (Auto-sync on edit)</option>
                    <option value="hourly">Every Hour</option>
                    <option value="daily">Daily Sync</option>
                  </select>
                </div>
              </div>

              <div class="form-divider"></div>

              <h3 class="subsection-title"><i data-lucide="shield-check"></i> Connection & Permissions</h3>
              <div class="google-auth-info">
                <i data-lucide="info"></i>
                <p>This connection uses the <strong>Google Sheets API v4</strong>. Real-time syncing requires a Google Cloud Project setup with Webhooks enabled.</p>
              </div>
              
              <div class="options-grid" style="margin-top: 1.5rem;">
                <label class="option-toggle">
                  <input type="checkbox" checked>
                  <span class="toggle-slider"></span>
                  <div class="option-info">
                    <span class="option-label">Bidirectional Sync</span>
                    <span class="option-desc">Update Google Sheet when items are edited in PartsForm</span>
                  </div>
                </label>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="create-actions">
            <a href="/admin/integrations<%= currentModule ? '?module=' + currentModule : '' %>" class="admin-btn admin-btn-secondary">
              <i data-lucide="arrow-left"></i>
              Cancel
            </a>
            <button type="button" class="admin-btn" style="background: var(--admin-bg-tertiary); color: var(--admin-text-primary);" onclick="testConnection()">
              <i data-lucide="play"></i>
              Test Connection
            </button>
            <button type="button" class="admin-btn admin-btn-primary" onclick="saveConnection()">
              <i data-lucide="save"></i>
              Create Connection
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Connection type switching
    document.querySelectorAll('input[name="connectionType"]').forEach(function(radio) {
      radio.addEventListener('change', function() {
        // Hide all config sections
        document.querySelectorAll('.config-section').forEach(function(section) {
          section.style.display = 'none';
        });
        // Show selected config section
        var configId = 'config-' + this.value;
        var configSection = document.getElementById(configId);
        if (configSection) {
          configSection.style.display = 'block';
        }
        // Update card styles
        document.querySelectorAll('.connection-type-card').forEach(function(card) {
          card.classList.remove('selected');
        });
        this.closest('.connection-type-card').classList.add('selected');
        if (typeof lucide !== 'undefined') lucide.createIcons();
      });
    });

    // Initialize first card as selected
    document.querySelector('.connection-type-card').classList.add('selected');

    // Excel Upload Zone Interaction
    const uploadZone = document.getElementById('excelUploadZone');
    const fileInput = document.getElementById('excelFileInput');

    if (uploadZone && fileInput) {
      uploadZone.addEventListener('click', () => fileInput.click());

      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('drag-active');
      });

      ['dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, () => {
          uploadZone.classList.remove('drag-active');
        });
      });

      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        const files = e.dataTransfer.files;
        if (files.length) handleFiles(files);
      });

      fileInput.addEventListener('change', () => {
        if (fileInput.files.length) handleFiles(fileInput.files);
      });
    }

    function handleFiles(files) {
      const file = files[0];
      const uploadText = uploadZone.querySelector('.upload-text p');
      uploadText.innerHTML = `<strong>Selected: ${file.name}</strong>`;
      uploadZone.style.borderColor = 'var(--admin-success)';
      uploadZone.style.background = 'var(--admin-success-light)';
    }

    // Toggle password visibility
    function togglePassword(inputId) {
      var input = document.getElementById(inputId);
      var btn = input.nextElementSibling;
      if (input.type === 'password') {
        input.type = 'text';
        btn.innerHTML = '<i data-lucide="eye-off"></i>';
      } else {
        input.type = 'password';
        btn.innerHTML = '<i data-lucide="eye"></i>';
      }
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    // Test connection
    function testConnection() {
      alert('Testing connection... (UI Demo - would test actual connection)');
    }

    // Save connection
    function saveConnection() {
      window.location.href = '/admin/integrations<%= currentModule ? "?module=" + currentModule : "" %>';
    }
  </script>

<%- include('partials/footer') %>
