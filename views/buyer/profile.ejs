<%- include('partials/header') %>
<link rel="stylesheet" href="/css/buyerCSS/buyer-main.css">
<link rel="stylesheet" href="/css/buyerCSS/profile.css">

<%- include('partials/navbar') %>

<!-- ====================================
     PROFILE PAGE - PROFESSIONAL DESIGN
     ==================================== -->
<div class="profile-page">
  <!-- Hero Section -->
  <div class="profile-hero">
    <div class="profile-hero-content">
      <div class="profile-badge">
        <i data-lucide="user-circle"></i>
        <span>My Profile</span>
      </div>

      <h1 class="profile-hero-title">User Profile</h1>
      <p class="profile-hero-subtitle">
        Manage your personal information and account details
      </p>
    </div>
  </div>

  <!-- Main Content -->
  <div class="buyer-container">
    <div class="profile-section">
      <div class="profile-layout">
        <!-- Left Column - Profile Card -->
        <div class="profile-card-main">
          <div class="profile-avatar-section">
            <div class="profile-avatar-wrapper">
              <div class="profile-avatar" id="profileAvatar">
                <% if (buyer.avatar) { %>
                  <img src="<%= buyer.avatar %>" alt="Profile Avatar" class="avatar-image" id="avatarImage">
                <% } else { %>
                  <span class="avatar-initials" id="avatarInitials"><%= buyer.firstName.charAt(0).toUpperCase() %><%= buyer.lastName.charAt(0).toUpperCase() %></span>
                <% } %>
              </div>
              <button class="avatar-edit-btn" id="avatarEditBtn" title="Change Avatar">
                <i data-lucide="camera"></i>
              </button>
              <!-- Hidden file input for avatar upload -->
              <input type="file" id="avatarInput" accept="image/jpeg,image/jpg,image/png,image/webp,image/gif" style="display: none;">
            </div>
            <h2 class="profile-name" id="profileName"><%= buyer.fullName %></h2>
            <p class="profile-email" id="profileEmail"><%= buyer.email %></p>
            <p class="profile-company"><%= buyer.companyName %></p>
            <div class="profile-status">
              <% if (buyer.isActive) { %>
              <span class="status-badge active">
                <i data-lucide="check-circle"></i>
                <span>Active Account</span>
              </span>
              <% } else { %>
              <span class="status-badge inactive">
                <i data-lucide="x-circle"></i>
                <span>Inactive</span>
              </span>
              <% } %>
            </div>
          </div>

          <div class="profile-stats">
            <div class="profile-stat-item">
              <div class="stat-icon">
                <i data-lucide="package"></i>
              </div>
              <div class="stat-content">
                <span class="stat-value" id="totalOrders">0</span>
                <span class="stat-label">Total Orders</span>
              </div>
            </div>
            <div class="profile-stat-item">
              <div class="stat-icon">
                <i data-lucide="calendar"></i>
              </div>
              <div class="stat-content">
                <span class="stat-value" id="memberSince"><%= buyer.memberSince %></span>
                <span class="stat-label">Member Since</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column - Profile Information -->
        <div class="profile-info-section">
          <!-- Personal Information Card -->
          <div class="info-card">
            <div class="info-card-header">
              <div class="info-card-title-wrapper">
                <i data-lucide="user"></i>
                <h3 class="info-card-title">Personal Information</h3>
              </div>
              <button class="info-card-edit-btn" id="editPersonalInfoBtn">
                <i data-lucide="edit"></i>
                <span>Edit</span>
              </button>
            </div>
            <div class="info-card-body">
              <div class="info-row">
                <div class="info-label">
                  <i data-lucide="user"></i>
                  <span>Full Name</span>
                </div>
                <div class="info-value" id="fullNameValue"><%= buyer.fullName %></div>
              </div>
              <div class="info-row">
                <div class="info-label">
                  <i data-lucide="mail"></i>
                  <span>Email Address</span>
                </div>
                <div class="info-value" id="emailValue"><%= buyer.email %></div>
              </div>
              <div class="info-row">
                <div class="info-label">
                  <i data-lucide="phone"></i>
                  <span>Phone Number</span>
                </div>
                <div class="info-value" id="phoneValue"><%= buyer.phone %></div>
              </div>
              <div class="info-row">
                <div class="info-label">
                  <i data-lucide="building-2"></i>
                  <span>Company</span>
                </div>
                <div class="info-value" id="companyValue"><%= buyer.companyName %></div>
              </div>
            </div>
          </div>

          <!-- Address Information Card -->
          <div class="info-card">
            <div class="info-card-header">
              <div class="info-card-title-wrapper">
                <i data-lucide="map-pin"></i>
                <h3 class="info-card-title">My Addresses</h3>
              </div>
              <a href="/buyer/delivery" class="info-card-edit-btn">
                <i data-lucide="plus"></i>
                <span>Manage</span>
              </a>
            </div>
            <div class="info-card-body">
              <div class="addresses-container" id="addressesContainer">
                <div class="addresses-loading">
                  <div class="spinner"></div>
                  <span>Loading addresses...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Account Security Card -->
          <div class="info-card">
            <div class="info-card-header">
              <div class="info-card-title-wrapper">
                <i data-lucide="shield"></i>
                <h3 class="info-card-title">Account Security</h3>
              </div>
            </div>
            <div class="info-card-body">
              <div class="info-row">
                <div class="info-label">
                  <i data-lucide="lock"></i>
                  <span>Password</span>
                </div>
                <div class="info-value-action">
                  <span class="info-value-text">Last changed <%= buyer.passwordLastChanged %> days ago</span>
                  <button class="info-action-btn" id="changePasswordBtn">
                    <i data-lucide="key"></i>
                    <span>Change Password</span>
                  </button>
                </div>
              </div>
              <div class="info-row">
                <div class="info-label">
                  <i data-lucide="smartphone"></i>
                  <span>Two-Factor Authentication</span>
                </div>
                <div class="info-value-action">
                  <span class="info-value-text">Not enabled</span>
                  <button class="info-action-btn" id="enable2FABtn">
                    <i data-lucide="shield-check"></i>
                    <span>Enable 2FA</span>
                  </button>
                </div>
              </div>
              <div class="info-row">
                <div class="info-label">
                  <i data-lucide="mail-check"></i>
                  <span>Newsletter</span>
                </div>
                <div class="info-value-action">
                  <span class="info-value-text"><%= buyer.newsletter ? 'Subscribed' : 'Not subscribed' %></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('partials/quick-search') %>
<%- include('partials/footer') %>

<!-- Avatar Upload Modal -->
<div class="avatar-upload-modal" id="avatarUploadModal">
  <div class="avatar-modal-backdrop" id="avatarModalBackdrop"></div>
  <div class="avatar-modal-content">
    <button class="avatar-modal-close" id="avatarModalClose">
      <i data-lucide="x"></i>
    </button>
    <div class="avatar-modal-header">
      <h3>Upload Profile Photo</h3>
      <p>Choose a new profile picture</p>
    </div>
    <div class="avatar-upload-area" id="avatarUploadArea">
      <div class="upload-preview" id="uploadPreview" style="display: none;">
        <img src="" alt="Preview" id="previewImage">
      </div>
      <div class="upload-placeholder" id="uploadPlaceholder">
        <i data-lucide="image-plus"></i>
        <span>Drop image here or click to browse</span>
        <span class="upload-hint">Supports: JPG, PNG, WebP, GIF (Max 5MB)</span>
      </div>
    </div>
    <div class="avatar-modal-actions">
      <button class="btn-cancel" id="avatarCancelBtn">Cancel</button>
      <button class="btn-upload" id="avatarUploadBtn" disabled>
        <i data-lucide="upload"></i>
        <span>Upload Photo</span>
      </button>
    </div>
    <div class="upload-progress" id="uploadProgress" style="display: none;">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <span class="progress-text" id="progressText">Uploading...</span>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div class="profile-modal" id="editProfileModal">
  <div class="profile-modal-backdrop" id="editProfileBackdrop"></div>
  <div class="profile-modal-content">
    <button class="profile-modal-close" id="editProfileClose">
      <i data-lucide="x"></i>
    </button>
    <div class="profile-modal-header">
      <div class="modal-icon">
        <i data-lucide="user-pen"></i>
      </div>
      <h3>Edit Personal Information</h3>
      <p>Update your personal details below</p>
    </div>
    <form id="editProfileForm" class="profile-form">
      <div class="form-grid">
        <div class="form-group">
          <label for="editFirstName">First Name</label>
          <input type="text" id="editFirstName" name="firstName" value="<%= buyer.firstName %>" required>
        </div>
        <div class="form-group">
          <label for="editLastName">Last Name</label>
          <input type="text" id="editLastName" name="lastName" value="<%= buyer.lastName %>" required>
        </div>
      </div>
      <div class="form-group">
        <label for="editPhone">Phone Number</label>
        <input type="tel" id="editPhone" name="phone" value="<%= buyer.phone %>" required>
      </div>
      <div class="form-group">
        <label for="editCompanyName">Company Name</label>
        <input type="text" id="editCompanyName" name="companyName" value="<%= buyer.companyName %>" required>
      </div>
      <div class="form-group">
        <label for="editCity">City</label>
        <input type="text" id="editCity" name="city" value="<%= buyer.city %>" required>
      </div>
      <div class="form-group">
        <label for="editShippingAddress">Default Shipping Address</label>
        <textarea id="editShippingAddress" name="shippingAddress" rows="3" required><%= buyer.shippingAddress %></textarea>
      </div>
      <div class="form-message" id="editProfileMessage"></div>
      <div class="profile-modal-actions">
        <button type="button" class="btn-cancel" id="editProfileCancelBtn">Cancel</button>
        <button type="submit" class="btn-save" id="editProfileSaveBtn">
          <i data-lucide="check"></i>
          <span>Save Changes</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Change Password Modal -->
<div class="profile-modal" id="changePasswordModal">
  <div class="profile-modal-backdrop" id="changePasswordBackdrop"></div>
  <div class="profile-modal-content">
    <button class="profile-modal-close" id="changePasswordClose">
      <i data-lucide="x"></i>
    </button>
    <div class="profile-modal-header">
      <div class="modal-icon warning">
        <i data-lucide="key-round"></i>
      </div>
      <h3>Change Password</h3>
      <p>Enter your current password and choose a new one</p>
    </div>
    <form id="changePasswordForm" class="profile-form">
      <div class="form-group">
        <label for="currentPassword">Current Password</label>
        <div class="password-input-wrapper">
          <input type="password" id="currentPassword" name="currentPassword" required>
          <button type="button" class="toggle-password" data-target="currentPassword">
            <i data-lucide="eye"></i>
          </button>
        </div>
      </div>
      <div class="form-group">
        <label for="newPassword">New Password</label>
        <div class="password-input-wrapper">
          <input type="password" id="newPassword" name="newPassword" required minlength="8">
          <button type="button" class="toggle-password" data-target="newPassword">
            <i data-lucide="eye"></i>
          </button>
        </div>
        <span class="form-hint">Minimum 8 characters</span>
      </div>
      <div class="form-group">
        <label for="confirmPassword">Confirm New Password</label>
        <div class="password-input-wrapper">
          <input type="password" id="confirmPassword" name="confirmPassword" required minlength="8">
          <button type="button" class="toggle-password" data-target="confirmPassword">
            <i data-lucide="eye"></i>
          </button>
        </div>
      </div>
      <div class="password-requirements">
        <p class="requirements-title">Password requirements:</p>
        <ul>
          <li id="reqLength"><i data-lucide="circle"></i> At least 8 characters</li>
          <li id="reqMatch"><i data-lucide="circle"></i> Passwords match</li>
        </ul>
      </div>
      <div class="form-message" id="changePasswordMessage"></div>
      <div class="profile-modal-actions">
        <button type="button" class="btn-cancel" id="changePasswordCancelBtn">Cancel</button>
        <button type="submit" class="btn-save" id="changePasswordSaveBtn">
          <i data-lucide="lock"></i>
          <span>Update Password</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Notification Toast -->
<div class="notification-toast" id="notificationToast">
  <div class="notification-icon">
    <i data-lucide="check-circle"></i>
  </div>
  <div class="notification-content">
    <span class="notification-message" id="notificationMessage"></span>
  </div>
  <button class="notification-close" id="notificationClose">
    <i data-lucide="x"></i>
  </button>
</div>

<script src="/js/main.js"></script>
<script src="/js/quick-search.js"></script>
<script src="/js/cart.js"></script>
<script src="/js/cart-badge-updater.js"></script>
<script>
  lucide.createIcons();
  window.addEventListener('load', () => lucide.createIcons());

  // ====================================
  // AVATAR UPLOAD FUNCTIONALITY
  // ====================================
  (function() {
    'use strict';

    // Elements
    const avatarEditBtn = document.getElementById('avatarEditBtn');
    const avatarInput = document.getElementById('avatarInput');
    const avatarUploadModal = document.getElementById('avatarUploadModal');
    const avatarModalBackdrop = document.getElementById('avatarModalBackdrop');
    const avatarModalClose = document.getElementById('avatarModalClose');
    const avatarUploadArea = document.getElementById('avatarUploadArea');
    const uploadPreview = document.getElementById('uploadPreview');
    const previewImage = document.getElementById('previewImage');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const avatarCancelBtn = document.getElementById('avatarCancelBtn');
    const avatarUploadBtn = document.getElementById('avatarUploadBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const profileAvatar = document.getElementById('profileAvatar');

    let selectedFile = null;

    // Open modal
    function openModal() {
      avatarUploadModal.classList.add('active');
      document.body.style.overflow = 'hidden';
      lucide.createIcons();
    }

    // Close modal
    function closeModal() {
      avatarUploadModal.classList.remove('active');
      document.body.style.overflow = '';
      resetUpload();
    }

    // Reset upload state
    function resetUpload() {
      selectedFile = null;
      previewImage.src = '';
      uploadPreview.style.display = 'none';
      uploadPlaceholder.style.display = 'flex';
      avatarUploadBtn.disabled = true;
      uploadProgress.style.display = 'none';
      progressFill.style.width = '0%';
      avatarInput.value = '';
    }

    // Handle file selection
    function handleFileSelect(file) {
      if (!file) return;

      // Validate file type
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
      if (!allowedTypes.includes(file.type)) {
        alert('Invalid file type. Please upload a JPG, PNG, WebP, or GIF image.');
        return;
      }

      // Validate file size (5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('File too large. Maximum size is 5MB.');
        return;
      }

      selectedFile = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImage.src = e.target.result;
        uploadPreview.style.display = 'block';
        uploadPlaceholder.style.display = 'none';
        avatarUploadBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    }

    // Upload avatar
    async function uploadAvatar() {
      if (!selectedFile) return;

      const formData = new FormData();
      formData.append('avatar', selectedFile);

      // Show progress
      avatarUploadBtn.disabled = true;
      uploadProgress.style.display = 'block';

      try {
        const response = await fetch('/buyer/profile/avatar', {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          progressFill.style.width = '100%';
          progressText.textContent = 'Upload complete!';

          // Update avatar display
          const avatarInitials = document.getElementById('avatarInitials');
          let avatarImage = document.getElementById('avatarImage');

          if (avatarInitials) {
            avatarInitials.style.display = 'none';
          }

          if (!avatarImage) {
            avatarImage = document.createElement('img');
            avatarImage.id = 'avatarImage';
            avatarImage.className = 'avatar-image';
            avatarImage.alt = 'Profile Avatar';
            profileAvatar.appendChild(avatarImage);
          }

          avatarImage.src = result.data.avatar + '?t=' + Date.now();
          avatarImage.style.display = 'block';

          // Close modal after delay
          setTimeout(() => {
            closeModal();
          }, 1000);
        } else {
          throw new Error(result.message || 'Upload failed');
        }
      } catch (error) {
        console.error('Upload error:', error);
        progressText.textContent = 'Upload failed. Please try again.';
        progressFill.style.background = '#ef4444';
        avatarUploadBtn.disabled = false;
      }
    }

    // Event listeners
    if (avatarEditBtn) {
      avatarEditBtn.addEventListener('click', openModal);
    }

    if (avatarModalBackdrop) {
      avatarModalBackdrop.addEventListener('click', closeModal);
    }

    if (avatarModalClose) {
      avatarModalClose.addEventListener('click', closeModal);
    }

    if (avatarCancelBtn) {
      avatarCancelBtn.addEventListener('click', closeModal);
    }

    if (avatarUploadBtn) {
      avatarUploadBtn.addEventListener('click', uploadAvatar);
    }

    // File input change
    if (avatarInput) {
      avatarInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
          handleFileSelect(e.target.files[0]);
        }
      });
    }

    // Click on upload area
    if (avatarUploadArea) {
      avatarUploadArea.addEventListener('click', () => {
        avatarInput.click();
      });

      // Drag and drop
      avatarUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        avatarUploadArea.classList.add('dragover');
      });

      avatarUploadArea.addEventListener('dragleave', () => {
        avatarUploadArea.classList.remove('dragover');
      });

      avatarUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        avatarUploadArea.classList.remove('dragover');
        
        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
          handleFileSelect(e.dataTransfer.files[0]);
        }
      });
    }

    // ESC key to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && avatarUploadModal.classList.contains('active')) {
        closeModal();
      }
    });
  })();

  // ====================================
  // PROFILE EDITING FUNCTIONALITY
  // ====================================
  (function() {
    'use strict';

    // Wait for DOM to be ready
    function init() {
      // ====================================
      // NOTIFICATION SYSTEM
      // ====================================
      function showNotification(message, type = 'success') {
        const toast = document.getElementById('notificationToast');
        const msgEl = document.getElementById('notificationMessage');
        const iconEl = toast.querySelector('.notification-icon i');
        
        if (!toast || !msgEl) return;

        msgEl.textContent = message;
        toast.className = 'notification-toast show ' + type;
        
        // Update icon based on type
        if (iconEl) {
          iconEl.setAttribute('data-lucide', type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'alert-circle');
          lucide.createIcons();
        }

        // Auto hide after 4 seconds
        setTimeout(() => {
          toast.classList.remove('show');
        }, 4000);
      }

      // Close notification
      const notificationClose = document.getElementById('notificationClose');
      if (notificationClose) {
        notificationClose.addEventListener('click', () => {
          document.getElementById('notificationToast').classList.remove('show');
        });
      }

      // ====================================
      // LOAD ADDRESSES
      // ====================================
      async function loadAddresses() {
        const container = document.getElementById('addressesContainer');
        if (!container) {
          console.error('Addresses container not found');
          return;
        }

        try {
          const response = await fetch('/buyer/api/addresses');
          
          if (!response.ok) {
            throw new Error('Failed to fetch addresses');
          }
          
          const result = await response.json();

          if (result.success && result.addresses && result.addresses.length > 0) {
            renderAddresses(result.addresses);
          } else {
            container.innerHTML = `
              <div class="no-addresses">
                <i data-lucide="map-pin-off"></i>
                <p>No saved addresses</p>
                <a href="/buyer/delivery" class="add-address-link">
                  <i data-lucide="plus"></i>
                  Add your first address
                </a>
              </div>
            `;
            lucide.createIcons();
          }
        } catch (error) {
          console.error('Error loading addresses:', error);
          container.innerHTML = `
            <div class="addresses-error">
              <i data-lucide="alert-triangle"></i>
              <p>Failed to load addresses</p>
            </div>
          `;
          lucide.createIcons();
        }
      }

      function renderAddresses(addresses) {
        const container = document.getElementById('addressesContainer');
        if (!container) return;

        const html = addresses.map(addr => `
          <div class="address-item ${addr.isDefault ? 'default' : ''}">
            <div class="address-item-header">
              <span class="address-label">
                <i data-lucide="tag"></i>
                ${addr.label}
              </span>
              ${addr.isDefault ? '<span class="default-badge">Default</span>' : ''}
            </div>
            <div class="address-item-body">
              <p class="address-name">${addr.fullName}</p>
              <p class="address-line">${addr.street}</p>
              <p class="address-line">${addr.city}, ${addr.state} ${addr.postalCode || ''}</p>
              <p class="address-line">${addr.country}</p>
              ${addr.phone ? `<p class="address-phone"><i data-lucide="phone"></i> ${addr.phone}</p>` : ''}
            </div>
          </div>
        `).join('');

        container.innerHTML = html;
        lucide.createIcons();
      }

      // Load addresses on page load
      loadAddresses();

      // ====================================
      // EDIT PROFILE MODAL
      // ====================================
      const editProfileModal = document.getElementById('editProfileModal');
      const editProfileBackdrop = document.getElementById('editProfileBackdrop');
      const editProfileClose = document.getElementById('editProfileClose');
      const editProfileCancelBtn = document.getElementById('editProfileCancelBtn');
      const editProfileForm = document.getElementById('editProfileForm');
      const editProfileSaveBtn = document.getElementById('editProfileSaveBtn');
      const editPersonalInfoBtn = document.getElementById('editPersonalInfoBtn');

      function openEditProfileModal() {
        if (editProfileModal) {
          editProfileModal.classList.add('active');
          document.body.style.overflow = 'hidden';
          lucide.createIcons();
        }
      }

      function closeEditProfileModal() {
        if (editProfileModal) {
          editProfileModal.classList.remove('active');
          document.body.style.overflow = '';
          // Clear message
          const msg = document.getElementById('editProfileMessage');
          if (msg) msg.innerHTML = '';
        }
      }

      if (editPersonalInfoBtn) {
        editPersonalInfoBtn.addEventListener('click', openEditProfileModal);
      }

      if (editProfileBackdrop) {
        editProfileBackdrop.addEventListener('click', closeEditProfileModal);
      }

      if (editProfileClose) {
        editProfileClose.addEventListener('click', closeEditProfileModal);
      }

      if (editProfileCancelBtn) {
        editProfileCancelBtn.addEventListener('click', closeEditProfileModal);
      }

    // Handle profile form submission
      if (editProfileForm) {
        editProfileForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const saveBtn = editProfileSaveBtn;
          const msgEl = document.getElementById('editProfileMessage');
          
          // Show loading
          saveBtn.disabled = true;
          saveBtn.innerHTML = '<div class="btn-spinner"></div><span>Saving...</span>';

          const formData = {
            firstName: document.getElementById('editFirstName').value.trim(),
            lastName: document.getElementById('editLastName').value.trim(),
            phone: document.getElementById('editPhone').value.trim(),
            companyName: document.getElementById('editCompanyName').value.trim(),
            city: document.getElementById('editCity').value.trim(),
            shippingAddress: document.getElementById('editShippingAddress').value.trim()
          };

          try {
            const response = await fetch('/buyer/profile', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (result.success) {
              // Update page values
              document.getElementById('fullNameValue').textContent = result.data.fullName;
              document.getElementById('phoneValue').textContent = result.data.phone;
              document.getElementById('companyValue').textContent = result.data.companyName;
              document.getElementById('profileName').textContent = result.data.fullName;

              showNotification('Profile updated successfully', 'success');
              closeEditProfileModal();
            } else {
              throw new Error(result.message || 'Update failed');
            }
          } catch (error) {
            console.error('Profile update error:', error);
            if (msgEl) {
              msgEl.innerHTML = `<div class="form-error"><i data-lucide="alert-circle"></i> ${error.message}</div>`;
              lucide.createIcons();
            }
          } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i data-lucide="check"></i><span>Save Changes</span>';
            lucide.createIcons();
          }
        });
      }

      // ====================================
      // CHANGE PASSWORD MODAL
      // ====================================
      const changePasswordModal = document.getElementById('changePasswordModal');
      const changePasswordBackdrop = document.getElementById('changePasswordBackdrop');
      const changePasswordClose = document.getElementById('changePasswordClose');
      const changePasswordCancelBtn = document.getElementById('changePasswordCancelBtn');
      const changePasswordForm = document.getElementById('changePasswordForm');
      const changePasswordSaveBtn = document.getElementById('changePasswordSaveBtn');
      const changePasswordBtn = document.getElementById('changePasswordBtn');

      function openChangePasswordModal() {
        if (changePasswordModal) {
          changePasswordModal.classList.add('active');
          document.body.style.overflow = 'hidden';
          // Reset form
          if (changePasswordForm) changePasswordForm.reset();
          updatePasswordRequirements();
          lucide.createIcons();
        }
      }

      function closeChangePasswordModal() {
        if (changePasswordModal) {
          changePasswordModal.classList.remove('active');
          document.body.style.overflow = '';
          // Clear message
          const msg = document.getElementById('changePasswordMessage');
          if (msg) msg.innerHTML = '';
          // Reset form
          if (changePasswordForm) changePasswordForm.reset();
          updatePasswordRequirements();
        }
      }

      if (changePasswordBtn) {
        changePasswordBtn.addEventListener('click', openChangePasswordModal);
      }

      if (changePasswordBackdrop) {
        changePasswordBackdrop.addEventListener('click', closeChangePasswordModal);
      }

      if (changePasswordClose) {
        changePasswordClose.addEventListener('click', closeChangePasswordModal);
      }

      if (changePasswordCancelBtn) {
        changePasswordCancelBtn.addEventListener('click', closeChangePasswordModal);
      }

      // Toggle password visibility
      document.querySelectorAll('.toggle-password').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.getAttribute('data-target');
          const input = document.getElementById(targetId);
          const icon = btn.querySelector('i');
          
          if (input) {
            const isPassword = input.type === 'password';
            input.type = isPassword ? 'text' : 'password';
            if (icon) {
              icon.setAttribute('data-lucide', isPassword ? 'eye-off' : 'eye');
              lucide.createIcons();
            }
          }
        });
      });

      // Password requirements validation
      const newPasswordInput = document.getElementById('newPassword');
      const confirmPasswordInput = document.getElementById('confirmPassword');

      function updatePasswordRequirements() {
        const newPass = newPasswordInput ? newPasswordInput.value : '';
        const confirmPass = confirmPasswordInput ? confirmPasswordInput.value : '';

        const reqLength = document.getElementById('reqLength');
        const reqMatch = document.getElementById('reqMatch');

        if (reqLength) {
          const icon = reqLength.querySelector('i');
          if (newPass.length >= 8) {
            reqLength.classList.add('valid');
            if (icon) icon.setAttribute('data-lucide', 'check-circle');
          } else {
            reqLength.classList.remove('valid');
            if (icon) icon.setAttribute('data-lucide', 'circle');
          }
        }

        if (reqMatch) {
          const icon = reqMatch.querySelector('i');
          if (newPass && confirmPass && newPass === confirmPass) {
            reqMatch.classList.add('valid');
            if (icon) icon.setAttribute('data-lucide', 'check-circle');
          } else {
            reqMatch.classList.remove('valid');
            if (icon) icon.setAttribute('data-lucide', 'circle');
          }
        }

        lucide.createIcons();
      }

      if (newPasswordInput) {
        newPasswordInput.addEventListener('input', updatePasswordRequirements);
      }
      if (confirmPasswordInput) {
        confirmPasswordInput.addEventListener('input', updatePasswordRequirements);
      }

      // Handle password change form submission
      if (changePasswordForm) {
        changePasswordForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const saveBtn = changePasswordSaveBtn;
          const msgEl = document.getElementById('changePasswordMessage');
          
          const currentPassword = document.getElementById('currentPassword').value;
          const newPassword = document.getElementById('newPassword').value;
          const confirmPassword = document.getElementById('confirmPassword').value;

          // Validate
          if (newPassword.length < 8) {
            msgEl.innerHTML = '<div class="form-error"><i data-lucide="alert-circle"></i> New password must be at least 8 characters</div>';
            lucide.createIcons();
            return;
          }

          if (newPassword !== confirmPassword) {
            msgEl.innerHTML = '<div class="form-error"><i data-lucide="alert-circle"></i> Passwords do not match</div>';
            lucide.createIcons();
            return;
          }

          // Show loading
          saveBtn.disabled = true;
          saveBtn.innerHTML = '<div class="btn-spinner"></div><span>Updating...</span>';

          try {
            const response = await fetch('/buyer/profile/password', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                currentPassword,
                newPassword,
                confirmPassword
              })
            });

            const result = await response.json();

            if (result.success) {
              showNotification('Password changed successfully', 'success');
              closeChangePasswordModal();
            } else {
              throw new Error(result.message || 'Password change failed');
            }
          } catch (error) {
            console.error('Password change error:', error);
            if (msgEl) {
              msgEl.innerHTML = `<div class="form-error"><i data-lucide="alert-circle"></i> ${error.message}</div>`;
              lucide.createIcons();
            }
          } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i data-lucide="lock"></i><span>Update Password</span>';
            lucide.createIcons();
          }
        });
      }

      // ESC key to close modals
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (editProfileModal && editProfileModal.classList.contains('active')) {
            closeEditProfileModal();
          }
          if (changePasswordModal && changePasswordModal.classList.contains('active')) {
            closeChangePasswordModal();
          }
        }
      });
    } // End of init function

    // Run init when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
