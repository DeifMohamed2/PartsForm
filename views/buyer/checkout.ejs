<%- include('partials/header') %>
  <link rel="stylesheet" href="/css/buyerCSS/buyer-main.css">
  <link rel="stylesheet" href="/css/buyerCSS/checkout.css">

  <%- include('partials/navbar') %>

    <!-- ====================================
     CHECKOUT PAGE - PROFESSIONAL DESIGN
     ==================================== -->
    <div class="checkout-page">
      <!-- Compact Header Bar -->
      <div class="checkout-header-bar">
        <div class="container">
          <div class="header-bar-content">
            <div class="header-left">
              <h1 class="header-title"><%= t('checkout.title') %></h1>
              <p class="header-subtitle" id="checkout-subtitle"><%= t('checkout.subtitle') %></p>
            </div>
            <div class="header-right">
              <div class="checkout-badge" id="secure-badge">
                <i data-lucide="shield-check"></i>
                <span><%= t('checkout.secureBadge') %></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Checkout Content -->
      <div class="checkout-content">
        <div class="container">
          <div class="checkout-grid">
            <!-- Left Column - Payment Information -->
            <div class="checkout-main">
              <!-- Step Indicator -->
              <div class="checkout-steps">
                <div class="step-item active" data-step="1">
                  <div class="step-number">1</div>
                  <div class="step-info">
                    <span class="step-title"><%= t('delivery.title') %></span>
                    <span class="step-desc"><%= t('checkout.steps.paymentType.desc') %></span>
                  </div>
                </div>
                <div class="step-item" data-step="2">
                  <div class="step-number">2</div>
                  <div class="step-info">
                    <span class="step-title"><%= t('checkout.steps.paymentType.title') %></span>
                    <span class="step-desc"><%= t('checkout.steps.paymentType.desc') %></span>
                  </div>
                </div>
                <div class="step-item" data-step="3">
                  <div class="step-number">3</div>
                  <div class="step-info">
                    <span class="step-title"><%= t('checkout.steps.paymentMethod.title') %></span>
                    <span class="step-desc"><%= t('checkout.steps.paymentMethod.desc') %></span>
                  </div>
                </div>
                <div class="step-item" data-step="4">
                  <div class="step-number">4</div>
                  <div class="step-info">
                    <span class="step-title"><%= t('checkout.steps.confirmation.title') %></span>
                    <span class="step-desc"><%= t('checkout.steps.confirmation.desc') %></span>
                  </div>
                </div>
              </div>

              <!-- Step 1: Shipping Address Selection -->
              <div class="checkout-section" id="step-1">
                <div class="section-header">
                  <h2 class="section-title">
                    <i data-lucide="map-pin"></i>
                    <span>Shipping Address</span>
                  </h2>
                  <p class="section-subtitle">Select where you'd like your order delivered</p>
                </div>

                <!-- Skeleton Loading State -->
                <div class="address-skeleton" id="address-skeleton">
                  <div class="skeleton-card">
                    <div class="skeleton-radio"></div>
                    <div class="skeleton-content">
                      <div class="skeleton-header">
                        <div class="skeleton-line skeleton-label"></div>
                        <div class="skeleton-badge"></div>
                      </div>
                      <div class="skeleton-line skeleton-name"></div>
                      <div class="skeleton-line skeleton-phone"></div>
                      <div class="skeleton-line skeleton-address"></div>
                    </div>
                  </div>
                  <div class="skeleton-card">
                    <div class="skeleton-radio"></div>
                    <div class="skeleton-content">
                      <div class="skeleton-header">
                        <div class="skeleton-line skeleton-label"></div>
                      </div>
                      <div class="skeleton-line skeleton-name"></div>
                      <div class="skeleton-line skeleton-phone"></div>
                      <div class="skeleton-line skeleton-address"></div>
                    </div>
                  </div>
                </div>

                <!-- Addresses List -->
                <div class="shipping-addresses" id="shipping-addresses" style="display: none;">
                  <!-- Addresses will be populated by JavaScript -->
                </div>

                <!-- No Addresses State -->
                <div class="no-addresses" id="no-addresses" style="display: none;">
                  <div class="no-addresses-icon">
                    <i data-lucide="map-pin-off"></i>
                  </div>
                  <h3 class="no-addresses-title">No Delivery Addresses</h3>
                  <p class="no-addresses-text">You need to add a delivery address before placing your order</p>
                  <a href="/buyer/delivery" class="btn-add-address-link">
                    <i data-lucide="plus"></i>
                    <span>Add New Address</span>
                  </a>
                </div>

                <!-- Add New Address Link -->
                <div class="add-address-section" id="add-address-section" style="display: none;">
                  <a href="/buyer/delivery" class="add-address-link">
                    <i data-lucide="plus-circle"></i>
                    <span>Add New Address</span>
                  </a>
                </div>

                <div class="section-actions">
                  <button class="btn-next" id="btn-to-step-2" disabled>
                    <span>Continue to Payment Type</span>
                    <i data-lucide="arrow-right"></i>
                  </button>
                </div>
              </div>

              <!-- Step 2: Payment Type Selection -->
              <div class="checkout-section" id="step-2" style="display: none;">
                <div class="section-header">
                  <h2 class="section-title">
                    <i data-lucide="wallet"></i>
                    <span><%= t('checkout.step1.title') %></span>
                  </h2>
                  <p class="section-subtitle"><%= t('checkout.step1.subtitle') %></p>
                </div>

              <div class="payment-types">
                  <div class="payment-type-card" data-type="full">
                    <div class="payment-type-radio">
                      <input type="radio" name="payment-type" id="payment-full" value="full" checked>
                      <label for="payment-full"></label>
                    </div>
                    <div class="payment-type-content">
                      <div class="payment-type-icon full">
                        <i data-lucide="check-circle"></i>
                      </div>
                      <h3 class="payment-type-title"><%= t('checkout.step1.fullPayment.title') %></h3>
                      <p class="payment-type-desc"><%= t('checkout.step1.fullPayment.desc') %></p>
                      <div class="payment-type-badge">
                        <i data-lucide="gift"></i>
                        <span><%= t('checkout.step1.fullPayment.badge') %></span>
                      </div>
                      <div class="payment-type-amount">
                        <span class="amount-label"><%= t('checkout.step1.fullPayment.totalAmount') %></span>
                        <span class="amount-value" id="full-amount">0.00 د.إ</span>
                      </div>
                    </div>
                  </div>

                  <div class="payment-type-card" data-type="partial">
                    <div class="payment-type-radio">
                      <input type="radio" name="payment-type" id="payment-partial" value="partial">
                      <label for="payment-partial"></label>
                    </div>
                    <div class="payment-type-content">
                      <div class="payment-type-icon partial">
                        <i data-lucide="percent"></i>
                      </div>
                      <h3 class="payment-type-title"><%= t('checkout.step1.partialPayment.title') %></h3>
                      <p class="payment-type-desc"><%= t('checkout.step1.partialPayment.desc') %></p>
                      <div class="payment-type-breakdown">
                        <div class="breakdown-item">
                          <span class="breakdown-label"><%= t('checkout.step1.partialPayment.payNow') %></span>
                          <span class="breakdown-value" id="partial-now">0.00 د.إ</span>
                        </div>
                        <div class="breakdown-item">
                          <span class="breakdown-label"><%= t('checkout.step1.partialPayment.payLater') %></span>
                          <span class="breakdown-value" id="partial-later">0.00 د.إ</span>
                        </div>
                      </div>
                      <div class="payment-type-amount">
                        <span class="amount-label"><%= t('checkout.step1.partialPayment.dueNow') %></span>
                        <span class="amount-value" id="partial-amount">0.00 د.إ</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="section-actions">
                  <button class="btn-back" id="btn-to-step-1-back">
                    <i data-lucide="arrow-left"></i>
                    <span><%= t('common.buttons.back') %></span>
                  </button>
                  <button class="btn-next" id="btn-to-step-3">
                    <span><%= t('checkout.step1.continue') %></span>
                    <i data-lucide="arrow-right"></i>
                  </button>
                </div>
              </div>

              <!-- Step 3: Payment Method Selection -->
              <div class="checkout-section" id="step-3" style="display: none;">
                <div class="section-header">
                  <h2 class="section-title">
                    <i data-lucide="credit-card"></i>
                    <span><%= t('checkout.step2.title') %></span>
                  </h2>
                  <p class="section-subtitle"><%= t('checkout.step2.subtitle') %></p>
                </div>

                <div class="payment-methods">
                  <!-- Credit/Debit Card -->
                  <div class="payment-method-card" data-method="card">
                    <div class="payment-method-radio">
                      <input type="radio" name="payment-method" id="method-card" value="card" checked>
                      <label for="method-card"></label>
                    </div>
                    <div class="payment-method-content">
                      <div class="payment-method-header">
                        <div class="payment-method-icon icon-card">
                          <i data-lucide="credit-card"></i>
                        </div>
                        <div class="payment-method-info">
                          <h3 class="payment-method-title"><%= t('checkout.step2.card.title') %></h3>
                          <p class="payment-method-desc"><%= t('checkout.step2.card.desc') %></p>
                        </div>
                      </div>
                      <div class="payment-method-brands">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/Visa.svg" alt="Visa"
                          class="brand-logo">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg"
                          alt="Mastercard" class="brand-logo">
                      </div>
                      <div class="payment-method-fee">
                        <i data-lucide="info"></i>
                        <span><%= t('checkout.step2.card.fee') %></span>
                      </div>
                    </div>
                  </div>

                  <!-- Bank Transfer - Dubai -->
                  <div class="payment-method-card" data-method="bank-dubai">
                    <div class="payment-method-radio">
                      <input type="radio" name="payment-method" id="method-bank-dubai" value="bank-dubai">
                      <label for="method-bank-dubai"></label>
                    </div>
                    <div class="payment-method-content">
                      <div class="payment-method-header">
                        <div class="payment-method-icon icon-bank">
                          <i data-lucide="building-2"></i>
                        </div>
                        <div class="payment-method-info">
                          <h3 class="payment-method-title"><%= t('checkout.step2.bankDubai.title') %></h3>
                          <p class="payment-method-desc"><%= t('checkout.step2.bankDubai.desc') %></p>
                        </div>
                        <div class="payment-method-badge free">
                          <i data-lucide="check-circle"></i>
                          <span><%= t('checkout.step2.bankDubai.noFees') %></span>
                        </div>
                      </div>
                      <div class="payment-method-details">
                        <div class="detail-item">
                          <i data-lucide="clock"></i>
                          <span><%= t('checkout.step2.bankDubai.processingTime') %></span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Bank Transfer - International -->
                  <div class="payment-method-card" data-method="bank-international">
                    <div class="payment-method-radio">
                      <input type="radio" name="payment-method" id="method-bank-intl" value="bank-international">
                      <label for="method-bank-intl"></label>
                    </div>
                    <div class="payment-method-content">
                      <div class="payment-method-header">
                        <div class="payment-method-icon icon-international">
                          <i data-lucide="globe"></i>
                        </div>
                        <div class="payment-method-info">
                          <h3 class="payment-method-title"><%= t('checkout.step2.bankInternational.title') %></h3>
                          <p class="payment-method-desc"><%= t('checkout.step2.bankInternational.desc') %></p>
                        </div>
                      </div>
                      <div class="payment-method-fee">
                        <i data-lucide="alert-circle"></i>
                        <span><%= t('checkout.step2.bankInternational.fee') %></span>
                      </div>
                    </div>
                  </div>

                  <!-- PayPal -->
                  <div class="payment-method-card" data-method="paypal">
                    <div class="payment-method-radio">
                      <input type="radio" name="payment-method" id="method-paypal" value="paypal">
                      <label for="method-paypal"></label>
                    </div>
                    <div class="payment-method-content">
                      <div class="payment-method-header">
                        <div class="payment-method-icon icon-paypal">
                          <i data-lucide="wallet"></i>
                        </div>
                        <div class="payment-method-info">
                          <h3 class="payment-method-title"><%= t('checkout.step2.paypal.title') %></h3>
                          <p class="payment-method-desc"><%= t('checkout.step2.paypal.desc') %></p>
                        </div>
                      </div>
                      <div class="payment-method-fee">
                        <i data-lucide="info"></i>
                        <span><%= t('checkout.step2.paypal.fee') %></span>
                      </div>
                    </div>
                  </div>

                  <!-- Cash on Delivery -->
                  <div class="payment-method-card" data-method="cod">
                    <div class="payment-method-radio">
                      <input type="radio" name="payment-method" id="method-cod" value="cod">
                      <label for="method-cod"></label>
                    </div>
                    <div class="payment-method-content">
                      <div class="payment-method-header">
                        <div class="payment-method-icon icon-cod">
                          <i data-lucide="banknote"></i>
                        </div>
                        <div class="payment-method-info">
                          <h3 class="payment-method-title"><%= t('checkout.step2.cod.title') %></h3>
                          <p class="payment-method-desc"><%= t('checkout.step2.cod.desc') %></p>
                        </div>
                      </div>
                      <div class="payment-method-fee">
                        <i data-lucide="info"></i>
                        <span><%= t('checkout.step2.cod.fee') %></span>
                      </div>
                      <div class="payment-method-note">
                        <i data-lucide="map-pin"></i>
                        <span><%= t('checkout.step2.cod.note') %></span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="section-actions">
                  <button class="btn-back" id="btn-to-step-2-back">
                    <i data-lucide="arrow-left"></i>
                    <span><%= t('checkout.step2.back') %></span>
                  </button>
                  <button class="btn-next" id="btn-to-step-4">
                    <span><%= t('checkout.step2.reviewOrder') %></span>
                    <i data-lucide="arrow-right"></i>
                  </button>
                </div>
              </div>

              <!-- Step 4: Confirmation -->
              <div class="checkout-section" id="step-4" style="display: none;">
                <div class="section-header">
                  <h2 class="section-title">
                    <i data-lucide="check-circle"></i>
                    <span><%= t('checkout.step3.title') %></span>
                  </h2>
                  <p class="section-subtitle"><%= t('checkout.step3.subtitle') %></p>
                </div>

                <div class="confirmation-details">
                  <!-- Shipping Address Summary -->
                  <div class="confirmation-card shipping-summary">
                    <h3 class="confirmation-title">
                      <i data-lucide="truck"></i>
                      <span>Shipping To</span>
                    </h3>
                    <div class="shipping-address-summary" id="shipping-address-summary">
                      <!-- Will be populated by JavaScript -->
                    </div>
                    <button class="btn-change-address" id="btn-change-address">
                      <i data-lucide="edit-2"></i>
                      <span>Change Address</span>
                    </button>
                  </div>

                  <div class="confirmation-card">
                    <h3 class="confirmation-title"><%= t('checkout.step3.summary.title') %></h3>
                    <div class="confirmation-item">
                      <span class="confirmation-label"><%= t('checkout.step3.summary.paymentType') %></span>
                      <span class="confirmation-value" id="confirm-type"><%= t('checkout.step1.fullPayment.title') %></span>
                    </div>
                    <div class="confirmation-item">
                      <span class="confirmation-label"><%= t('checkout.step3.summary.paymentMethod') %></span>
                      <span class="confirmation-value" id="confirm-method"><%= t('checkout.step2.card.title') %></span>
                    </div>
                    <div class="confirmation-item">
                      <span class="confirmation-label"><%= t('checkout.step3.summary.processingFee') %></span>
                      <span class="confirmation-value" id="confirm-fee">0.00 د.إ</span>
                    </div>
                    <div class="confirmation-divider"></div>
                    <div class="confirmation-item total">
                      <span class="confirmation-label"><%= t('checkout.step3.summary.amountToPay') %></span>
                      <span class="confirmation-value" id="confirm-total">0.00 د.إ</span>
                    </div>
                  </div>

                  <div class="confirmation-terms">
                    <label class="checkbox-container">
                      <input type="checkbox" id="terms-checkbox">
                      <span class="checkbox-label"><%= t('checkout.step3.terms') %></span>
                    </label>
                  </div>
                </div>

                <div class="section-actions">
                  <button class="btn-back" id="btn-to-step-3-back">
                    <i data-lucide="arrow-left"></i>
                    <span><%= t('checkout.step3.back') %></span>
                  </button>
                  <button class="btn-complete" id="btn-complete-payment" disabled>
                    <i data-lucide="lock"></i>
                    <span><%= t('checkout.step3.completePayment') %></span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="checkout-sidebar">
              <div class="order-summary sticky">
                <h3 class="summary-title">
                  <i data-lucide="shopping-bag"></i>
                  <span>Order Summary</span>
                </h3>

                <!-- Summary Skeleton Loading -->
                <div class="summary-skeleton" id="summary-skeleton">
                  <div class="skeleton-item">
                    <div class="skeleton-item-info">
                      <div class="skeleton-line skeleton-item-title"></div>
                      <div class="skeleton-line skeleton-item-desc"></div>
                      <div class="skeleton-line skeleton-item-brand"></div>
                    </div>
                    <div class="skeleton-line skeleton-item-price"></div>
                  </div>
                  <div class="skeleton-item">
                    <div class="skeleton-item-info">
                      <div class="skeleton-line skeleton-item-title"></div>
                      <div class="skeleton-line skeleton-item-desc"></div>
                      <div class="skeleton-line skeleton-item-brand"></div>
                    </div>
                    <div class="skeleton-line skeleton-item-price"></div>
                  </div>
                  <div class="skeleton-item">
                    <div class="skeleton-item-info">
                      <div class="skeleton-line skeleton-item-title"></div>
                      <div class="skeleton-line skeleton-item-desc"></div>
                      <div class="skeleton-line skeleton-item-brand"></div>
                    </div>
                    <div class="skeleton-line skeleton-item-price"></div>
                  </div>
                  <div class="summary-divider"></div>
                  <div class="skeleton-totals">
                    <div class="skeleton-total-row">
                      <div class="skeleton-line skeleton-total-label"></div>
                      <div class="skeleton-line skeleton-total-value"></div>
                    </div>
                    <div class="skeleton-total-row">
                      <div class="skeleton-line skeleton-total-label"></div>
                      <div class="skeleton-line skeleton-total-value"></div>
                    </div>
                  </div>
                </div>

                <!-- Summary Content (hidden until loaded) -->
                <div id="summary-content" style="display: none;">
                  <div class="summary-items" id="summary-items">
                    <!-- Items will be populated by JavaScript -->
                  </div>

                  <div class="summary-divider"></div>

                  <div class="summary-totals">
                    <div class="summary-row">
                      <span class="summary-label"><%= t('checkout.summary.subtotal') %></span>
                      <span class="summary-value" id="summary-subtotal">0.00 د.إ</span>
                    </div>
                    <div class="summary-row">
                      <span class="summary-label"><%= t('checkout.summary.items') %></span>
                      <span class="summary-value" id="summary-items-count">0 PCS</span>
                    </div>
                    <div class="summary-row">
                      <span class="summary-label"><%= t('checkout.summary.totalWeight') %></span>
                      <span class="summary-value" id="summary-weight">0.000 kg</span>
                    </div>
                    <div class="summary-row fee" id="summary-fee-row" style="display: none;">
                      <span class="summary-label"><%= t('checkout.summary.processingFee') %></span>
                      <span class="summary-value" id="summary-fee">0.00 د.إ</span>
                    </div>
                  </div>

                  <div class="summary-divider"></div>

                  <div class="summary-total">
                    <span class="total-label"><%= t('checkout.summary.totalAmount') %></span>
                    <span class="total-value" id="summary-total">0.00 د.إ</span>
                  </div>

                  <!-- Referral Discount Section (auto-applied from registration) -->
                  <div class="referral-code-section" id="referral-section" style="display: none;">
                    <div class="referral-code-header">
                      <i data-lucide="gift"></i>
                      <span><%= t('checkout.summary.referralDiscount') %></span>
                    </div>
                    <div class="referral-code-status" id="referral-status" style="display: none;">
                      <div class="referral-success registration-referral" id="referral-success" style="display: none;">
                        <i data-lucide="check-circle"></i>
                        <div class="referral-success-info">
                          <span class="referral-partner-name" id="referral-partner-name"></span>
                          <span class="referral-discount-text" id="referral-discount-text"></span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Referral Discount Row (shown when code applied) -->
                  <div class="summary-row discount" id="summary-referral-row" style="display: none;">
                    <span class="summary-label"><%= t('checkout.summary.referralDiscountLabel') %></span>
                    <span class="summary-value discount-value" id="summary-referral-discount">-0.00 د.إ</span>
                  </div>
                </div>

                <div class="summary-security">
                  <i data-lucide="shield-check"></i>
                  <span><%= t('checkout.summary.security') %></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div class="success-modal" id="success-modal" style="display: none;">
      <div class="success-backdrop"></div>
      <div class="success-content">
        <div class="success-animation">
          <div class="success-checkmark">
            <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
              <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" />
              <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />
            </svg>
          </div>
        </div>
        <h2 class="success-title" id="success-title">Payment Successful!</h2>
        <p class="success-message" id="success-message">Your order has been placed successfully</p>
        <div class="success-details">
          <div class="success-detail-item">
            <span class="detail-label">Order Number:</span>
            <span class="detail-value" id="order-number">ORD-000000</span>
          </div>
          <div class="success-detail-item">
            <span class="detail-label">Payment Method:</span>
            <span class="detail-value" id="payment-method-text">Credit Card</span>
          </div>
          <div class="success-detail-item">
            <span class="detail-label">Amount Paid:</span>
            <span class="detail-value" id="amount-paid">0.00 د.إ</span>
          </div>
        </div>
        <div class="success-actions">
          <a href="/buyer/orders" class="btn-view-orders">
            <i data-lucide="package"></i>
            <span>View My Orders</span>
          </a>
          <a href="/buyer/search-automotive" class="btn-continue-shopping">
            <span>Continue Shopping</span>
            <i data-lucide="arrow-right"></i>
          </a>
        </div>
      </div>
    </div>

    <%- include('partials/quick-search') %>
      <%- include('partials/footer') %>

        <script src="/js/animations.js"></script>
        <script src="/js/main.js"></script>
        <script src="/js/quick-search.js"></script>
        <script src="/js/cart.js"></script>
        <script src="/js/cart-badge-updater.js"></script>
        <script src="/js/checkout.js?v=<%= Date.now() %>"></script>
        <script>
          lucide.createIcons();
          window.addEventListener('load', () => lucide.createIcons());
          // Force navbar to always stay white on checkout page
          document.addEventListener('DOMContentLoaded', () => {
            const navbar = document.getElementById('navbar');
            if (navbar) {
              navbar.classList.add('scrolled');
              // Prevent other scripts from removing the scrolled class
              const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                  if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (!navbar.classList.contains('scrolled')) {
                      navbar.classList.add('scrolled');
                    }
                  }
                });
              });
              observer.observe(navbar, { attributes: true, attributeFilter: ['class'] });
              // Also ensure on scroll
              const ensureScrolled = () => navbar.classList.add('scrolled');
              window.addEventListener('scroll', ensureScrolled, { passive: true });
            }
          });
        </script>