<!-- ====================================
     BUYER NAVIGATION BAR - WITH LOGIN STATE
     ==================================== -->
<nav class="nav-bar" id="navbar">
  <div class="nav-gradient-top"></div>
  <div class="container nav-container">
    <!-- Logo -->
    <div class="nav-logo">
      <a href="/">
        <img src="/images/PARTSFORM-LOGO.webp" alt="PartsForm Logo" class="logo-image">
      </a>
    </div>

    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle mobile menu" aria-expanded="false">
      <span class="menu-icon">
        <span class="menu-line"></span>
        <span class="menu-line"></span>
        <span class="menu-line"></span>
      </span>
    </button>

    <!-- Navigation Links -->
    <div class="nav-links" id="navLinks">
      <!-- Parts Search - Direct link to automotive -->
      <a href="/buyer/search-automotive" class="nav-link" data-section="search">
        <i data-lucide="search" style="width: 16px; height: 16px; margin-right: 4px;"></i>
        <%= t('nav.search') %>
      </a>

      <a href="/buyer/orders" class="nav-link" data-section="orders"><%= t('nav.myOrders') %></a>
      
      <!-- Account Dropdown -->
      <div class="nav-dropdown" id="accountDropdown">
        <button class="nav-link dropdown-trigger" id="accountDropdownBtn">
          <span><%= t('nav.account') || 'Account' %></span>
          <i data-lucide="chevron-down" class="dropdown-chevron"></i>
        </button>
        <div class="nav-dropdown-menu" id="accountDropdownMenu">
          <a href="/buyer/payment" class="nav-dropdown-item" data-section="payment">
            <i data-lucide="credit-card"></i>
            <div>
              <span class="dropdown-item-title"><%= t('nav.payment') %></span>
              <span class="dropdown-item-desc"><%= t('nav.paymentDesc') || 'Manage payment methods' %></span>
            </div>
          </a>
          <a href="/buyer/delivery" class="nav-dropdown-item" data-section="delivery">
            <i data-lucide="truck"></i>
            <div>
              <span class="dropdown-item-title"><%= t('nav.delivery') %></span>
              <span class="dropdown-item-desc"><%= t('nav.deliveryDesc') || 'Shipping addresses' %></span>
            </div>
          </a>
        </div>
      </div>

      <!-- Support Dropdown -->
      <div class="nav-dropdown" id="supportDropdown">
        <button class="nav-link dropdown-trigger" id="supportDropdownBtn">
          <span><%= t('nav.support') || 'Support' %></span>
          <i data-lucide="chevron-down" class="dropdown-chevron"></i>
        </button>
        <div class="nav-dropdown-menu" id="supportDropdownMenu">
          <a href="/buyer/tickets" class="nav-dropdown-item" data-section="tickets">
            <i data-lucide="message-square"></i>
            <div>
              <span class="dropdown-item-title"><%= t('nav.tickets') %></span>
              <span class="dropdown-item-desc"><%= t('nav.ticketsDesc') || 'Support tickets' %></span>
            </div>
          </a>
          <a href="/buyer/contacts" class="nav-dropdown-item" data-section="contacts">
            <i data-lucide="users"></i>
            <div>
              <span class="dropdown-item-title"><%= t('nav.contacts') %></span>
              <span class="dropdown-item-desc"><%= t('nav.contactsDesc') || 'Contact information' %></span>
            </div>
          </a>
        </div>
      </div>

      <a href="/buyer/affiliate" class="nav-link" data-section="affiliate"><%= t('nav.affiliate') %></a>
      
      <!-- More Dropdown for overflow items -->
      <div class="nav-dropdown nav-more-dropdown" id="moreDropdown" style="display: none;">
        <button class="nav-link dropdown-trigger" id="moreDropdownBtn">
          <span><%= t('nav.more') %></span>
          <i data-lucide="chevron-down" class="dropdown-chevron"></i>
        </button>
        <div class="nav-dropdown-menu" id="moreDropdownMenu">
          <!-- Overflow items will be moved here dynamically -->
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="nav-actions" id="navActions">
      <!-- Shopping Cart Button -->
      <a href="/buyer/cart" class="btn-cart" id="cart-btn" title="<%= t('nav.cart') %>">
        <i data-lucide="shopping-cart"></i>
        <span class="cart-badge" id="cart-badge" style="display: none;">0</span>
      </a>

      <!-- Quick Search Button -->
      <button class="btn-quick-search" id="quick-search-btn" title="<%= t('nav.quickSearch') %>">
        <i data-lucide="search"></i>
        <span><%= t('nav.quickSearch') %></span>
      </button>

      <!-- Currency Converter -->
      <button class="btn-currency-converter" id="currency-converter-btn" title="<%= t('nav.currencyConverter') %>">
        <i data-lucide="repeat"></i>
        <span class="currency-label"><%= t('nav.currency.label') %>:</span>
        <span id="current-currency-code" class="currency-code-display">USD</span>
      </button>

      <!-- Preferred Currency Dropdown -->
      <div class="preferred-currency-dropdown" id="preferredCurrencyDropdown">
        <button class="btn-preferred-currency" id="preferredCurrencyBtn" title="<%= t('nav.preferredCurrency') || 'Preferred Currency' %>">
          <i data-lucide="wallet"></i>
          <span class="preferred-currency-code" id="preferredCurrencyCode"><%= user && user.preferredCurrency ? user.preferredCurrency : 'USD' %></span>
          <i data-lucide="chevron-down" class="currency-dropdown-chevron"></i>
        </button>
        <div class="preferred-currency-menu" id="preferredCurrencyMenu">
          <div class="preferred-currency-header">
            <span><%= t('nav.preferredCurrencyTitle') || 'Preferred Currency' %></span>
          </div>
          <div class="preferred-currency-search">
            <i data-lucide="search" class="search-icon"></i>
            <input type="text" id="preferredCurrencySearch" placeholder="<%= t('nav.searchCurrency') || 'Search currency...' %>">
          </div>
          <div class="preferred-currency-list" id="preferredCurrencyList">
            <!-- Currency options populated by JavaScript -->
          </div>
        </div>
      </div>

      <!-- Language Selector -->
      <div class="language-selector">
        <button class="language-btn" id="language-btn">
          <span class="lang-flag" id="current-flag">ðŸ‡¬ðŸ‡§</span>
          <span class="lang-code" id="current-lang">EN</span>
          <i data-lucide="chevron-down" class="lang-chevron"></i>
        </button>
        <div class="language-dropdown" id="language-dropdown">
          <button class="lang-option" data-lang="en" data-flag="ðŸ‡¬ðŸ‡§">
            <span class="lang-flag">ðŸ‡¬ðŸ‡§</span>
            <span class="lang-name"><%= t('nav.language.english') %></span>
          </button>
          <button class="lang-option" data-lang="ar" data-flag="ðŸ‡¸ðŸ‡¦">
            <span class="lang-flag">ðŸ‡¸ðŸ‡¦</span>
            <span class="lang-name"><%= t('nav.language.arabic') %></span>
          </button>
          <button class="lang-option" data-lang="ru" data-flag="ðŸ‡·ðŸ‡º">
            <span class="lang-flag">ðŸ‡·ðŸ‡º</span>
            <span class="lang-name"><%= t('nav.language.russian') %></span>
          </button>
          <button class="lang-option" data-lang="ua" data-flag="ðŸ‡ºðŸ‡¦">
            <span class="lang-flag">ðŸ‡ºðŸ‡¦</span>
            <span class="lang-name"><%= t('nav.language.ukrainian') %></span>
          </button>
          <button class="lang-option" data-lang="fr" data-flag="ðŸ‡«ðŸ‡·">
            <span class="lang-flag">ðŸ‡«ðŸ‡·</span>
            <span class="lang-name"><%= t('nav.language.french') %></span>
          </button>
          <button class="lang-option" data-lang="es" data-flag="ðŸ‡ªðŸ‡¸">
            <span class="lang-flag">ðŸ‡ªðŸ‡¸</span>
            <span class="lang-name"><%= t('nav.language.spanish') %></span>
          </button>
        </div>
      </div>

      <!-- Sign In Button (shown when not logged in) -->
      <% if (!user) { %>
      <button class="btn-secondary btn-sign-in" id="sign-in-btn">
        <i data-lucide="user"></i>
        <span><%= t('nav.user.signIn') %></span>
      </button>
      <% } %>

      <!-- User Profile Dropdown (shown when logged in) -->
      <% if (user) { %>
      <div class="user-profile-dropdown" id="userProfileDropdown">
        <button type="button" class="user-profile-btn user-profile-btn-compact" id="userProfileBtn" title="<%= user.firstName %> <%= user.lastName %>">
          <div class="user-avatar">
            <% if (user.avatar) { %>
              <img src="<%= user.avatar %>" alt="Avatar" class="avatar-image" />
            <% } else { %>
              <span class="avatar-initials"><%= user.firstName ? user.firstName.charAt(0).toUpperCase() : 'U' %><%= user.lastName ? user.lastName.charAt(0).toUpperCase() : '' %></span>
            <% } %>
          </div>
        </button>
        <div class="user-dropdown-menu" id="userDropdownMenu">
          <div class="user-dropdown-header">
            <span class="user-dropdown-name"><%= user.firstName %> <%= user.lastName %></span>
            <span class="user-dropdown-email"><%= user.email %></span>
          </div>
          <div class="user-dropdown-divider"></div>
          <a href="/buyer/profile" class="user-dropdown-item">
            <i data-lucide="user"></i>
            <span><%= t('nav.user.profile') %></span>
          </a>
          <a href="/buyer/settings" class="user-dropdown-item">
            <i data-lucide="settings"></i>
            <span><%= t('nav.user.settings') %></span>
          </a>
          <div class="user-dropdown-divider"></div>
          <button class="user-dropdown-item user-dropdown-logout" id="logoutBtn">
            <i data-lucide="log-out"></i>
            <span><%= t('nav.user.logout') %></span>
          </button>
        </div>
      </div>
      <% } else { %>
      <!-- Hidden dropdown for JS initialization when not logged in -->
      <div class="user-profile-dropdown" id="userProfileDropdown" style="display: none;"></div>
      <% } %>
    </div>
  </div>
</nav>

<!-- Mobile Menu Backdrop -->
<div class="mobile-backdrop" id="mobileBackdrop"></div>

<!-- Currency Converter Modal -->
<div class="currency-converter-modal" id="currencyConverterModal">
  <div class="currency-converter-backdrop" id="currencyConverterBackdrop"></div>
  <div class="currency-converter-container">
    <button class="currency-converter-close" id="currencyConverterClose">
      <i data-lucide="x"></i>
    </button>
    
    <div class="currency-converter-content">
      <!-- Header -->
      <div class="currency-converter-header">
        <span class="currency-badge">
          <i data-lucide="trending-up"></i>
          <%= t('nav.currency.badge') %>
        </span>
        <h2 class="currency-converter-title"><%= t('nav.currency.title') %></h2>
        <p class="currency-converter-subtitle"><%= t('nav.currency.subtitle') %></p>
      </div>

      <!-- Main Converter -->
      <div class="currency-converter-main">
        <!-- From Currency -->
        <div class="currency-input-group">
          <label class="currency-label"><%= t('nav.currency.amount') %></label>
          <div class="currency-input-wrapper">
            <input 
              type="number" 
              class="currency-input" 
              id="currencyAmount"
              placeholder="0.00"
              value="1"
              min="0"
              step="0.01"
            >
            <div class="currency-select-wrapper">
              <button class="currency-select-btn" id="fromCurrencyBtn">
                <span class="currency-flag" id="fromCurrencyFlag">ðŸ‡ºðŸ‡¸</span>
                <span class="currency-code" id="fromCurrencyCode">USD</span>
                <i data-lucide="chevron-down" class="currency-chevron"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Swap Button -->
        <button class="currency-swap-btn" id="currencySwapBtn" title="<%= t('nav.currency.swap') %>">
          <i data-lucide="arrow-down-up"></i>
        </button>

        <!-- To Currency -->
        <div class="currency-input-group">
          <label class="currency-label"><%= t('nav.currency.converted') %></label>
          <div class="currency-input-wrapper">
            <input 
              type="text" 
              class="currency-input currency-result" 
              id="currencyResult"
              placeholder="0.00"
              readonly
            >
            <div class="currency-select-wrapper">
              <button class="currency-select-btn" id="toCurrencyBtn">
                <span class="currency-flag" id="toCurrencyFlag">ðŸ‡ªðŸ‡º</span>
                <span class="currency-code" id="toCurrencyCode">EUR</span>
                <i data-lucide="chevron-down" class="currency-chevron"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Exchange Rate Info -->
        <div class="exchange-rate-info" id="exchangeRateInfo">
          <div class="rate-indicator">
            <i data-lucide="activity"></i>
            <span id="rateText">1 USD = 0.00 EUR</span>
          </div>
          <div class="rate-updated">
            <i data-lucide="clock"></i>
            <span id="rateUpdated"><%= t('nav.currency.updating') %></span>
          </div>
        </div>
      </div>

      <!-- Popular Currencies Quick Select -->
      <div class="popular-currencies">
        <label class="currency-label"><%= t('nav.currency.popular') %></label>
        <div class="popular-currencies-grid">
          <button class="popular-currency-btn" data-currency="USD" data-flag="ðŸ‡ºðŸ‡¸">
            <span class="currency-flag">ðŸ‡ºðŸ‡¸</span>
            <span class="currency-info">
              <span class="currency-name">USD</span>
              <span class="currency-full">US Dollar</span>
            </span>
          </button>
          <button class="popular-currency-btn" data-currency="EUR" data-flag="ðŸ‡ªðŸ‡º">
            <span class="currency-flag">ðŸ‡ªðŸ‡º</span>
            <span class="currency-info">
              <span class="currency-name">EUR</span>
              <span class="currency-full">Euro</span>
            </span>
          </button>
          <button class="popular-currency-btn" data-currency="GBP" data-flag="ðŸ‡¬ðŸ‡§">
            <span class="currency-flag">ðŸ‡¬ðŸ‡§</span>
            <span class="currency-info">
              <span class="currency-name">GBP</span>
              <span class="currency-full">British Pound</span>
            </span>
          </button>
          <button class="popular-currency-btn" data-currency="AED" data-flag="ðŸ‡¦ðŸ‡ª">
            <span class="currency-flag">ðŸ‡¦ðŸ‡ª</span>
            <span class="currency-info">
              <span class="currency-name">AED</span>
              <span class="currency-full">UAE Dirham</span>
            </span>
          </button>
          <button class="popular-currency-btn" data-currency="JPY" data-flag="ðŸ‡¯ðŸ‡µ">
            <span class="currency-flag">ðŸ‡¯ðŸ‡µ</span>
            <span class="currency-info">
              <span class="currency-name">JPY</span>
              <span class="currency-full">Japanese Yen</span>
            </span>
          </button>
          <button class="popular-currency-btn" data-currency="CNY" data-flag="ðŸ‡¨ðŸ‡³">
            <span class="currency-flag">ðŸ‡¨ðŸ‡³</span>
            <span class="currency-info">
              <span class="currency-name">CNY</span>
              <span class="currency-full">Chinese Yuan</span>
            </span>
          </button>
          <button class="popular-currency-btn" data-currency="RUB" data-flag="ðŸ‡·ðŸ‡º">
            <span class="currency-flag">ðŸ‡·ðŸ‡º</span>
            <span class="currency-info">
              <span class="currency-name">RUB</span>
              <span class="currency-full">Russian Ruble</span>
            </span>
          </button>
          <button class="popular-currency-btn" data-currency="CAD" data-flag="ðŸ‡¨ðŸ‡¦">
            <span class="currency-flag">ðŸ‡¨ðŸ‡¦</span>
            <span class="currency-info">
              <span class="currency-name">CAD</span>
              <span class="currency-full">Canadian Dollar</span>
            </span>
          </button>
        </div>
      </div>

      <!-- All Currencies Dropdown (Hidden by default) -->
      <div class="all-currencies-dropdown" id="allCurrenciesDropdown" style="display: none;">
        <div class="currency-search-wrapper">
          <i data-lucide="search" class="currency-search-icon"></i>
          <input 
            type="text" 
            class="currency-search-input" 
            id="currencySearchInput"
            placeholder="<%= t('nav.currency.searchPlaceholder') %>"
          >
        </div>
        <div class="currency-list" id="currencyList">
          <!-- Will be populated dynamically -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Navbar JavaScript -->
<% if (user) { %>
<script>
  // Pass user data to client-side for auth state management
  window.__USER_DATA__ = {
    id: '<%= user._id %>',
    firstName: '<%= user.firstName %>',
    lastName: '<%= user.lastName %>',
    email: '<%= user.email %>',
    fullName: '<%= user.firstName %> <%= user.lastName %>',
    companyName: '<%= user.companyName || "" %>',
    avatar: '<%= user.avatar || "" %>',
    preferredCurrency: '<%= user.preferredCurrency || "USD" %>'
  };
</script>
<% } %>
<script src="/js/i18n.js"></script>
<script src="/js/navbar.js"></script>
<script src="/js/currency-converter.js"></script>
<script src="/js/buyer-auth.js"></script>